<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telugu Delicacies - Shop (Updated)</title>
    <!-- Core Assets -->
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png"
        href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" id="dynamic-favicon">

    <!-- Isolated Page Styles -->
    <link rel="stylesheet" href="sales-page.css?v=2.0">
</head>

<body>
    <header class="sales-header">
        <a href="index.html" class="logo-area">
            <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" id="headerLogo"
                alt="Logo" class="logo"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="logo-text-area">
                <span class="brand-name">Telugu Delicacies</span>
                <span class="telugu-brand" id="header-telugu-brand"></span>
            </div>
        </a>
        <nav>
            <button class="nav-btn share-page-btn" onclick="window.shareCurrentPage()" data-tooltip="Share Page">
                <i class="fas fa-arrow-up-from-bracket"></i>
            </button>
            <button class="nav-btn cart-btn" id="cartBtn" onclick="window.toggleCartDrawer()" data-tooltip="View Cart">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">0</span>
            </button>
            <a href="index.html" class="nav-btn home-btn" data-tooltip="Back Home">
                <i class="fas fa-home"></i>
            </a>
        </nav>
    </header>

    <main class="sales-page-container" id="app">
        <!-- Loader -->
        <div style="text-align: center; padding: 100px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--color-primary-blue)"></i>
        </div>
    </main>

    <!-- Cart Drawer -->
    <div id="cartOverlay" class="cart-overlay" onclick="window.toggleCartDrawer()"></div>
    <div id="cartDrawer" class="cart-drawer">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <button class="close-cart-btn" onclick="window.toggleCartDrawer()">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Items will be populated here -->
            <div class="empty-cart-msg">Your cart is empty</div>
        </div>
        <div class="cart-footer">
            <div class="delivery-note">* Delivery charges additional</div>
            <div class="cart-total-row">
                <span>Total:</span>
                <span class="total-amount">₹<span id="cartTotal">0</span></span>
            </div>
            <button class="order-whatsapp-btn" onclick="window.sendToWhatsApp()">
                <i class="fab fa-whatsapp"></i> Order on WhatsApp
            </button>
        </div>
    </div>

    </div>

    <script type="module">
        import { supabase } from './lib/supabase.js';

        // State Management
        const state = {
            allProducts: [],
            categories: [],
            settings: {},
            loading: true,
            currentCategory: null,
            currentProduct: null,
            cart: [],
            detailQty: 1
        };

        // GLOBAL SHARE CURRENT PAGE FUNCTION
        window.shareCurrentPage = function () {
            const currentUrl = window.location.href;
            const pageTitle = document.title || 'Telugu Delicacies';
            const shareMessage = `Check out ${pageTitle} at Telugu Delicacies!\n${currentUrl}`;

            // Mobile: Use native share if available
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && navigator.share) {
                navigator.share({
                    title: pageTitle,
                    text: shareMessage,
                    url: currentUrl
                }).catch(err => console.log('Share cancelled'));
                return;
            }

            // Fallback: Open WhatsApp with URL
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
            window.open(whatsappUrl, '_blank');
        };

        // Initialize App
        async function init() {
            // Expose toggleFlip globally
            window.toggleFlip = function () {
                const el = document.querySelector('.gallery-inner');
                const btn = document.querySelector('.gallery-wrapper > div:last-child .action-btn-pill');
                const disclaimer = document.querySelector('.product-disclaimer-overlay');
                if (el) {
                    el.classList.toggle('flipped');
                    const isFlipped = el.classList.contains('flipped');
                    // Update button text based on state
                    if (btn) {
                        btn.innerHTML = isFlipped
                            ? '<i class="fas fa-image"></i> Back to Image'
                            : '<i class="fas fa-info-circle"></i> View Description';
                    }
                    // Hide/show disclaimer
                    if (disclaimer) {
                        disclaimer.style.opacity = isFlipped ? '0' : '1';
                    }
                }
            };

            // Mobile Swipe Navigation
            window.initSwipeNavigation = function () {
                const gallery = document.querySelector('.product-gallery');
                if (!gallery) return;

                let touchStartX = 0;
                let touchEndX = 0;
                const minSwipeDistance = 50;

                gallery.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                gallery.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });

                function handleSwipe() {
                    // Only navigate if NOT flipped (image is visible)
                    const inner = gallery.querySelector('.gallery-inner');
                    if (inner && inner.classList.contains('flipped')) return;

                    const swipeDistance = touchEndX - touchStartX;

                    if (Math.abs(swipeDistance) < minSwipeDistance) return;

                    // Find navigation links
                    const prevLink = document.querySelector('.nav-btn-pill.prev:not(.disabled)');
                    const nextLink = document.querySelector('.nav-btn-pill.next:not(.disabled)');

                    if (swipeDistance > 0 && prevLink) {
                        // Swiped right -> go to previous product
                        const prevId = prevLink.getAttribute('data-id');
                        navigateToProduct(prevId, 'left');
                    } else if (swipeDistance < 0 && nextLink) {
                        // Swiped left -> go to next product
                        const nextId = nextLink.getAttribute('data-id');
                        navigateToProduct(nextId, 'right');
                    }
                }
            };

            window.navigateToProduct = function (slugOrId, direction = 'fade') {
                const newUrl = `/sales/${slugOrId}`;

                // If it's the same product, do nothing
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts[pathParts.length - 1] === slugOrId) return;

                // Update URL without reload
                history.pushState({ slugOrId, direction }, '', newUrl);

                // Perform view update with animation
                performTransition(slugOrId, direction);
            };

            async function performTransition(slugOrId, direction) {
                const app = document.getElementById('app');
                const oldContent = app.querySelector('.grid-layout');

                if (!oldContent || direction === 'fade') {
                    renderProductView(slugOrId);
                    app.scrollIntoView({ behavior: 'smooth' });
                    return;
                }

                // Create wrapper for transition
                app.style.position = 'relative';
                app.style.overflow = 'hidden';

                // Add exit animation to old content
                oldContent.classList.add('slide-container');
                oldContent.classList.add(direction === 'right' ? 'slide-out-left' : 'slide-out-right');

                // Wait for animation or just render new
                setTimeout(() => {
                    renderProductView(slugOrId, direction);
                    app.scrollIntoView({ behavior: 'smooth' });
                }, 150); // Small delay to start the exit
            }

            window.addEventListener('popstate', (e) => {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const lastPart = pathParts[pathParts.length - 1];

                if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'sales' && lastPart !== 'sales.html') {
                    renderProductView(lastPart, e.state?.direction || 'fade');
                } else if (window.location.pathname.endsWith('sales.html') || pathParts[pathParts.length - 1] === 'sales') {
                    renderCategoryView();
                }
            });

            try {
                const [settingsRes, productsRes, categoriesRes] = await Promise.all([
                    supabase.from('site_settings').select('*').single(),
                    supabase.from('products').select('*'),
                    supabase.from('categories').select('*').order('display_order', { ascending: true })
                ]);

                state.settings = settingsRes.data || {};
                // Filter out hidden products
                state.allProducts = (productsRes.data || []).filter(p => p.is_visible !== false);
                // Filter out hidden categories
                state.categories = (categoriesRes.data || []).filter(c => c.is_visible !== false);
                state.placeholder = state.settings.product_placeholder_url || './images/placeholder-product.jpg';

                // Sync Logo & Favicon
                if (state.settings.logo_url) {
                    const logoImg = document.getElementById('headerLogo');
                    logoImg.src = state.settings.logo_url;

                    // Also set favicon if available, otherwise use logo
                    const faviconLink = document.getElementById('dynamic-favicon');
                    faviconLink.href = state.settings.favicon_url || state.settings.logo_url;
                }

                // Populate Telugu Brand Name in Header
                if (state.settings.site_title_telugu) {
                    const teluguBrand = document.getElementById('header-telugu-brand');
                    if (teluguBrand) {
                        teluguBrand.textContent = state.settings.site_title_telugu;
                    }
                }

                handleRouting();
            } catch (err) {
                console.error("Initialization Failed:", err);
                document.getElementById('app').innerHTML = "<h2>Something went wrong. Please try again later.</h2>";
            }
        }

        function handleRouting() {
            // Support clean URLs: /sales/product-slug
            const pathParts = window.location.pathname.split('/').filter(Boolean);
            const lastPart = pathParts[pathParts.length - 1];

            // Check if we're on a product page (path has slug after /sales/)
            if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'sales' && lastPart !== 'sales.html') {
                // Clean URL: /sales/product-slug
                renderProductView(lastPart);
                return;
            }

            // Fallback: Support legacy query params for backwards compatibility
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            const catSlug = params.get('category');

            if (productId) {
                renderProductView(productId);
            } else {
                renderCategoryView(catSlug);
            }
        }

        // --- View: Category ---
        function renderCategoryView(slug) {
            const app = document.getElementById('app');

            // 1. Single Category Grid View
            if (slug) {
                renderSingleCategoryGrid(slug);
                return;
            }

            // 2. All Categories List (Master Cards)
            const cardsHtml = state.categories.map(cat => {
                const catProducts = state.allProducts.filter(p =>
                    (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === cat.slug
                );

                return `
                    <article class="master-card" id="card-${cat.slug}">
                        <div class="card-hero-image">
                            <img src="${cat.image_url || state.placeholder}" alt="${cat.title}" onerror="this.src='${state.placeholder}'">
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">${cat.title}</h3>
                            ${cat.sub_brand ? `<p class="category-sub-brand" style="font-weight:600; color:var(--text-secondary);">${cat.sub_brand}</p>` : ''}
                            <p class="telugu-subtitle" style="font-family:var(--font-telugu); color:var(--text-muted);">${cat.telugu_title || ''}</p>
                            <p class="card-desc">${cat.description || ''}</p>
                            
                            <div class="dropdown-wrapper">
                                <select class="product-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-medium);" onchange="if(this.value) navigateToProduct(this.value, 'fade')">
                                    <option value="" disabled selected>Select Product</option>
                                    ${catProducts.map(p => `
                                        <option value="${p.slug || p.id}">${p.product_name} ${p.product_name_telugu ? '(' + p.product_name_telugu + ')' : ''}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            app.innerHTML = `
                <div class="breadcrumb-section">
                    <a href="/" style="color:var(--text-secondary)">Home</a> / 
                    <span style="color:var(--color-primary-blue); font-weight:600;">All Collections</span>
                </div>
                <section class="category-view-container">
                    <div class="master-cards-grid">
                        ${cardsHtml}
                    </div>
                </section>
            `;
        }

        function renderSingleCategoryGrid(slug) {
            const app = document.getElementById('app');
            const category = state.categories.find(c => c.slug === slug);

            if (!category) {
                app.innerHTML = '<h2 class="text-center">Category Not Found</h2>';
                return;
            }

            const catProducts = state.allProducts.filter(p =>
                (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === slug
            );

            // Use the New CSS Classes
            app.innerHTML = `
                <div class="breadcrumb-section">
                    <a href="/" style="color:var(--text-secondary)">Home</a> / 
                    <a href="/sales.html" style="color:var(--text-secondary)">Collections</a> /
                    <span style="color:var(--color-primary-blue); font-weight:600;">${category.title}</span>
                </div>

                <section class="category-grid-container yellow-theme-full" style="max-width:1300px; margin:0 auto; padding-bottom:50px;">
                    <!-- Simple Header (No Card) -->
                    <div class="category-header-simple">
                        <div>
                            <h1>${category.title}</h1>
                            <p>${category.telugu_title || ''}</p>
                        </div>
                        ${category.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}">` : ''}
                    </div>

                    <!-- New Product Grid Class -->
                    <div class="sales-product-grid">
                        ${catProducts.map(p => {
                // Logic to find valid price
                let price = p.price;
                let mrp = p.mrp;

                // If no base price, check variants
                if (!price && p.quantity_variants) {
                    try {
                        const variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : p.quantity_variants;
                        if (variants && variants.length > 0) {
                            price = variants[0].price;
                            mrp = variants[0].mrp;
                        }
                    } catch (e) { }
                }

                return `
                            <div class="sales-product-card" onclick="navigateToProduct('${p.slug || p.id}', 'fade')">
                                <div class="sp-img-wrapper">
                                    <img src="${p.showcase_image || state.placeholder}" alt="${p.product_name}" onerror="this.src='${state.placeholder}'">
                                </div>
                                <div class="sp-info">
                                    ${category.sub_brand ? `<span class="sp-sub">${category.sub_brand}</span>` : ''}
                                    <h3 class="sp-title">${p.product_name}</h3>
                                    ${p.product_name_telugu ? `<span class="sp-telugu">${p.product_name_telugu}</span>` : ''}
                                    <div class="sp-price-row">
                                        <span class="sp-price">₹${price !== undefined && price !== null ? price : 'N/A'}</span>
                                        ${mrp > price ? `<span class="sp-mrp">₹${mrp}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </section>
            `;
        }

        // --- View: Product ---
        async function renderProductView(slugOrId, direction = 'fade') {
            // Find product by slug first, then by ID (backwards compatibility)
            let product = state.allProducts.find(p => p.slug === slugOrId);
            if (!product) {
                product = state.allProducts.find(p => p.id == slugOrId);
            }
            if (!product) {
                document.getElementById('app').innerHTML = "<h2>Product Not Found</h2>";
                return;
            }

            // Set global current product for cart actions
            state.currentProduct = product;
            state.detailQty = 1;

            // Category & Context
            const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
            const category = state.categories.find(c => c.slug === catSlug);

            // Navigation
            const siblingProducts = state.allProducts.filter(p => (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === catSlug);
            const idx = siblingProducts.findIndex(p => p.id === product.id);
            const prev = idx > 0 ? siblingProducts[idx - 1] : null;
            const next = idx < siblingProducts.length - 1 ? siblingProducts[idx + 1] : null;

            updateHistory(product);

            const app = document.getElementById('app');

            // Clean up previous transition classes if any
            app.style.position = '';
            app.style.overflow = '';

            const animationClass = direction === 'right' ? 'slide-in-right' : (direction === 'left' ? 'slide-in-left' : 'fade-in');

            app.innerHTML = `
                <div class="grid-layout slide-container ${animationClass}">
                    <!-- Breadcrumbs -->
                    <div class="breadcrumb-section">
                        <!-- Breadcrumbs (Left) -->
                        <div class="crumbs">
                            <a href="/">Home</a> <span>/</span> 
                            <a href="/sales.html?category=${catSlug}">${category?.title || 'Back'}</a> <span>/</span> 
                            <span class="current">${product.product_name}</span>
                        </div>
                        
                        <!-- Navigation (Right on Desktop, Hidden on Mobile) -->
                        <div class="nav-group desktop-only-nav">
                            ${prev ? `<a href="/sales/${prev.slug || prev.id}" class="nav-btn-pill prev" data-id="${prev.slug || prev.id}" title="${prev.product_name}" onclick="event.preventDefault(); navigateToProduct('${prev.slug || prev.id}', 'left')"><i class="fas fa-arrow-left"></i> <span>Prev</span></a>` : '<span class="nav-btn-pill disabled"><i class="fas fa-arrow-left"></i> <span>Prev</span></span>'}
                            ${next ? `<a href="/sales/${next.slug || next.id}" class="nav-btn-pill next" data-id="${next.slug || next.id}" title="${next.product_name}" onclick="event.preventDefault(); navigateToProduct('${next.slug || next.id}', 'right')"><span>Next</span> <i class="fas fa-arrow-right"></i></a>` : '<span class="nav-btn-pill disabled"><span>Next</span> <i class="fas fa-arrow-right"></i></span>'}
                        </div>
                    </div>

                    <!-- Main Content -->
                    <article class="main-product-area">
                        <!-- Navigation (Mobile Only - Top) -->
                        <div class="nav-group mobile-only-nav" style="width: 100%; justify-content: space-between; padding: 0 15px; margin-top: 0;">
                            ${prev ? `<a href="/sales/${prev.slug || prev.id}" class="nav-btn-pill prev" data-id="${prev.slug || prev.id}" title="${prev.product_name}" style="flex:1; justify-content:center;" onclick="event.preventDefault(); navigateToProduct('${prev.slug || prev.id}', 'left')"><i class="fas fa-arrow-left"></i> <span>Prev</span></a>` : '<span class="nav-btn-pill disabled" style="flex:1; justify-content:center;"><i class="fas fa-arrow-left"></i> <span>Prev</span></span>'}
                            ${next ? `<a href="/sales/${next.slug || next.id}" class="nav-btn-pill next" data-id="${next.slug || next.id}" title="${next.product_name}" style="flex:1; justify-content:center;" onclick="event.preventDefault(); navigateToProduct('${next.slug || next.id}', 'right')"><span>Next</span> <i class="fas fa-arrow-right"></i></a>` : '<span class="nav-btn-pill disabled" style="flex:1; justify-content:center;"><span>Next</span> <i class="fas fa-arrow-right"></i></span>'}
                        </div>

                        <div class="gallery-wrapper">
                            <div class="product-gallery" id="productFlipper">
                                <div class="gallery-inner">
                                    <!-- Front: Image -->
                                    <div class="gallery-front">
                                        ${category?.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}" class="overlay-logo">` : ''}
                                        <img src="${product.showcase_image || state.placeholder}" class="main-img" alt="${product.product_name}">
                                        <div class="product-disclaimer-overlay">All images are representative, change in colour expected due to variability in ingredients</div>
                                    </div>
                                    <!-- Back: Description -->
                                    <div class="gallery-back">
                                        <h3 style="margin-bottom:15px; color:var(--color-primary-blue);">About Product</h3>
                                        <p>${product.product_description || 'No description available.'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Toggle Button Below Image -->
                            <div style="text-align:center; margin-top:15px;">
                                <button onclick="toggleFlip()" class="action-btn-pill outline">
                                    <i class="fas fa-info-circle"></i> View Description
                                </button>
                            </div>
                        </div>
                        


    <div class="product-details">
        <div class="details-body">
            ${!category?.sub_brand_logo_url && category?.sub_brand ? `<div
                style="text-transform:uppercase; font-size:0.8rem; font-weight:700; color:var(--text-muted);">
                ${category.sub_brand}</div>` : ''}
            <h1 class="product-title">${product.product_name}</h1>
            <div class="telugu-title">${product.product_name_telugu || ''}</div>
            ${product.product_tagline ? `<div class="product-tagline">${product.product_tagline}</div>` : ''}

            <div class="price-row">
                <span class="current-price" id="view-price">₹${product.price}</span>
                <span class="mrp-strike" id="view-mrp"
                    style="${product.mrp > product.price ? '' : 'display:none'}">₹${product.mrp}</span>
                <span class="discount-badge" id="view-discount"
                    style="${product.mrp > product.price ? '' : 'display:none'}"></span>
            </div>

            <div class="selection-area">
                ${renderVariants(product)}
            </div>

            <div class="info-tabs">
                <div class="info-btns-row" id="tabs-buttons">
                    <!-- Buttons injected here -->
                </div>
                <div id="ingredients-content" class="info-content-block"></div>
                <div id="nutrition-content" class="info-content-block"></div>
                <div id="usage-content" class="info-content-block"></div>
            </div>
        </div>

        <div class="add-to-cart-section">
            <div class="qty-control-lg">
                <button class="qty-btn-lg" onclick="updateDetailQty(-1)">−</button>
                <input type="number" class="qty-input-lg" id="detailQty" value="1" min="1" onchange="window.validateDetailQty(this)">
                <button class="qty-btn-lg" onclick="updateDetailQty(1)">+</button>
            </div>
            <button class="add-cart-btn" onclick="addToCartFromDetail()">
                <i class="fas fa-cart-plus"></i> Add to Cart
            </button>
        </div>
    </div>
    </article>

    <!-- Sidebar -->
    <aside class="sidebar">
        <section class="sidebar-card">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="similar">Similar</div>
                <div class="sidebar-tab" data-tab="trending">Trending</div>
            </div>
            <div id="side-content">
                ${renderVerticalItems(getSimilarProducts(product))}
            </div>
        </section>
    </aside>

    <!-- Recent Section -->
    <section class="recent-section">
        <h3 style="margin-bottom:20px;">Recently Viewed</h3>
        <div class="recent-grid">
            ${renderHistoryItems()}
        </div>
    </section>
    </div>
    `;

            initProductInteractions(product);
        }

        // --- Helpers: Components ---
        function renderVariants(p) {
            let variants = [];
            try {
                variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : (p.quantity_variants ||
                    []);
            } catch (e) { }

            if (variants.length <= 1) return `<p style="color:var(--text-secondary)"><strong>Pack Size:</strong>
        ${variants[0]?.quantity || 'Standard'}</p>`;

            return `
        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:0.8rem; margin-bottom:5px; color:var(--text-muted);">SELECT
                SIZE</label>
            <select id="variantSelect"
                style="width:100%; max-width:300px; padding:12px; border-radius:8px; border:1px solid var(--border-medium); background:var(--bg-secondary);">
                ${variants.map((v, i) => `<option value="${i}">${v.quantity} - ₹${v.price}</option>`).join('')}
            </select>
        </div>
        `;
        }

        function initProductInteractions(p) {
            const vSelect = document.getElementById('variantSelect');
            let variants = [];
            try {
                variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) :
                    (p.quantity_variants || []);
            } catch (e) { }

            const updatePrice = (v) => {
                document.getElementById('view-price').innerText = '₹' + v.price;
                const mrpEl = document.getElementById('view-mrp');
                const discEl = document.getElementById('view-discount');
                if (v.mrp && v.mrp > v.price) {
                    mrpEl.innerText = '₹' + v.mrp;
                    mrpEl.style.display = 'inline';
                    const off = Math.round(((v.mrp - v.price) / v.mrp) * 100);
                    discEl.innerText = off + '% OFF';
                    discEl.style.display = 'inline-block';
                } else {
                    mrpEl.style.display = 'none';
                    discEl.style.display = 'none';
                }
            };

            if (vSelect) {
                vSelect.onchange = (e) => updatePrice(variants[e.target.value]);
            }
            if (variants[0]) updatePrice(variants[0]);


            // 2. Toggles & Content
            const btnContainer = document.getElementById('tabs-buttons');
            const sections = [];

            // Helper to parsing weight: "250g" -> 250, "1kg" -> 1000
            const parseWeight = (str) => {
                if (!str) return 0;
                const match = str.toLowerCase().match(/([\d\.]+)\s*([a-z]+)/);
                if (!match) return 0;
                let val = parseFloat(match[1]);
                let unit = match[2];
                if (unit === 'kg') val *= 1000;
                return val;
            };

            // Ingredients
            if (p.ingredients) {
                sections.push({
                    id: 'ing', label: 'Ingredients', icon: 'fas fa-carrot', target: 'ingredients-content', html: `
        <p>${p.ingredients}</p>`
                });
            }

            // Nutrition
            // We need to keep a reference to update it later
            let nutritionData = null;
            if (p.nutrition_info) {
                try { nutritionData = typeof p.nutrition_info === 'string' ? JSON.parse(p.nutrition_info) : p.nutrition_info; }
                catch (e) { }
            }

            const renderNutrition = (nData, currentVariant) => {
                if (!nData) return '';

                // Normalize Keys (Handle legacy/different formats)
                const getVal = (keys) => {
                    if (!Array.isArray(keys)) keys = [keys];
                    for (const k of keys) {
                        if (nData[k] !== undefined && nData[k] !== null && nData[k] !== '') return nData[k];
                    }
                    return null;
                };

                const servingSize = getVal(['serving_size', 'servingSize']);
                const totalServings = getVal(['total_servings', 'totalServings']);

                // Calculate Servings
                let displayedServings = totalServings; // fallback
                if (currentVariant && servingSize) {
                    const packWeight = parseWeight(currentVariant.quantity);
                    const sSize = parseWeight(servingSize);
                    if (packWeight > 0 && sSize > 0) {
                        displayedServings = Math.round(packWeight / sSize); // Integer servings
                    }
                }

                let grid = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">`;

                // 1. Serving Size
                if (servingSize) {
                    grid += `<div style="padding:8px; background:white; border-radius:6px; font-size:0.8rem;"><strong>Serving
                    Size</strong> <br> ${servingSize}</div>`;
                }
                // 2. Total Servings
                if (displayedServings) {
                    grid += `<div style="padding:8px; background:white; border-radius:6px; font-size:0.8rem;"><strong>Total
                    Servings</strong> <br> ~${displayedServings}</div>`;
                }

                // Field Mapping (Order 3-10)
                const fields = [
                    { k: ['calories', 'Calories'], label: 'Calories' },
                    { k: ['protein', 'Protein'], label: 'Protein' },
                    { k: ['total_fat', 'fat', 'Total Fat', 'Fat'], label: 'Total Fat' },
                    { k: ['saturated_fat', 'saturatedFat', 'Saturated Fat'], label: 'Saturated Fat' },
                    { k: ['carbs', 'Carbs'], label: 'Carbs' },
                    { k: ['fiber', 'Fiber'], label: 'Fiber' },
                    { k: ['sugars', 'sugar', 'Sugars'], label: 'Sugar' },
                    { k: ['sodium', 'Sodium'], label: 'Sodium' }
                ];

                fields.forEach(f => {
                    const val = getVal(f.k);
                    if (val !== null) {
                        grid += `<div
                style="padding:8px 10px; background:white; border-radius:6px; display:flex; justify-content:space-between; align-items:center; font-size:0.8rem;">
                <strong>${f.label}</strong> <span>${val}</span>
            </div>`;
                    }
                });

                grid += `</div>`;
                return grid;
            };

            if (nutritionData) {
                sections.push({
                    id: 'nut',
                    label: 'Nutrition',
                    icon: 'fas fa-heartbeat',
                    target: 'nutrition-content',
                    // Initial render with first variant (or default)
                    html: renderNutrition(nutritionData, variants[0])
                });
            }

            // Usage
            if (p.serving_suggestion) {
                sections.push({
                    id: 'use', label: 'Usage', icon: 'fas fa-utensils', target: 'usage-content', html: `<p>
            ${p.serving_suggestion}</p>`
                });
            }

            // Render Buttons & Inject Content
            if (btnContainer) {
                btnContainer.innerHTML = sections.map(s =>
                    `<button class="info-btn" id="btn-${s.id}" data-target="${s.target}"><i class="${s.icon}"></i>
            ${s.label}</button>`
                ).join('');

                sections.forEach(s => {
                    document.getElementById(s.target).innerHTML = s.html;
                });

                // Add Toggle Logic
                // Add Toggle Logic
                btnContainer.onclick = (e) => {
                    const btn = e.target.closest('.info-btn');
                    if (!btn) return;

                    const targetId = btn.dataset.target;
                    const contentDiv = document.getElementById(targetId);

                    // Check state before clearing
                    const wasActive = btn.classList.contains('active');

                    // Close ALL
                    document.querySelectorAll('.info-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.info-content-block').forEach(d => d.classList.remove('active'));

                    // If it wasn't active, open it (If it was active, we just closed it above)
                    if (!wasActive) {
                        btn.classList.add('active');
                        contentDiv.classList.add('active');
                    }
                };
            }

            // Hook Nutrition Update into Variant Selection
            if (vSelect && nutritionData) {
                const originalChange = vSelect.onchange;
                vSelect.onchange = (e) => {
                    // Call original price updater
                    if (originalChange) originalChange(e);

                    // Update Nutrition HTML
                    const selectedVar = variants[e.target.value];
                    const nutContent = document.getElementById('nutrition-content');
                    if (nutContent) {
                        nutContent.innerHTML = renderNutrition(nutritionData, selectedVar);
                    }
                };
            }

            // Sidebar Tabs
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const mode = tab.dataset.tab;
                    document.getElementById('side-content').innerHTML = renderVerticalItems(mode === 'similar' ?
                        getSimilarProducts(p) : state.allProducts.filter(x => x.is_trending));
                };
            });

            // Initialize swipe navigation for mobile
            if (window.initSwipeNavigation) {
                window.initSwipeNavigation();
            }
        }

        // --- Logic: Data Helpers ---
        function getSimilarProducts(target) {
            return state.allProducts
                .filter(p => p.id !== target.id)
                .map(p => {
                    const isSameCat = p.product_category === target.product_category;
                    return { ...p, score: isSameCat ? 1 : 0 };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
        }

        function renderVerticalItems(items) {
            if (!items.length) return `<p style="text-align:center; padding:20px; color:var(--text-muted)">No items found.
        </p>`;
            return items.map(item => `
        <div class="sim-item" onclick="window.location.href='/sales/${item.slug || item.id}'">
            <img src="${item.showcase_image || state.placeholder}" class="sim-img"
                onerror="this.src='${state.placeholder}'">
            <div class="sim-info">
                <h4 style="font-size:0.9rem; margin:0;">${item.product_name}</h4>
                <span style="font-size:0.8rem; color:var(--color-primary-blue)">View Product</span>
            </div>
        </div>
        `).join('');
        }

        function updateHistory(p) {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            hist = hist.filter(x => x.slug !== p.slug && x.id !== p.id);
            hist.unshift({ id: p.id, slug: p.slug, name: p.product_name, img: p.showcase_image });
            localStorage.setItem('td_history', JSON.stringify(hist.slice(0, 8)));
        }

        function renderHistoryItems() {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            if (!hist.length) return `<p style="grid-column:1/-1; color:var(--text-muted)">Your viewing history will appear
            here.</p>`;
            return hist.slice(0, 5).map(h => `
        <div class="sim-item" onclick="window.location.href='/sales/${h.slug || h.id}'"
            style="background:var(--bg-primary); border:1px solid var(--border-light); display:flex; align-items:center; gap:10px; padding:5px;">
            <img src="${h.img || state.placeholder}" class="sim-img" style="width:50px; height:50px; object-fit:cover; border-radius:4px; flex-shrink:0;" onerror="this.src='${state.placeholder}'">
            <div class="sim-info" style="min-width:0;">
                <h4 style="font-size:0.85rem; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${h.name}</h4>
                <span style="font-size:0.75rem; color:var(--text-secondary)">View Product</span>
            </div>
        </div>
        `).join('');
        }

        // --- Global Share Function ---
        window.shareCatalogue = async function () {
            const settings = state.settings || {};
            const catalogueUrl = settings.catalogue_image_url;
            const shareMessage = settings.catalogue_share_message || 'Check out our latest catalogue of delicious treats!';

            if (!catalogueUrl) {
                alert('Catalogue is not available at the moment.');
                return;
            }

            try {
                const response = await fetch(catalogueUrl);
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);

                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile && navigator.share) {
                    const file = new File([blob], 'catalogue.jpg', { type: blob.type });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: shareMessage,
                            text: shareMessage,
                            files: [file]
                        });
                        return;
                    }
                }

                // Desktop Download + Paste
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = 'Telugu_Delicacies_Catalogue.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                if (navigator.clipboard && window.ClipboardItem) {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ [blob.type]: blob })
                        ]);
                    } catch (e) { }
                }

                alert('Catalogue downloaded! You can now attach or paste it directly in WhatsApp.');
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
                window.open(whatsappUrl, '_blank');

            } catch (err) {
                console.error('Sharing failed:', err);
                alert('Could not prepare the catalogue for sharing.');
            }
        };

        // --- UI Utilities ---
        window.showToast = function (message, type = 'info') {
            alert(message);
        };

        // --- Cart Functions ---
        window.initCart = function () {
            try {
                const saved = localStorage.getItem('td_cart');
                if (saved) state.cart = JSON.parse(saved);
            } catch (e) { console.error('Cart load error', e); }
            updateCartUI();
        };

        window.saveCart = function () {
            localStorage.setItem('td_cart', JSON.stringify(state.cart));
            updateCartUI();
        };

        window.toggleCartDrawer = function () {
            const drawer = document.getElementById('cartDrawer');
            const overlay = document.getElementById('cartOverlay');
            if (drawer && overlay) {
                drawer.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        };

        window.updateDetailQty = function (delta) {
            const input = document.getElementById('detailQty');
            if (!input) return;
            const currentVal = parseInt(input.value) || 1;
            let newQty = currentVal + delta;

            let maxStock = 999;
            if (state.currentProduct) {
                const variants = state.currentProduct.quantity_variants || [];
                if (variants.length > 0) {
                    const select = document.getElementById('variantSelect');
                    const v = variants[select ? select.value : 0];
                    if (v && v.stock !== undefined) maxStock = v.stock;
                } else if (state.currentProduct.total_stock !== undefined) {
                    maxStock = state.currentProduct.total_stock;
                }
            }

            if (newQty < 1) newQty = 1;
            if (newQty > maxStock) {
                if (maxStock <= 0) {
                    window.showToast('Sorry, this item is Out of Stock', 'error');
                } else {
                    window.showToast(`Max ${maxStock} units available`, 'error');
                }
                newQty = Math.max(1, maxStock);
            }

            state.detailQty = newQty;
            input.value = state.detailQty;
        };

        window.validateDetailQty = function (input) {
            let val = parseInt(input.value);
            if (isNaN(val) || val < 1) val = 1;

            let maxStock = 999;
            if (state.currentProduct) {
                const variants = state.currentProduct.quantity_variants || [];
                if (variants.length > 0) {
                    const select = document.getElementById('variantSelect');
                    const v = variants[select ? select.value : 0];
                    if (v && v.stock !== undefined) maxStock = v.stock;
                } else if (state.currentProduct.total_stock !== undefined) {
                    maxStock = state.currentProduct.total_stock;
                }
            }

            if (val > maxStock) {
                if (maxStock <= 0) {
                    window.showToast('Out of Stock', 'error');
                    val = 1;
                } else {
                    window.showToast(`Max ${maxStock} units available`, 'error');
                    val = maxStock;
                }
            }
            state.detailQty = val;
            input.value = val;
        };

        // Helper for cart animation
        function animateCartBtn() {
            const btn = document.getElementById('cartBtn');
            if (btn) {
                btn.classList.add('cart-pop');
                setTimeout(() => btn.classList.remove('cart-pop'), 400);
            }
        }

        window.addToCart = function (product, variant, qty) {
            // Hardened Validation: Check existing cart qty + new qty against stock
            const existingIdx = state.cart.findIndex(item =>
                item.id === product.id &&
                JSON.stringify(item.variant) === JSON.stringify(variant)
            );

            const currentCartQty = existingIdx > -1 ? state.cart[existingIdx].qty : 0;
            const maxStock = variant ? (variant.stock || 0) : (product.total_stock || 0);

            if (qty < 1) {
                window.showToast('Quantity must be at least 1', 'error');
                return;
            }

            if (currentCartQty + qty > maxStock) {
                if (maxStock <= 0) {
                    window.showToast('Out of Stock', 'error');
                } else {
                    window.showToast(`Cannot add more. Max stock is ${maxStock}. (You have ${currentCartQty} in cart)`, 'error');
                }
                return;
            }

            if (existingIdx > -1) {
                state.cart[existingIdx].qty += qty;
            } else {
                state.cart.push({
                    id: product.id,
                    name: product.product_name,
                    telugu_name: product.product_name_telugu,
                    price: variant ? variant.price : product.mrp,
                    image: product.showcase_image,
                    variant: variant,
                    qty: qty
                });
            }

            state.cart = [...state.cart];
            window.saveCart();
            animateCartBtn();
            window.showToast(`${product.product_name} added to cart!`, 'success');
        };

        window.addToCartFromDetail = function () {
            if (!state.currentProduct) return;

            let variants = [];
            try {
                variants = typeof state.currentProduct.quantity_variants === 'string' ?
                    JSON.parse(state.currentProduct.quantity_variants) :
                    (state.currentProduct.quantity_variants || []);
            } catch (e) { }

            let selectedVariant = null;
            if (variants.length > 0) {
                const select = document.getElementById('variantSelect');
                if (select) {
                    selectedVariant = variants[select.value];
                } else {
                    selectedVariant = variants[0];
                }
            }

            const qtyInput = document.getElementById('detailQty');
            const qty = parseInt(qtyInput ? qtyInput.value : 1) || 1;

            window.addToCart(state.currentProduct, selectedVariant, qty);
        };

        window.updateCartItemQty = function (index, deltaOrVal, isDirect = false) {
            const item = state.cart[index];
            if (!item) return;
            let newQty;

            if (isDirect) {
                newQty = parseInt(deltaOrVal);
                if (isNaN(newQty) || newQty < 1) newQty = 1;
            } else {
                newQty = item.qty + deltaOrVal;
            }

            // Check stock
            const maxStock = item.variant ? (item.variant.stock || 0) : 999;

            if (newQty <= 0) {
                if (confirm('Remove item from cart?')) {
                    state.cart.splice(index, 1);
                    window.saveCart();
                }
            } else if (newQty > maxStock) {
                window.showToast(`Max stock reached (${maxStock})`, 'error');
                item.qty = maxStock;
                window.saveCart();
            } else {
                item.qty = newQty;
                window.saveCart();
            }
        };

        window.removeItem = function (index) {
            if (confirm('Remove item from cart?')) {
                state.cart.splice(index, 1);
                window.saveCart();
            }
        };

        function updateCartUI() {
            const container = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');
            const countEl = document.getElementById('cartCount');

            // Update Badge
            const totalItems = state.cart.reduce((sum, item) => sum + item.qty, 0);
            countEl.innerText = totalItems;
            countEl.style.display = totalItems > 0 ? 'flex' : 'none';

            // Calculate Total
            const totalCost = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            totalEl.innerText = totalCost;

            if (state.cart.length === 0) {
                container.innerHTML = '<div class="empty-cart-msg">Your cart is empty <br> <i class="fas fa-shopping-basket" style="font-size:2rem; margin-top:1rem; opacity:0.5;"></i></div>';
                return;
            }

            container.innerHTML = state.cart.map((item, index) => `
                <div class="cart-item">
                    <img src="${item.image || state.placeholder}" class="cart-item-img" onerror="this.src='${state.placeholder}'">
                    <div class="cart-item-details">
                        <div class="cart-item-title">${item.name}</div>
                        ${item.variant ? `<div class="cart-item-variant">${item.variant.quantity}</div>` : ''}
                        
                        <div class="cart-item-controls">
                            <div class="qty-control-sm">
                                <button class="qty-btn-sm" onclick="window.updateCartItemQty(${index}, -1)">−</button>
                                <input type="number" class="cart-qty-input" value="${item.qty}" min="1" 
                                    onchange="window.updateCartItemQty(${index}, this.value, true)"
                                    style="width: 40px; text-align: center; border: 1px solid var(--color-gray-200); border-radius: 4px; font-size: 0.8rem; height: 24px; margin: 0 5px;">
                                <button class="qty-btn-sm" onclick="window.updateCartItemQty(${index}, 1)">+</button>
                            </div>
                            <div class="cart-item-price">₹${item.price * item.qty}</div>
                        </div>
                    </div>
                    <button class="close-cart-btn" style="font-size:1.2rem; margin-left:5px; align-self:flex-start;" onclick="window.removeItem(${index})">&times;</button>
                </div>
            `).join('');
        }

        window.sendToWhatsApp = function () {
            if (state.cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            // --- Background Stock Update ---
            const updateStock = async () => {
                for (const item of state.cart) {
                    try {
                        const { error } = await supabase.rpc('process_order_stock', {
                            p_product_id: item.id,
                            p_variant_label: item.variant ? item.variant.quantity : '',
                            p_qty: item.qty
                        });
                        if (error) throw error;
                    } catch (e) {
                        console.error('Stock update failed for item:', item.id, e);
                    }
                }
            };

            // Initiate stock update in background
            updateStock();

            let message = `🛒 *New Order from Telugu Delicacies*\n\n*Order Details:*`;
            let total = 0;
            state.cart.forEach(item => {
                const sub = item.price * item.qty;
                total += sub;
                message += `\n• ${item.name} ${item.variant ? '(' + item.variant.quantity + ')' : ''} × ${item.qty} = ₹${sub}`;
            });

            message += `\n\n*Subtotal: ₹${total}*`;
            message += `\n_* Delivery charges additional_`;
            message += `\n\nPlease confirm availability and share payment details.`;

            const phone = '919618519191';
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

            // Open in new tab but also clear cart
            window.open(whatsappUrl, '_blank');

            // --- Cart Reset Logic ---
            state.cart = [];
            window.saveCart();
            window.showToast('Order initiated! Cart cleared.', 'success');
        };

        window.initCart();

        init();
    </script>
</body>

</html>