<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telugu Delicacies - Sales</title>
    <!-- Reuse Main Styles -->
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">

    <style>
        /* Override/Extended Styles specific to Sales Page but using Variables */
        body {
            background-color: var(--bg-secondary);
        }

        /* Scoped Header for Sales Page if different, otherwise similar to main */
        .sales-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .sales-page-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            margin: 0 auto;
            padding: 10px;
        }

        /* --- Layout: Product View --- */
        .grid-layout {
            display: grid;
            grid-template-areas:
                "breadcrumb breadcrumb"
                "main sidebar"
                "recent recent";
            grid-template-columns: 1fr 280px;
            gap: 15px;
        }

        @media (max-width: 900px) {
            .grid-layout {
                grid-template-areas: "breadcrumb" "main" "sidebar" "recent";
                grid-template-columns: 1fr;
            }
        }

        /* Breadcrumb */
        .breadcrumb-section {
            grid-area: breadcrumb;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .breadcrumb-link {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .breadcrumb-link:hover {
            color: var(--color-primary-blue);
            text-decoration: underline;
        }

        .breadcrumb-current {
            color: var(--color-primary-blue);
            font-weight: 600;
            margin-left: 5px;
        }

        /* Main Area */
        .main-product-area {
            grid-area: main;
            display: grid;
            grid-template-columns: 40% 1fr;
            gap: 25px;
            background: var(--bg-primary);
            padding: 15px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 700px) {
            .main-product-area {
                grid-template-columns: 1fr;
            }
        }

        .product-gallery img {
            width: 100%;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }



        .product-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        @media (max-width: 480px) {
            .product-title {
                font-size: 1.5rem;
            }
        }

        .telugu-title {
            color: var(--text-muted);
            font-family: var(--font-telugu);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .price-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Left Align */
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .current-price {
            color: var(--color-primary-blue);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .mrp-strike {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .desc-box {
            margin: 0.8rem 0;
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.95rem;
        }

        /* Buttons/Tabs */
        .info-btns-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .info-btn {
            background: transparent;
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-primary);
        }

        .info-btn:hover {
            background: var(--bg-secondary);
            color: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
        }

        .info-btn.active {
            background: var(--color-primary-blue);
            color: white;
            border-color: var(--color-primary-blue);
        }

        .info-content-panel {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .buy-action-box {
            margin-top: 20px;
        }

        .buy-btn {
            background: var(--color-success);
            color: white;
            border: none;
            width: 100%;
            padding: 10px;
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
        }

        .buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: #0ea874;
        }

        /* Nav Buttons */
        .nav-products-row {
            display: flex;
            gap: 10px;
        }

        .nav-arrow-btn {
            background: white;
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-weight: 500;
            text-decoration: none;
        }

        .nav-arrow-btn:hover {
            border-color: var(--color-primary-blue);
            color: var(--color-primary-blue);
            background: var(--bg-secondary);
        }

        .nav-arrow-btn i {
            font-size: 0.8rem;
        }

        /* Sidebar & Recent */
        .sidebar {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: var(--radius-lg);
            height: fit-content;
            border: 1px solid var(--border-light);
        }

        @media (max-width: 900px) {
            .sidebar {
                margin-top: 20px;
            }
        }

        .sidebar h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .similar-items-grid {
            max-height: 480px;
            /* Approx 5 items (80-90px each) */
            overflow-y: auto;
            padding-right: 5px;
            /* Avoid scroll covering content */
        }

        /* Custom Scrollbar for sidebar */
        .similar-items-grid::-webkit-scrollbar {
            width: 6px;
        }

        .similar-items-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .similar-items-grid::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }

        .similar-items-grid::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-blue);
        }

        /* Sidebar Tabs */
        .sidebar-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-light);
            margin-bottom: 15px;
        }

        .sidebar-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .sidebar-tab:hover {
            color: var(--color-primary-blue);
        }

        .sidebar-tab.active {
            color: var(--color-primary-blue);
            border-bottom-color: var(--color-primary-blue);
        }

        .sidebar-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .sidebar-content.active {
            display: block;
        }

        .sim-item {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .sim-item:hover {
            background: var(--bg-secondary);
            border-color: var(--border-light);
        }

        .sim-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border-light);
        }

        .sim-info {
            flex: 1;
        }

        .sim-info h4 {
            font-size: 0.9rem;
            margin: 0 0 4px;
            color: var(--text-primary);
            font-weight: 500;
            line-height: 1.3;
        }

        .sim-price {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-primary-blue);
        }

        .recent-section {
            grid-area: recent;
            background: var(--bg-primary);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .recent-grid {
            display: flex;
            /* Horizontal Row */
            overflow-x: auto;
            /* Scroll horizontally */
            gap: 15px;
            padding: 10px 0 15px 0;
            /* extra bottom padding for scrollbar */
        }

        /* Custom Horizontal Scrollbar */
        .recent-grid::-webkit-scrollbar {
            height: 6px;
        }

        .recent-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .recent-grid::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }

        .recent-grid::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-blue);
        }

        .recent-grid .sim-item {
            min-width: 260px;
            /* Prevent squishing */
            flex: 0 0 auto;
            /* Don't grow/shrink */
        }

        .recent-card {
            text-align: left;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .recent-card:hover {
            transform: translateY(-3px);
        }

        .recent-card img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
        }

        .recent-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
            height: 2.8em;
            overflow: hidden;
            line-height: 1.4;
        }

        /* --- Category View --- */
        .category-view-container {
            display: block;
            padding: 20px 0;
            min-height: 70vh;
        }

        .master-cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobile First: 1 column */
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .master-cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                /* Desktop/Tablet: Reduced Size */
                gap: 20px;
                width: 100%;
            }
        }

        .master-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* Removed max-width restriction for wider cards */
            width: 100%;
            margin: 0 auto;
            /* Center in grid cell */
            transition: transform 0.2s;
        }

        .master-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Card Faces Context */
        .card-face {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-hero-image {
            height: 220px;
            width: 100%;
            background: #f8fafc;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .card-hero-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            padding: 24px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .dropdown-wrapper {
            margin-top: auto;
            position: relative;
        }

        .product-select {
            width: 100%;
            padding: 10px 35px 10px 10px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            background: #f8fafc url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") no-repeat right 10px center;
            background-size: 10px;
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        .dropdown-icon {
            display: none;
        }

        .nut-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        @media (max-width: 400px) {
            .nut-grid {
                grid-template-columns: 1fr;
            }
        }

        .nut-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            border-bottom: 1px dashed var(--border-light);
            padding: 4px 0;
        }
    </style>
</head>

<body>

    <header class="sales-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <!-- Consistent Logo logic from Main Site -->
            <!-- Consistent Logo logic from Main Site -->
            <img src="/favicon.png" id="headerLogo" alt="Telugu Delicacies Logo" class="logo"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="logo-fallback"
                style="display: none; background:var(--bg-gradient-primary); color:white; width:40px; height:40px; border-radius:8px; align-items:center; justify-content:center; font-weight:bold;">
                TD</div>
            <span class="brand-name">Telugu Delicacies</span>
            <!-- Add script to mimic main site loader if needed, but onerror handles it -->
        </div>
        <a href="/" class="nav-btn">Home</a>
    </header>

    <div class="sales-page-container" id="appContainer">
        <!-- JS will render either Category View or Product View here -->
        <div style="text-align: center; padding: 100px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--color-primary-blue)"></i>
        </div>
    </div>

    <script type="module">
        import { supabase } from './lib/supabase.js';

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const categorySlug = urlParams.get('category');

        // Globals
        let ALL_PRODUCTS = [];
        let SITE_SETTINGS = {};

        async function init() {
            // Fetch Global Data
            const [settingsRes, productsRes] = await Promise.all([
                supabase.from('site_settings').select('*').single(),
                supabase.from('products').select('*')
            ]);

            SITE_SETTINGS = settingsRes.data || {};
            ALL_PRODUCTS = productsRes.data || [];
            window.globalPlaceholder = SITE_SETTINGS.product_placeholder_url || './images/placeholder-product.jpg';

            // Dynamic Logo
            const logoImg = document.getElementById('headerLogo');
            if (logoImg && SITE_SETTINGS.logo_url) {
                logoImg.src = SITE_SETTINGS.logo_url;
            }

            if (productId) {
                renderProductView(productId);
            } else if (categorySlug) {
                renderCategoryView(categorySlug);
            } else {
                // Default to All Categories if no params
                renderCategoryView(null);
            }
        }

        // --- Category View ---
        async function renderCategoryView(targetSlug) {
            // Fetch ALL categories
            const { data: categories } = await supabase.from('categories').select('*').order('display_order', { ascending: true });

            if (!categories || categories.length === 0) {
                document.getElementById('appContainer').innerHTML = '<h2>No categories found</h2>';
                return;
            }

            const getCatProducts = (slug) => ALL_PRODUCTS.filter(p => (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === slug);

            const gridHtml = categories.map(cat => {
                const catProducts = getCatProducts(cat.slug);
                return `
                    <div class="master-card" id="card-${cat.slug}">
                        <div class="card-face">
                            <div class="card-hero-image">
                                <img src="${cat.image_url || './images/category_placeholder.jpg'}" alt="${cat.title}" onerror="this.src='./images/placeholder-product-portrait.jpg'">
                            </div>
                            <div class="card-body">
                                <h3 class="card-title">${cat.title}</h3>
                                ${cat.sub_brand ? `<p class="category-sub-brand">${cat.sub_brand}</p>` : ''}
                                <p class="telugu-subtitle">${cat.telugu_title || ''}</p>
                                <p class="card-desc">${cat.description || ''}</p>
                                <div class="dropdown-wrapper">
                                    <select class="product-select" onchange="if(this.value) window.location.href='sales.html?id='+this.value">
                                        <option value="" disabled selected>Select Product</option>
                                        ${catProducts.map(p => `
                                            <option value="${p.id}">${p.product_name} ${p.product_name_telugu ? '(' + p.product_name_telugu + ')' : ''}</option>
                                        `).join('')}
                                    </select>
                                    <i class="fas fa-chevron-down dropdown-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                 `;
            }).join('');

            const html = `
                <div class="breadcrumb-section" style="margin-bottom: 20px;">
                    <a href="/" class="breadcrumb-link">Home</a>
                    <span style="margin:0 5px;">/</span>
                    <span class="breadcrumb-current">All Categories</span>
                </div>
                
                <div class="category-view-container">
                    <div class="master-cards-grid">
                        ${gridHtml}
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;

            // Scroll to target if exists
            if (targetSlug) {
                setTimeout(() => {
                    const el = document.getElementById(`card-${targetSlug}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }


        // --- Product View ---
        async function renderProductView(id) {
            const product = ALL_PRODUCTS.find(p => p.id == id); // Loose match mainly

            if (!product) {
                document.getElementById('appContainer').innerHTML = '<h2>Product not found</h2>';
                return;
            }

            // Get Category for Breadcrumb & Nav
            const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
            const { data: cat } = await supabase.from('categories').select('*').eq('slug', catSlug).single();
            const catTitle = cat ? cat.title : product.product_category;
            const subBrand = cat ? cat.sub_brand : '';
            const subBrandLogo = cat ? cat.sub_brand_logo_url : '';

            // Nav Logic
            const catProducts = ALL_PRODUCTS.filter(p => {
                const pCat = (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
                return pCat === catSlug;
            });
            const currentIndex = catProducts.findIndex(p => p.id === product.id);
            const prevProd = currentIndex > 0 ? catProducts[currentIndex - 1] : null;
            const nextProd = currentIndex < catProducts.length - 1 ? catProducts[currentIndex + 1] : null;

            updateRecentHistory(product);

            // Render Layout
            const container = document.getElementById('appContainer');
            container.innerHTML = `
                <div class="grid-layout">
                    <!-- Breadcrumb + Nav -->
                    <div class="breadcrumb-section" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <a href="/" class="breadcrumb-link">Home</a>
                            <span style="margin:0 5px;">/</span>
                            <a href="sales.html?category=${catSlug}" class="breadcrumb-link">${catTitle}</a>
                            <span style="margin:0 5px;">/</span>
                            <span class="breadcrumb-current">${product.product_name}</span>
                        </div>
                        <div class="nav-products-row" style="margin:0;">
                            ${prevProd ? `<button onclick="window.location.href='sales.html?id=${prevProd.id}'" class="nav-arrow-btn"><i class="fas fa-chevron-left"></i> Prev</button>` : '<span></span>'}
                            ${nextProd ? `<button onclick="window.location.href='sales.html?id=${nextProd.id}'" class="nav-arrow-btn" style="margin-left:10px;">Next <i class="fas fa-chevron-right"></i></button>` : ''}
                        </div>
                    </div>

                    <!-- Main -->
                    <div class="main-product-area" id="mainContent">
                         ${renderMainContentHTML(product, subBrand, subBrandLogo)}
                    </div>

                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div class="sidebar-tabs">
                             <div class="sidebar-tab active" id="tab-btn-similar" onclick="switchSidebarTab('similar')">Similar</div>
                             <div class="sidebar-tab" id="tab-btn-trending" onclick="switchSidebarTab('trending')">Trending</div>
                        </div>

                        <div id="tab-similar" class="sidebar-content active">
                            <h3>Similar Items</h3>
                            <div class="similar-items-grid">
                                ${renderSimilarHTML(product, ALL_PRODUCTS)}
                            </div>
                        </div>

                        <div id="tab-trending" class="sidebar-content">
                             <h3>Trending Now</h3>
                             <div class="similar-items-grid">
                                 ${renderTrendingHTML(ALL_PRODUCTS)}
                             </div>
                        </div>
                    </div>

                    <!-- Recent -->
                    <div class="recent-section">
                        <h3 style="font-size:1.2rem; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid var(--border-light);">Recently Viewed</h3>
                        <div class="recent-grid">
                             ${renderRecentHTML(product)}
                        </div>
                    </div>
                </div>
            `;

            // Re-bind Toggle function manually or generic script
            // Activate the first info tab if any exist
            const firstInfoBtn = document.querySelector('.info-btns-row .info-btn');
            if (firstInfoBtn) {
                firstInfoBtn.click();
            }
        }

        // Initialize Variant Update Function globally
        window.updateVariantSelection = function (selectInfo) {
            // Encode/Decode or just store data in DOM? 
            // Better: store variants in a global map or use data-attributes if simple. 
            // Easiest: Pass the variant object? No, can't pass obj in HTML string.
            // Let's us the index.

            // Parse Weight Helper
            const parseWeight = (str) => {
                if (!str) return 0;
                str = str.toLowerCase().trim();
                const num = parseFloat(str.replace(/[^0-9.]/g, ''));
                if (isNaN(num)) return 0;
                if (str.includes('kg')) return num * 1000;
                if (str.includes('mg')) return num / 1000; // unlikely for pack size
                if (str.includes('lb')) return num * 453.59;
                return num; // assume grams
            };

            const selectStub = document.getElementById('variantSelect');
            if (!selectStub) return;
            const idx = selectStub.selectedIndex;
            // We need the variants data. Let's attach it to the select element for easy access.
            // But we can't easily attach prop to string.
            // Alternative: The data is in ALL_PRODUCTS. We know the current product ID.

            // Let's refactor: The onchange will pass the product ID and Main Variant Index
            const selectedIdx = selectStub.value;
            const productId = selectStub.getAttribute('data-product-id');
            const product = ALL_PRODUCTS.find(p => p.id == productId);
            if (!product) return;

            let variants = [];
            try { variants = typeof product.quantity_variants === 'string' ? JSON.parse(product.quantity_variants) : (product.quantity_variants || []); } catch (e) { }

            if (variants[selectedIdx]) {
                const v = variants[selectedIdx];
                updatePriceUI(v.price, v.mrp);

                // Update Servings Calculation
                const servSizeStr = window.CURRENT_PRODUCT_SERVING_SIZE;
                if (servSizeStr) {
                    const packWeight = parseWeight(v.quantity);
                    const servWeight = parseWeight(servSizeStr);
                    if (packWeight > 0 && servWeight > 0) {
                        const servingsObj = document.getElementById('dynamic-servings-count');
                        const servings = Math.round(packWeight / servWeight);
                        if (servingsObj) {
                            servingsObj.innerHTML = `<span>Servings: <strong>${servings} (approx)</strong></span>`;
                        }
                    }
                }
            }
        }

        // Helper to update UI
        function updatePriceUI(price, mrp) {
            const priceEl = document.querySelector('.current-price');
            const mrpEl = document.querySelector('.mrp-strike');
            const discEl = document.querySelector('.discount-badge');

            if (priceEl) priceEl.innerText = '₹' + price;

            if (mrpEl) {
                if (mrp && mrp > price) {
                    mrpEl.innerText = '₹' + mrp;
                    mrpEl.style.display = 'inline';
                } else {
                    mrpEl.style.display = 'none';
                }
            }

            if (discEl) {
                if (mrp && mrp > price) {
                    const off = Math.round(((mrp - price) / mrp) * 100);
                    discEl.innerText = off + '% OFF';
                    discEl.style.display = 'inline-block';
                } else {
                    discEl.style.display = 'none';
                }
            }
        }

        function renderMainContentHTML(p, subBrand = '', subBrandLogo = '') {
            let variants = [];
            try { variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : (p.quantity_variants || []); } catch (e) { }

            // Default Values
            let currentPrice = p.price || 0;
            let currentMrp = p.mrp || 0;
            let packSize = '';

            // Default styling for TOP-RIGHT Logo
            let subBrandHtml = '';
            if (subBrandLogo) {
                subBrandHtml = `<img src="${subBrandLogo}" alt="${subBrand}" 
                    style="position: absolute; top: 10px; right: 10px; width: 80px; height: auto; z-index: 10; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">`;
            } else if (subBrand) {
                subBrandHtml = `<div class="sub-brand-display" style="font-size:0.9rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">${subBrand}</div>`;
            }

            // If variants exist, use 1st one
            if (variants.length > 0) {
                const v = variants[0];
                currentPrice = v.price;
                currentMrp = v.mrp;
                packSize = v.quantity;
            }

            // Calculations
            let discountHtml = '';
            if (currentMrp > currentPrice) {
                const off = Math.round(((currentMrp - currentPrice) / currentMrp) * 100);
                discountHtml = `<span class="discount-badge" style="background:var(--color-success, #10B981); color:white; padding:4px 10px; border-radius:4px; font-size:0.9rem; font-weight:600; margin-top:4px; display:inline-block;">${off}% OFF</span>`;
            } else {
                discountHtml = `<span class="discount-badge" style="display:none; background:var(--color-success, #10B981); color:white; padding:4px 10px; border-radius:4px; font-size:0.9rem; font-weight:600; margin-top:4px;"></span>`;
            }

            // Variant Selector HTML
            let variantSelector = '';
            if (variants.length > 1) {
                variantSelector = `
                    <div style="margin: 1rem 0;">
                        <label style="display:block; font-size:0.9rem; color:var(--text-secondary); margin-bottom:5px;">Select Pack Size:</label>
                        <select id="variantSelect" data-product-id="${p.id}" onchange="window.updateVariantSelection()" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border-medium); font-size:1rem; width:100%; max-width:250px; cursor:pointer; background:var(--bg-secondary);">
                            ${variants.map((v, i) => `<option value="${i}">${v.quantity}</option>`).join('')}
                        </select>
                    </div>
                `;
            } else if (packSize) {
                variantSelector = `<p style="margin: 1rem 0; color:var(--text-secondary);"><strong>Pack Size:</strong> ${packSize}</p>`;
            }


            const imgUrl = p.showcase_image || window.globalPlaceholder;

            // Tabs Logic
            let tabsHtml = '';
            let contentHtml = '';
            const addTab = (id, label, icon, content) => {
                const activeClass = tabsHtml === '' ? 'active' : ''; // Activation handled by click, simplified here
                // Note: The original code didn't auto-activate first tab in HTML generation, depends on click
                tabsHtml += `<button class="info-btn" onclick="openTab('${id}')" id="btn-${id}"><i class="${icon}"></i> ${label}</button>`;
                contentHtml += `<div id="content-${id}" class="info-content-panel" style="display:none;">${content}</div>`;
            };

            if (p.ingredients && p.ingredients.length > 2) addTab('ing', 'Ingredients', 'fas fa-carrot', `<p>${p.ingredients}</p>`);

            // Moved Usage Tab to AFTER Nutrition block (pushed down)


            if (p.nutrition_info) {
                let n = {};
                try { n = typeof p.nutrition_info === 'string' ? JSON.parse(p.nutrition_info) : p.nutrition_info; } catch (e) { }

                const fmt = (val, unit) => {
                    if (!val) return '';
                    const s = String(val).trim();
                    if (s.toLowerCase().endsWith(unit.toLowerCase())) return s;
                    if (/[^0-9.]/.test(s)) return s;
                    return s + unit;
                };

                // Store global for variant updates
                window.CURRENT_PRODUCT_SERVING_SIZE = n.serving_size;

                // Initial Calculation
                let initialServingsText = '';
                if (n.serving_size && variants.length > 0) {
                    // logic to calc initial
                    // We need parseWeight here too, but it's inside updateVariantSelection scope or we need to duplicate/move it.
                    // Simpler: Just rely on default n.total_servings or let it update on interaction? 
                    // Better: duplicate helper locally for initial render or make it global. 
                    // Let's use n.total_servings if available, else calc.
                    const pw = (str) => {
                        if (!str) return 0;
                        str = str.toLowerCase().trim();
                        const num = parseFloat(str.replace(/[^0-9.]/g, ''));
                        if (str.includes('kg')) return num * 1000;
                        return num;
                    };

                    if (!n.total_servings) {
                        const pack = pw(variants[0].quantity);
                        const serv = pw(n.serving_size);
                        if (pack > 0 && serv > 0) n.total_servings = Math.round(pack / serv) + ' (approx)';
                    }
                }

                if (n.calories || n.protein || n.serving_size) {
                    let topInfo = '';
                    // Dynamic Header
                    topInfo = `<div style="margin-bottom:15px; font-size:0.95rem; color:var(--text-secondary); text-align: center; border-bottom: 1px solid var(--border-light); padding-bottom: 10px; display:flex; justify-content:center; gap:15px;">
                            ${n.serving_size ? `<span>Serving Size: <strong>${n.serving_size}</strong></span>` : ''}
                            ${n.serving_size ? '<span style="color:var(--border-medium)">|</span>' : ''}
                            <span id="dynamic-servings-count">Servings: <strong>${n.total_servings || '-'}</strong></span>
                        </div>`;

                    const fields = [
                        ['Calories', 'calories', ''],
                        ['Protein', 'protein', 'g'],
                        ['Total Fat', 'total_fat', 'g'],
                        ['Saturated Fat', 'saturated_fat', 'g'],
                        ['Carbs', 'carbs', 'g'],
                        ['Fiber', 'fiber', 'g'],
                        ['Sugars', 'sugars', 'g'],
                        ['Sodium', 'sodium', 'mg']
                    ];
                    if (n.fat && !n.total_fat) n.total_fat = n.fat;

                    let gridRows = '';
                    fields.forEach(([label, key, unit]) => {
                        if (n[key]) {
                            gridRows += `<div class="nut-row" style="padding: 6px; background:var(--bg-secondary); border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight: 600; color: var(--text-primary); font-size:0.75rem;">${label}</span>
                                <span style="font-weight: 700; color: var(--color-primary-blue); font-size:0.75rem;">${fmt(n[key], unit)}</span>
                            </div>`;
                        }
                    });

                    // Grid wrapper with 2 columns
                    let content = `${topInfo}<div class="nut-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">${gridRows}</div>`;
                    if (n.details) content += `<p style="margin-top:15px; font-size:0.8rem; color: var(--text-muted); line-height: 1.4;">${n.details}</p>`;

                    addTab('nut', 'Nutrition', 'fas fa-heartbeat', content);
                }

                // Add Usage Tab here so it appears LAST
                if (p.serving_suggestion && p.serving_suggestion.length > 2) addTab('use', 'Usage', 'fas fa-utensils', `<p>${p.serving_suggestion}</p>`);
            }

            return `
                <div class="product-gallery" style="position: relative;">
                    ${subBrandLogo ? subBrandHtml : ''}
                    <img src="${imgUrl}" alt="${p.product_name}" onerror="this.onerror=null; this.src='${window.globalPlaceholder}'">
                </div>
                <div class="product-details">
                    <!-- Text Sub-brand only if no logo -->
                    ${!subBrandLogo ? subBrandHtml : ''}
                    
                    <h1 class="product-title">${p.product_name}</h1>
                    <div class="telugu-title">${p.product_name_telugu || p.product_tagline || ''}</div>
                    
                    <div class="price-row" style="align-items: flex-start; gap: 15px;">
                        <span class="current-price" style="font-size: 2.2rem; color: var(--color-primary-blue);">₹${currentPrice}</span>
                        <div style="display: flex; flex-direction: column;">
                             <span class="mrp-strike" style="${currentMrp > currentPrice ? '' : 'display:none'}; color: var(--text-muted); font-size: 1rem;">MRP ₹${currentMrp}</span>
                             ${discountHtml}
                        </div>
                    </div>

                    <div class="desc-box">
                        <p>${p.product_description || 'Authentic traditional taste.'}</p>
                        ${variantSelector}
                    </div>

                    <div class="info-btns-row">${tabsHtml}</div>
                    <div class="info-display-area">${contentHtml}</div>

                    <div class="buy-action-box">
                        <a href="https://wa.me/c/919618519191" target="_blank" class="buy-btn" style="text-decoration:none;">
                            <i class="fab fa-whatsapp"></i> Buy on WhatsApp
                        </a>
                    </div>
                </div>
            `;
        }

        function renderSimilarHTML(target, all) {
            const blocked = new Set(['salt', 'chilly', 'oil', 'turmeric']);
            const getParts = (str) => {
                if (!str) return [];
                return str.toLowerCase().split(/[,\n]+/).map(s => s.trim()).filter(s => s && !blocked.has(s) && s.length > 2);
            };
            const targetParts = getParts(target.ingredients);

            const recs = all.filter(p => p.id !== target.id).map(p => {
                const pParts = getParts(p.ingredients);
                const intersection = pParts.filter(x => targetParts.some(t => x.includes(t) || t.includes(x)));
                const isSameCat = p.product_category === target.product_category;
                return { ...p, score: (intersection.length * 2) + (isSameCat ? 1 : 0) };
            }).sort((a, b) => b.score - a.score).slice(0, 5);

            return recs.map(r => `
                <div class="sim-item" onclick="window.location.href='sales.html?id=${r.id}'">
                    <img src="${r.showcase_image || window.globalPlaceholder}" class="sim-img" onerror="this.src='${window.globalPlaceholder}'">
                    <div class="sim-info">
                        <h4>${r.product_name}</h4>
                        <div class="sim-price">View</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTrendingHTML(all) {
            const trending = all.filter(p => p.is_trending);
            if (trending.length === 0) return '<p style="text-align:center; padding:20px; color:var(--text-secondary);">No trending items.</p>';

            return trending.map(r => `
                <div class="sim-item" onclick="window.location.href='sales.html?id=${r.id}'">
                    <img src="${r.showcase_image || window.globalPlaceholder}" class="sim-img" onerror="this.src='${window.globalPlaceholder}'">
                    <div class="sim-info">
                        <h4>${r.product_name}</h4>
                        <div class="sim-price">View</div>
                    </div>
                </div>
            `).join('');
        }

        window.switchSidebarTab = function (tabName) {
            // Hide all content
            document.querySelectorAll('.sidebar-content').forEach(el => el.classList.remove('active'));
            // Deactivate all tabs
            document.querySelectorAll('.sidebar-tab').forEach(el => el.classList.remove('active'));

            // Allocate proper ID
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        }

        function updateRecentHistory(product) {
            let history = [];
            try { history = JSON.parse(localStorage.getItem('recentProducts') || '[]'); } catch (e) { }
            history = history.filter(h => h.id !== product.id);
            history.unshift({ id: product.id, name: product.product_name, image: product.showcase_image });
            if (history.length > 8) history.pop();
            localStorage.setItem('recentProducts', JSON.stringify(history));
        }

        function renderRecentHTML(current) {
            let history = [];
            try { history = JSON.parse(localStorage.getItem('recentProducts') || '[]'); } catch (e) { }
            const placeholder = window.globalPlaceholder;

            return history.filter(h => h.id !== current.id).map(h => `
                 <div class="sim-item" onclick="window.location.href='sales.html?id=${h.id}'" style="border:1px solid var(--border-light); background:white; padding:10px;">
                     <img src="${h.image || placeholder}" class="sim-img" onerror="this.src='${placeholder}'">
                     <div class="sim-info">
                         <h4>${h.name}</h4>
                         <div class="sim-price" style="color:var(--text-secondary); font-weight:normal;">View Product</div>
                     </div>
                 </div>
             `).join('');
        }


        window.openTab = function (id) {
            const c = document.getElementById(`content-${id}`);
            const b = document.getElementById(`btn-${id}`);

            // Check if already active
            if (c.style.display === 'block') {
                // Close it (Toggle off)
                c.style.display = 'none';
                b.classList.remove('active');
                return;
            }

            // Close all others
            document.querySelectorAll('.info-content-panel').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.info-btn').forEach(el => el.classList.remove('active'));

            // Open clicked
            if (c) c.style.display = 'block';
            if (b) b.classList.add('active');
        }

        init();
    </script>
</body>

</html>