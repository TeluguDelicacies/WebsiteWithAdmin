<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKZ2D4B6MC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-ZKZ2D4B6MC');
    </script>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <!-- Prevent auto-scroll on refresh -->
    <script>if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; window.scrollTo(0, 0);</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telugu Delicacies</title>
    <meta name="description"
        content="Order authentic Telugu podis, soft chapatis and crispy parotas made with traditional recipes and hygienic methods. Taste real Andhra flavours at Telugu Delicacies." />

    <!-- Open Graph Meta Tags (WhatsApp Sharing) -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://telugudelicacies.com/sales.html" />
    <meta property="og:title" content="Telugu Delicacies ‚Äì Modern Yet Traditional" />
    <meta property="og:description"
        content="Home of traditional Telugu podis, tasty chapatis, and flaky parotas ‚Äì crafted with authentic recipes and modern hygiene." />
    <meta property="og:image"
        content="https://pfffotghmcofyrvqynbl.supabase.co/storage/v1/object/public/site-assets/1767276219672_20aiu9.png" />
    <meta property="og:image:width" content="600" />
    <meta property="og:image:height" content="600" />
    <!-- Core Assets -->
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Mallanna&family=Montserrat:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Ubuntu+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png"
        href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" id="dynamic-favicon">

    <!-- Isolated Page Styles -->
    <link rel="stylesheet" href="sales-page.css?v=2.0">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0077b6">
    <link rel="apple-touch-icon"
        href="https://pfffotghmcofyrvqynbl.supabase.co/storage/v1/object/public/site-assets/1767276219672_20aiu9.png">
</head>

<body>
    <header class="header sales-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo Section -->
                <a href="/" class="logo-section">
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                        id="headerLogo" alt="Telugu Delicacies Logo" class="logo"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="logo-fallback" style="display: none;">TD</div>
                    <div class="logo-text">
                        <h1 class="brand-name" id="header-site-title">Telugu Delicacies</h1>
                        <span id="header-telugu-brand" class="telugu-brand"></span>
                    </div>
                </a>

                <!-- Desktop Navigation -->
                <nav class="desktop-nav">
                    <button class="nav-btn share-page-btn" onclick="window.shareCurrentPage()"
                        data-tooltip="Share Page">
                        <i class="fas fa-arrow-up-from-bracket"></i>
                    </button>
                    <button class="nav-btn cart-btn" id="cartBtn" onclick="window.toggleCartDrawer()"
                        data-tooltip="View Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="mainCartCount" style="display:none;">0</span>
                    </button>
                    <button id="pwaInstallBtn" class="nav-btn install-btn" style="display:none;"
                        onclick="window.installPWA()" data-tooltip="Install App">
                        <i class="fas fa-download"></i>
                    </button>
                    <a href="/" class="nav-btn home-btn" data-tooltip="Back Home">
                        <i class="fas fa-home"></i>
                    </a>
                </nav>

                <!-- Mobile Actions -->
                <div class="mobile-actions">
                    <button class="nav-btn share-page-btn" onclick="window.shareCurrentPage()"
                        data-tooltip="Share Page">
                        <i class="fas fa-arrow-up-from-bracket"></i>
                    </button>
                    <button class="nav-btn cart-btn" id="mobileCartBtn" onclick="window.toggleCartDrawer()"
                        data-tooltip="View Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="mobileCartCount" style="display:none;">0</span>
                    </button>
                    <button id="pwaInstallBtnMobile" class="nav-btn install-btn" style="display:none;"
                        onclick="window.installPWA()" data-tooltip="Install App">
                        <i class="fas fa-download"></i>
                    </button>
                    <a href="/" class="nav-btn home-btn" data-tooltip="Back Home">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="sales-page-container" id="app">
        <!-- Loader -->
        <div style="text-align: center; padding: 100px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--color-primary-blue)"></i>
        </div>
    </main>

    <!-- Cart Drawer -->
    <div id="cartOverlay" class="cart-overlay" onclick="window.toggleCartDrawer()"></div>
    <div id="cartDrawer" class="cart-drawer">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="clear-cart-btn" onclick="window.clearCart()" style="display:none;">Clear All</button>
                <button class="close-cart-btn" onclick="window.toggleCartDrawer()">&times;</button>
            </div>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Items will be populated here -->
            <div class="empty-cart-msg">Your cart is empty</div>
        </div>
        <div class="cart-footer">
            <div class="delivery-note">* Delivery charges may apply</div>
            <div class="cart-total-row">
                <span>Total:</span>
                <span class="total-amount">‚Çπ<span id="cartTotal">0</span></span>
            </div>
            <button class="order-whatsapp-btn" onclick="window.sendToWhatsApp()">
                <i class="fab fa-whatsapp"></i> Order on WhatsApp
            </button>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <!-- Company Information -->
                <div class="footer-brand">
                    <h2>Telugu Delicacies</h2>
                    <p class="footer-tagline">‡∞∏‡∞æ‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞æ‡∞Ø ‡∞∞‡±Å‡∞ö‡±Å‡∞≤‡±Å, ‡∞Ü‡∞ß‡±Å‡∞®‡∞ø‡∞ï ‡∞∂‡±à‡∞≤‡∞ø</p>
                    <p class="fssai-license" id="contact-fssai">FSSAI License: 13623999000239</p>
                    <div class="footer-social-icons">
                        <a href="#" id="footer-facebook-link" target="_blank" aria-label="Facebook"><i
                                class="fab fa-facebook"></i></a>
                        <a href="#" id="footer-instagram-link" target="_blank" aria-label="Instagram"><i
                                class="fab fa-instagram"></i></a>
                        <a href="#" id="footer-whatsapp-link" target="_blank" aria-label="WhatsApp"><i
                                class="fab fa-whatsapp"></i></a>
                        <a href="#" id="footer-youtube-link" target="_blank" aria-label="YouTube"><i
                                class="fab fa-youtube"></i></a>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="footer-section footer-contact" id="footer-contact">
                    <h4>Contact Us</h4>
                    <p><a href="#" id="contact-phone-primary">Loading...</a></p>
                    <p><a href="#" id="contact-phone-secondary"></a></p>
                    <p><a href="#" id="contact-email">Loading...</a></p>
                </div>

                <!-- Address Information -->
                <div class="footer-section footer-address">
                    <h4>Our Location</h4>
                    <div id="contact-address">
                        <p>Loading address...</p>
                    </div>

                    <!-- Legal Links -->
                    <div class="footer-legal-links">
                        <a href="legal.html?type=privacy">Privacy Policy</a>
                        <a href="legal.html?type=cookie">Cookie Policy</a>
                        <a href="legal.html?type=terms">Terms of Use</a>
                        <a href="legal.html?type=shipping_returns">Shipping & Returns</a>
                    </div>
                </div>

                <!-- Google Maps Section -->
                <div class="footer-map">
                    <h4>Find Us</h4>
                    <div class="map-container" id="footer-map-container">
                        <iframe
                            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3805.8428871601745!2d78.60164107521217!3d17.46723238343367!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bcb9d007f562aaf%3A0x2f13d0ef2a0f7614!2sTelugu%20Delicacies!5e0!3m2!1sen!2sin!4v1756361897165!5m2!1sen!2sin"
                            width="100%" height="250" style="border:0;" allowfullscreen="" loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>

            <!-- Copyright -->
            <div class="footer-bottom">
                <p>&copy; 2025 Telugu Delicacies. All rights reserved. | Crafted with ‚ù§Ô∏è for authentic
                    South Indian
                    Taste</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import { supabase } from './lib/supabase.js';

        // Expose supabase to window for HeaderComponent
        window.supabase = supabase;

        // State Management
        const state = {
            allProducts: [],
            categories: [],
            settings: {},
            loading: true,
            currentCategory: null,
            currentProduct: null,
            cart: [],
            detailQty: 1,
            catalogueFile: null,
            allCombos: []
        };

        // Expose state for debugging
        window.state = state;

        // Initialize header cart button visibility
        window.initHeaderCartButton = function () {
            try {
                const cart = JSON.parse(localStorage.getItem('td_cart') || '[]');

                // Update Badge Count
                const count = cart.reduce((sum, item) => sum + (item.qty || item.quantity || 1), 0);
                ['mainCartCount', 'mobileCartCount'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = count;
                        // Only show badge if count > 0
                        el.style.display = count > 0 ? 'flex' : 'none';
                    }
                });

                // Check if we should auto-open cart (from legal page redirect)
                // Use a slight delay to ensure drawer JS is ready if needed, 
                // though window.toggleCartDrawer comes from sales.html external script/previous definition
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('cart') === 'open' && window.toggleCartDrawer) {
                    setTimeout(() => window.toggleCartDrawer(), 300);
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                }
            } catch (e) {
                console.warn('[Cart Init] Error:', e);
            }
        };

        async function preloadCatalogue() {
            const catalogueUrl = state.settings.catalogue_image_url;
            if (!catalogueUrl) return;

            try {
                const response = await fetch(catalogueUrl);
                const blob = await response.blob();
                state.catalogueFile = new File([blob], 'Telugu_Delicacies_Catalogue.jpg', { type: 'image/jpeg' });
                console.log('Catalogue pre-loaded successfully');
            } catch (err) {
                console.warn('Failed to pre-load catalogue:', err);
            }
        }

        // GLOBAL SHARE CURRENT PAGE FUNCTION
        window.shareCurrentPage = function () {
            const currentUrl = window.location.href;
            let shareText = "Check out Telugu Delicacies!";

            // Context-aware message
            if (state.currentProduct) {
                const product = state.currentProduct;
                const tagline = product.product_tagline ? ` - "${product.product_tagline}"` : '';
                shareText = `Check out ${product.product_name}${tagline} at Telugu Delicacies! üòã`;
            } else if (state.currentCategory === 'all-products') {
                // Special message for All Products page
                shareText = `üçΩÔ∏è From Podis to Parotas - explore our complete range at Telugu Delicacies!`;
            } else if (state.currentCategory) {
                const cat = state.categories.find(c => c.slug === state.currentCategory);
                if (cat) {
                    // Fetch top 2 products for this category
                    const catProducts = state.allProducts.filter(p =>
                        (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === state.currentCategory
                    );
                    const topProducts = catProducts.slice(0, 2).map(p => p.product_name).join(', ');
                    const productText = topProducts ? ` featuring ${topProducts} and more` : '';

                    shareText = `Check out our ${cat.title} collection${productText} at Telugu Delicacies!`;
                }
            }

            const fullMessage = `${shareText}\n${currentUrl}`;

            // Mobile: Use native share if available
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && navigator.share) {
                navigator.share({
                    title: 'Telugu Delicacies',
                    text: fullMessage
                    // Note: Removing 'url' parameter to prevent duplicate links in apps like WhatsApp
                }).catch(err => console.log('Share cancelled'));
                return;
            }

            // Fallback: Open WhatsApp with URL
            const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(fullMessage)}`;
            window.open(whatsappUrl, '_blank');
        };

        function populateFooter(data) {
            if (!data) return;

            // FSSAI
            if (data.fssai_number) {
                const el = document.getElementById('contact-fssai');
                if (el) el.innerText = `FSSAI License No: ${data.fssai_number}`;
            }

            // Contact Info
            if (data.contact_phone_primary) {
                const el = document.getElementById('contact-phone-primary');
                if (el) {
                    el.innerText = data.contact_phone_primary;
                    el.href = `tel:${data.contact_phone_primary.replace(/\s/g, '')}`;
                }
            }
            if (data.contact_phone_secondary) {
                const el = document.getElementById('contact-phone-secondary');
                if (el) {
                    el.innerText = data.contact_phone_secondary;
                    el.href = `tel:${data.contact_phone_secondary.replace(/\s/g, '')}`;
                }
            }
            if (data.contact_email) {
                const el = document.getElementById('contact-email');
                if (el) {
                    el.innerText = data.contact_email;
                    el.href = `mailto:${data.contact_email}`;
                }
            }

            // Address
            if (data.company_address) {
                const el = document.getElementById('contact-address');
                if (el) {
                    el.innerHTML = `<p>${data.company_address}</p>`;
                }
            }

            // Social Media links
            const socialMap = [
                { id: 'footer-facebook-link', url: data.facebook_url },
                { id: 'footer-instagram-link', url: data.instagram_url },
                { id: 'footer-whatsapp-link', url: data.whatsapp_url },
                { id: 'footer-youtube-link', url: data.youtube_url }
            ];

            socialMap.forEach(item => {
                const el = document.getElementById(item.id);
                if (el) {
                    let url = item.url;
                    if (url && item.id === 'footer-whatsapp-link' && /^\d+$/.test(url.replace(/[\s\+]/g, ''))) {
                        url = `https://wa.me/${url.replace(/[\s\+]/g, '')}`;
                    }
                    if (url) {
                        el.href = url;
                        el.style.display = 'flex';
                    } else {
                        el.style.display = 'none';
                    }
                }
            });

            // Map
            if (data.map_embed_url) {
                const mapContainer = document.getElementById('footer-map-container');
                if (mapContainer) {
                    let mapSrc = data.map_embed_url;
                    if (mapSrc.includes('<iframe')) {
                        const match = mapSrc.match(/src=["']([^"']+)["']/);
                        if (match && match[1]) mapSrc = match[1];
                    }
                    mapContainer.innerHTML = `<iframe src="${mapSrc}" width="100%" height="250" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
                }
            }

            // Google Review URL
            if (data.google_review_url) {
                const writeReviewBtn = document.getElementById('writeReviewBtn');
                if (writeReviewBtn) writeReviewBtn.href = data.google_review_url;
            }
        }

        // Initialize App
        async function init() {
            // Expose toggleFlip globally
            window.toggleFlip = function () {
                const el = document.querySelector('.gallery-inner');
                const btns = document.querySelectorAll('.toggleDescriptionBtn'); // Update all buttons
                const disclaimer = document.querySelector('.product-disclaimer-overlay');
                if (el) {
                    el.classList.toggle('flipped');
                    const isFlipped = el.classList.contains('flipped');

                    // Hide/Show action container (Add/Qty buttons)
                    const actionContainer = document.querySelector('.gallery-front .card-action-container');
                    if (actionContainer) {
                        actionContainer.style.opacity = isFlipped ? '0' : '1';
                        actionContainer.style.pointerEvents = isFlipped ? 'none' : 'auto';
                    }

                    // Mobile variant container remains visible during flip per user request
                    const mobileVariantContainer = document.getElementById('mobileVariantContainer');
                    if (mobileVariantContainer) {
                        mobileVariantContainer.style.opacity = '1';
                        mobileVariantContainer.style.pointerEvents = 'auto';
                    }

                    // Update button text based on state for all instances
                    btns.forEach(btn => {
                        btn.innerHTML = isFlipped
                            ? '<i class="fas fa-image"></i> Back to Image'
                            : '<i class="fas fa-info-circle"></i> About Product';
                    });

                    // Hide/show disclaimer
                    if (disclaimer) {
                        disclaimer.style.opacity = isFlipped ? '0' : '1';
                    }

                    // Hide/show thumbnail strip
                    const thumbnailStrip = document.getElementById('imageThumbnailStrip');
                    if (thumbnailStrip) {
                        thumbnailStrip.style.opacity = isFlipped ? '0' : '1';
                        thumbnailStrip.style.pointerEvents = isFlipped ? 'none' : 'auto';
                    }

                    // Hide/show carousel dots
                    const carouselDots = document.getElementById('carouselDots');
                    if (carouselDots) {
                        carouselDots.style.opacity = isFlipped ? '0' : '1';
                    }

                    // Auto-scroll into view on mobile when flipped to description
                    if (isFlipped && window.innerWidth < 768) {
                        const backPanel = document.querySelector('.gallery-back');
                        if (backPanel) {
                            setTimeout(() => {
                                backPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 400);
                        }
                    }
                }
            };

            // Mobile Swipe Navigation
            window.initSwipeNavigation = function () {
                const targetArea = document.querySelector('.main-product-area');
                if (!targetArea) return;

                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let touchEndY = 0;
                const minSwipeDistance = 75; // Increased for better stability

                targetArea.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });

                targetArea.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    touchEndY = e.changedTouches[0].screenY;
                    handleSwipe();
                }, { passive: true });

                function handleSwipe() {
                    // Only navigate if NOT flipped (image is visible)
                    const gallery = document.querySelector('.product-gallery');
                    const inner = gallery ? gallery.querySelector('.gallery-inner') : null;
                    if (inner && inner.classList.contains('flipped')) return;

                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    const totalMotion = Math.abs(deltaX) + Math.abs(deltaY);
                    const swipeDistance = Math.abs(deltaX);
                    const viewportWidth = window.innerWidth;

                    // 0. Absolute vertical cap - reject curved scrolls
                    const maxVerticalForSwipe = 40; // px
                    if (Math.abs(deltaY) > maxVerticalForSwipe) return;

                    // 0b. Angle-based detection - reject diagonal swipes (must be within ¬±15¬∞ of horizontal)
                    const angle = Math.abs(Math.atan2(deltaY, deltaX) * (180 / Math.PI));
                    if (angle > 15 && angle < 165) return; // Too diagonal = not a horizontal swipe

                    // 1. Require horizontal motion to be at least 80% of total motion
                    if (totalMotion === 0 || (swipeDistance / totalMotion) < 0.8) return;

                    // 2. Ignore swipes that are too short (noise)
                    if (swipeDistance < minSwipeDistance) return;

                    // 3. Ignore swipes that are too long (likely a browser or full-screen gesture)
                    if (swipeDistance > viewportWidth * 0.9) return;

                    // Find navigation links
                    const prevLink = document.querySelector('.nav-btn-pill.prev:not(.disabled)');
                    const nextLink = document.querySelector('.nav-btn-pill.next:not(.disabled)');

                    if (deltaX > 0 && prevLink) {
                        // Swiped right -> go to previous product
                        const prevId = prevLink.getAttribute('data-id');
                        navigateToProduct(prevId, 'left');
                    } else if (deltaX < 0 && nextLink) {
                        // Swiped left -> go to next product
                        const nextId = nextLink.getAttribute('data-id');
                        navigateToProduct(nextId, 'right');
                    }
                }
            };

            window.navigateToProduct = function (slugOrId, direction = 'fade') {
                const newUrl = `/sales/${slugOrId}`;

                // If it's the same product, do nothing
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts[pathParts.length - 1] === slugOrId) return;

                // Update URL without reload
                history.pushState({ slugOrId, direction, type: 'product' }, '', newUrl);

                // Perform view update with animation
                performTransition(slugOrId, direction);
            };

            window.navigateToCategory = function (slug) {
                const newUrl = `/sales/${slug}`;
                history.pushState({ slug, type: 'category' }, '', newUrl);

                if (slug === 'all-products') {
                    renderAllProductsView();
                } else if (slug === 'combo-offers') {
                    renderAllCombosView();
                } else {
                    renderCategoryView(slug);
                }
            };

            async function performTransition(slugOrId, direction) {
                const app = document.getElementById('app');
                const oldContent = app.querySelector('.grid-layout');

                if (!oldContent || direction === 'fade') {
                    renderProductView(slugOrId);
                    app.scrollIntoView({ behavior: 'smooth' });
                    return;
                }

                // Create wrapper for transition
                app.style.position = 'relative';
                app.style.overflow = 'hidden';

                // Add exit animation to old content
                oldContent.classList.add('slide-container');
                oldContent.classList.add(direction === 'right' ? 'slide-out-left' : 'slide-out-right');

                // Wait for animation or just render new
                setTimeout(() => {
                    renderProductView(slugOrId, direction);
                    app.scrollIntoView({ behavior: 'smooth' });
                }, 150); // Small delay to start the exit
            }

            window.addEventListener('popstate', (e) => {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const lastPart = pathParts[pathParts.length - 1];

                if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'sales' && lastPart !== 'sales.html') {
                    renderProductView(lastPart, e.state?.direction || 'fade');
                } else if (window.location.pathname.endsWith('sales.html') || pathParts[pathParts.length - 1] === 'sales') {
                    renderCategoryView();
                }
            });

            try {
                console.log('[Sales Init] Starting data fetch...');
                const [settingsRes, productsRes, categoriesRes, imagesRes, combosRes] = await Promise.all([
                    supabase.from('site_settings').select('*').single(),
                    supabase.from('products').select('*').order('display_order', { ascending: true }),
                    supabase.from('categories').select('*').order('display_order', { ascending: true }),
                    supabase.from('product_images').select('product_id, image_url, tags, is_default').order('display_order', { ascending: true }),
                    supabase.from('combos').select('*, combo_items(*, products(*, product_images(*)))').eq('is_active', true).order('display_order', { ascending: true })
                ]);

                // Check for Supabase errors (these don't throw, they return .error)
                if (settingsRes.error) {
                    console.error('[Sales Init] Settings Error:', settingsRes.error);
                }
                if (productsRes.error) {
                    console.error('[Sales Init] Products Error:', productsRes.error);
                    throw new Error('Failed to load products: ' + productsRes.error.message);
                }
                if (categoriesRes.error) {
                    console.error('[Sales Init] Categories Error:', categoriesRes.error);
                    throw new Error('Failed to load categories: ' + categoriesRes.error.message);
                }
                if (imagesRes.error) {
                    console.warn('[Sales Init] Images Error:', imagesRes.error);
                }

                console.log('[Sales Init] Data fetched:', {
                    settings: settingsRes.data ? 'OK' : 'Empty',
                    products: productsRes.data?.length || 0,
                    categories: categoriesRes.data?.length || 0,
                    combos: combosRes.data?.length || 0
                });

                state.settings = settingsRes.data || {};
                state.allProductImages = imagesRes.data || [];
                state.allCombos = combosRes.data || [];
                preloadCatalogue(); // Pre-load after settings
                populateFooter(state.settings); // Populate rich footer
                // Filter out hidden products
                state.allProducts = (productsRes.data || []).filter(p => p.is_visible !== false);
                // Filter out hidden categories
                state.categories = (categoriesRes.data || []).filter(c => c.is_visible !== false);
                state.placeholder = state.settings.product_placeholder_url || './images/placeholder-product.jpg';

                // Sync Logo & Favicon
                if (state.settings.logo_url) {
                    const logoImg = document.getElementById('headerLogo');
                    if (logoImg) logoImg.src = state.settings.logo_url;

                    // Also set favicon if available, otherwise use logo
                    const faviconLink = document.querySelector("link[rel~='icon']");
                    if (faviconLink) faviconLink.href = state.settings.fav_icon_url || state.settings.logo_url;
                }

                // Populate Telugu Brand Name in Header
                if (state.settings.site_title_telugu) {
                    const teluguBrand = document.getElementById('header-telugu-brand');
                    if (teluguBrand) {
                        teluguBrand.textContent = state.settings.site_title_telugu;
                    }
                }

                console.log('[Sales Init] Routing...');
                handleRouting();

                // Initialize header cart button visibility
                initHeaderCartButton();
            } catch (err) {
                console.error("Initialization Failed:", err);
                document.getElementById('app').innerHTML = `
                    <div class="error-state">
                        <div class="error-card">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h2>Oops! Something went wrong</h2>
                            <p>We couldn't load the products right now. This might be a temporary issue.</p>
                            <div class="error-actions">
                                <button class="action-btn-pill primary" onclick="location.reload()">
                                    <i class="fas fa-redo"></i> Try Again
                                </button>
                                <a href="/" class="action-btn-pill outline">
                                    <i class="fas fa-home"></i> Go Home
                                </a>
                            </div>
                            <p class="error-hint">If the problem persists, please contact us via WhatsApp.</p>
                        </div>
                    </div>
                `;
            }
        }

        function handleRouting() {
            // Support clean URLs: /sales/product-slug
            const pathParts = window.location.pathname.split('/').filter(Boolean);
            const lastPart = pathParts[pathParts.length - 1];

            // Check if it's a product or category
            if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'sales' && lastPart !== 'sales.html') {
                // Check if it's 'all-products'
                if (lastPart === 'all-products') {
                    renderAllProductsView();
                    return;
                }

                // Check if it's 'combo-offers'
                if (lastPart === 'combo-offers') {
                    renderAllCombosView();
                    return;
                }

                // Check if it's a category
                const isCategory = state.categories.find(c => c.slug === lastPart);
                // Check if it's a combo
                const isCombo = state.allCombos.find(c => c.slug === lastPart);

                if (isCategory) {
                    renderCategoryView(lastPart);
                } else if (isCombo) {
                    renderComboView(lastPart);
                } else {
                    renderProductView(lastPart);
                }
                return;
            }

            // Fallback: Support legacy query params for backwards compatibility
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            const catSlug = params.get('category');

            if (productId) {
                renderProductView(productId);
            } else if (catSlug) {
                if (catSlug === 'all-products') {
                    renderAllProductsView();
                } else {
                    renderCategoryView(catSlug);
                }
            } else {
                // Default handling for /sales.html root
                if (state.categories.length > 0) {
                    // Check if we want to default to All Products or First Category
                    // Let's stick to first category for now unless requested otherwise, 
                    // OR redirect to all-products? 
                    // User just asked for the view, not to change default.
                    renderCategoryView(state.categories[0].slug);
                }
            }
        }

        // --- View: All Products ---
        function renderAllProductsView() {
            const app = document.getElementById('app');

            // Update State
            state.currentCategory = 'all-products';
            state.currentProduct = null;

            // Sort by Category Order, then Product Order
            // 1. Create a map of "Category Slug" -> "Category Index/Order"
            const catOrderMap = {};
            state.categories.forEach((c, idx) => {
                catOrderMap[c.slug] = idx;
            });

            // 2. Sort products
            const allVisible = [...state.allProducts].sort((a, b) => {
                const catSlugA = (a.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
                const catSlugB = (b.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');

                const orderA = catOrderMap[catSlugA] !== undefined ? catOrderMap[catSlugA] : 9999;
                const orderB = catOrderMap[catSlugB] !== undefined ? catOrderMap[catSlugB] : 9999;

                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                // Secondary sort: Product's own display_order (already handled by initial fetch, but good to be explicit if needed)
                return (a.display_order || 0) - (b.display_order || 0);
            });

            app.innerHTML = `
                <div class="breadcrumb-section">
                    ${window.renderSmartBreadcrumbs('all-products', '')}
                </div>

                <section class="category-grid-container" style="width:95%; max-width:95%; margin:0 auto; padding-bottom:50px;">
                    <!-- Widget Header -->
                    ${window.renderBrandWidget()}

                    <!-- New Grid Container -->
                    <div class="category-grid">
                        ${allVisible.map(p => renderProductCard(p, { title: 'All Products' })).join('')}
                    </div>
                </section>
            `;

            // Start Widget Cycle
            window.startBrandWidgetCycle();

            // Scroll breadcrumbs
            window.updateBreadcrumbScroll();
        }

        // --- Widget: Dynamic Sub-Brand Header ---
        window.renderBrandWidget = function () {
            // 1. Collect your brands (Keep your existing logic here)
            const brands = [];
            const seen = new Set();
            state.categories.forEach(c => {
                if (c.sub_brand && c.sub_brand_logo_url && !seen.has(c.sub_brand)) {
                    brands.push(c);
                    seen.add(c.sub_brand);
                }
            });

            if (brands.length === 0) return '';

            const tagline = state.settings?.all_products_tagline || 'Featuring our premium brands';

            // 2. THE CRITICAL CHANGE: 
            // We create ONE single container (.category-header-simple).
            // Child 1: The Text Div.
            // Child 2: The Logo Wrapper (The Carousel).

            return `
            <div class="category-header-simple brand-widget-container" style="display: flex; align-items: center; justify-content: space-between;">
                
                <div class="header-text-group">
                    <h1>All Products</h1>
                    <p>${tagline}</p>
                </div>
                
                <div class="brand-logos-wrapper">
                    <div class="desktop-brand-grid">
                        ${brands.map(b => `
                            <div class="desktop-logo-wrapper">
                                <img src="${b.sub_brand_logo_url}" class="brand-logo-item" alt="${b.sub_brand}">
                            </div>
                        `).join('')}
                    </div>
                </div>

            </div>`;
        };

        window.startBrandWidgetCycle = function () {
            // ONLY target logos within the mobile carousel
            const mobileLogos = document.querySelectorAll('.mobile-brand-carousel .brand-logo-item');
            if (mobileLogos.length <= 1) return;

            // Clear existing interval
            if (window.brandInterval) clearInterval(window.brandInterval);

            let current = 0;
            window.brandInterval = setInterval(() => {
                mobileLogos.forEach(l => l.classList.remove('active'));
                current = (current + 1) % mobileLogos.length;
                mobileLogos[current].classList.add('active');
            }, 2000);
        };

        // --- View: Category ---
        function renderCategoryView(slug) {
            const app = document.getElementById('app');

            // If no category slug, redirect to home page
            if (!slug) {
                window.location.href = '/';
                return;
            }

            // Update State
            state.currentCategory = slug;
            state.currentProduct = null;

            // Single Category Grid View
            renderSingleCategoryGrid(slug);
        }

        function renderSingleCategoryGrid(slug) {
            const app = document.getElementById('app');
            const category = state.categories.find(c => c.slug === slug);

            if (!category) {
                app.innerHTML = '<h2 class="text-center">Category Not Found</h2>';
                return;
            }

            const catProducts = state.allProducts.filter(p =>
                (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === slug
            );

            // Use the NEW Quick Commerce HTML Structure
            app.innerHTML = `
                <div class="breadcrumb-section">
                    ${window.renderSmartBreadcrumbs(slug, '')}
                </div>

                <section class="category-grid-container" style="width:95%; max-width:95%; margin:0 auto; padding-bottom:50px;">
                    <!-- Header -->
                    <div class="category-header-simple">
                        <div>
                            <h1>${category.title}</h1>
                            <p class="category-short-desc">${category.short_description || ''}</p>
                        </div>
                        ${category.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}">` : ''}
                    </div>

                    <!-- New Grid Container -->
                    <div class="category-grid">
                        ${catProducts.map(p => renderProductCard(p, category)).join('')}
                    </div>
                </section>
            `;

            // Scroll breadcrumbs
            window.updateBreadcrumbScroll();
        }

        /**
         * Helper: Sort variants based on default image tag and price
         * Rule: Matching Tag first, then Cheapest to Costliest
         */
        window.getSortedVariants = function (product) {
            let variants = [];
            try {
                if (typeof product.quantity_variants === 'string') {
                    variants = JSON.parse(product.quantity_variants);
                } else if (Array.isArray(product.quantity_variants)) {
                    variants = product.quantity_variants;
                }
            } catch (e) {
                console.warn('Variant parse error', e);
            }

            if (!variants || variants.length === 0) {
                return [{
                    quantity: product.quantity || 'Standard',
                    price: product.price,
                    mrp: product.mrp,
                    stock: product.total_stock,
                    packaging_type: ''
                }];
            }

            // 1. Identify "Active Tag" from Showcase Image
            const productImages = state.allProductImages || [];
            const showcaseImg = productImages.find(img => img.product_id === product.id && img.is_default) || productImages.find(img => img.product_id === product.id);
            const activeTags = (showcaseImg?.tags || []).map(t => t.toLowerCase().trim());

            // 2. Separate Matching Variant (First Match Wins)
            let matchingIdx = -1;
            if (activeTags.length > 0) {
                matchingIdx = variants.findIndex(v => {
                    const pkg = (v.packaging_type || '').toLowerCase().trim();
                    return pkg && activeTags.some(tag => tag.includes(pkg) || pkg.includes(tag));
                });
            }

            let firstVariant = null;
            let otherVariants = [...variants];

            if (matchingIdx > -1) {
                firstVariant = otherVariants.splice(matchingIdx, 1)[0];
            }

            // 3. Sort Others by Price (Ascending)
            otherVariants.sort((a, b) => (Number(a.price) || 0) - (Number(b.price) || 0));

            // 4. Combine
            return firstVariant ? [firstVariant, ...otherVariants] : otherVariants;
        };

        // --- Helper: Render Individual Card ---
        function renderProductCard(product, category) {
            // Sort variants: Matching Tag first, then Cheapest to Costliest
            const sortedVariants = window.getSortedVariants(product);

            // Default selected variant (Index 0 after sort)
            const defaultVar = sortedVariants[0];
            const defaultVarIdx = 0;

            // 2. Check Cart State for this specific variant
            const cartList = state.cart || [];
            const cartItem = cartList.find(item => item.id === product.id &&
                (item.variant ? item.variant.quantity === defaultVar.quantity : true)
            );
            const qty = cartItem ? cartItem.qty : 0;

            // 3. Discount Logic
            let discountTag = '';
            if (defaultVar.mrp > defaultVar.price) {
                const off = Math.round(((defaultVar.mrp - defaultVar.price) / defaultVar.mrp) * 100);
                discountTag = `<span class="discount" id="disc-${product.id}">${off}% OFF</span>`;
            }

            // 4. Resolve Category / Sub-brand
            let dispCategory = category;
            if (!dispCategory.sub_brand) {
                // Try to find the actual category for this product
                const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
                const realCat = state.categories.find(c => c.slug === catSlug);
                if (realCat) {
                    dispCategory = realCat;
                }
            }

            // 5. Resolve Images
            const productImages = state.allProductImages || [];
            const showcaseImg = productImages.find(img => img.product_id === product.id && img.is_default) || productImages.find(img => img.product_id === product.id);
            const displayImg = showcaseImg?.image_url || product.showcase_image || state.placeholder;

            // 6. Render
            return `
            <article class="product-card" id="card-${product.id}" data-variants='${JSON.stringify(sortedVariants).replace(/'/g, "&apos;")}' data-current-idx="0">
                
                 <!-- Image Area -->
                <div class="card-image-container">
                    <img src="${displayImg}" 
                         alt="${product.product_name}" 
                         class="product-image" 
                         loading="lazy"
                         onclick="navigateToProduct('${product.slug || product.id}', 'fade')">
                    
                    <!-- Floating Action -->
                    <div class="card-action-container">
                         <!-- Add Button (Visible if Qty 0) -->
                        <button class="btn-add" id="btn-add-${product.id}" 
                                style="${qty > 0 ? 'display:none' : ''}"
                                onclick="window.gridAddToCart('${product.id}')">
                            ADD
                        </button>
                        
                        <!-- Qty Counter (Visible if Qty > 0) -->
                        <div class="qty-counter" id="qty-counter-${product.id}" 
                             style="${qty > 0 ? 'display:flex' : 'display:none'}">
                            <button class="qty-btn" onclick="window.gridUpdateQty('${product.id}', -1)">-</button>
                            <span class="qty-val" id="qty-val-${product.id}">${qty}</span>
                            <button class="qty-btn" onclick="window.gridUpdateQty('${product.id}', 1)">+</button>
                        </div>
                    </div>
                </div>

                <!-- Info Area -->
                <div class="card-info">
                     <!-- 1. Sub-Brand (Top) -->
                     ${dispCategory.sub_brand ? `<span class="card-sub-brand">${dispCategory.sub_brand}</span>` : ''}

                     <!-- 2. English Title -->
                    <h3 class="product-title" onclick="navigateToProduct('${product.slug || product.id}', 'fade')">
                        ${product.product_name}
                    </h3>

                    <!-- 3. Telugu Title -->
                    <p class="product-subtitle">${product.product_name_telugu || category.telugu_title || ''}</p>

                    <!-- 4. Variant Selector (Relocated below tagline) -->
                    ${sortedVariants.length > 0 ? `
                        <div class="variant-selector" onclick="window.toggleGridVariantDropdown('${product.id}')" tabindex="0">
                            <span class="current-variant" id="var-label-${product.id}">${defaultVar.quantity || 'Standard'}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <!-- Dropdown List -->
                        <div class="variant-dropdown-list" id="var-list-${product.id}" style="display:none; position:absolute; bottom:50px; left:12px; background:white; border:1px solid #eee; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:20; width:150px; overflow:hidden;">
                            ${sortedVariants.map((v, idx) => `
                                <div class="var-option" 
                                     style="padding:8px 14px; font-size:0.8rem; cursor:pointer; color:#333; border-bottom:1px solid #f0f0f0;" 
                                     onclick="window.selectGridVariant('${product.id}', ${idx})">
                                    <div class="variant-info">
                                        <div class="variant-qty" style="font-weight:600; font-size:0.85rem;">${v.quantity}</div>
                                        ${v.packaging_type ? `<div class="variant-pkg" style="font-size:0.7rem; color:#666;">${v.packaging_type}</div>` : ''}
                                    </div>
                                    <div style="font-size:0.75rem; color:#666; font-weight:700;">‚Çπ${v.price}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                     <!-- 5. Price Row -->
                    <div class="price-row">
                        <span class="price-pill" id="price-${product.id}">‚Çπ${defaultVar.price}</span>
                        ${defaultVar.mrp > defaultVar.price ? `<span class="mrp" id="mrp-${product.id}">‚Çπ${defaultVar.mrp}</span>` : ''}
                        ${discountTag}
                    </div>

                    <!-- 6. Packaging Type (New) -->
                    <div class="packaging-type" id="pkg-${product.id}" style="font-size: 0.75rem; color: #64748b; margin-top: 4px; font-weight: 500;">
                        ${defaultVar.packaging_type || ''}
                    </div>

                </div>
            </article>
            `;
        }

        // --- Grid Interaction Helpers ---
        window.getGridCardData = function (productId) {
            const card = document.getElementById(`card-${productId}`);
            if (!card) return null;
            const variants = JSON.parse(card.getAttribute('data-variants') || '[]');
            const currentIdx = parseInt(card.getAttribute('data-current-idx') || '0');
            return { card, variants, currentIdx };
        };

        window.gridAddToCart = function (productId) {
            const data = window.getGridCardData(productId);
            if (!data) return;
            const product = state.allProducts.find(p => p.id == productId);
            if (!product) return;

            const variant = data.variants[data.currentIdx];

            // Add 1 to cart
            window.addToCart(product, variant, 1);

            // We don't need to manually update UI here because addToCart triggers saveCart -> updateCartUI?
            // Wait, updateCartUI() updates the drawer. We SHOULD also update the grid card state.
            window.refreshGridCardUI(productId);
        };

        window.gridUpdateQty = function (productId, delta) {
            const data = window.getGridCardData(productId);
            if (!data) return;
            const variant = data.variants[data.currentIdx];

            // Find existing cart item to update
            const existingIdx = state.cart.findIndex(item =>
                item.id == productId &&
                (item.variant ? (item.variant.quantity === variant.quantity && (item.variant.packaging_type || '') === (variant.packaging_type || '')) : true)
            );

            if (existingIdx > -1) {
                // Determine logic: directly update cart or use updateCartItemQty
                // Using updateCartItemQty handles removing if 0
                window.updateCartItemQty(existingIdx, delta, false);
            } else if (delta > 0) {
                // Should have been in cart if using this button, but fallback
                window.gridAddToCart(productId);
            }

            window.refreshGridCardUI(productId);
        };

        window.refreshGridCardUI = function (productId) {
            const data = window.getGridCardData(productId);
            if (!data) return;
            const variant = data.variants[data.currentIdx];

            // Check Cart State
            const cartItem = state.cart.find(item => item.id == productId &&
                (item.variant ? (item.variant.quantity === variant.quantity && (item.variant.packaging_type || '') === (variant.packaging_type || '')) : true)
            );
            const qty = cartItem ? cartItem.qty : 0;

            const btnAdd = document.getElementById(`btn-add-${productId}`);
            const qtyCounter = document.getElementById(`qty-counter-${productId}`);
            const qtyVal = document.getElementById(`qty-val-${productId}`);

            if (qty > 0) {
                btnAdd.style.display = 'none';
                qtyCounter.style.display = 'flex';
                qtyVal.innerText = qty;
            } else {
                btnAdd.style.display = 'block';
                qtyCounter.style.display = 'none';
            }
        };

        window.toggleGridVariantDropdown = function (productId) {
            // Close others
            document.querySelectorAll('.variant-dropdown-list').forEach(el => {
                if (el.id !== `var-list-${productId}`) el.style.display = 'none';
            });

            const list = document.getElementById(`var-list-${productId}`);
            if (list) {
                list.style.display = (list.style.display === 'none' || list.style.display === '') ? 'block' : 'none';
            }
        };

        window.selectGridVariant = function (productId, idx) {
            const data = window.getGridCardData(productId);
            if (!data) return;

            // Update State
            data.card.setAttribute('data-current-idx', idx);
            const variant = data.variants[idx];

            // Update UI Labels
            const label = document.getElementById(`var-label-${productId}`);
            if (label) label.innerText = variant.quantity;

            const priceEl = document.getElementById(`price-${productId}`);
            if (priceEl) priceEl.innerText = `‚Çπ${variant.price}`;

            const mrpEl = document.getElementById(`mrp-${productId}`);
            if (mrpEl) {
                if (variant.mrp > variant.price) {
                    mrpEl.style.display = 'inline';
                    mrpEl.innerText = `‚Çπ${variant.mrp}`;
                } else {
                    mrpEl.style.display = 'none';
                }
            }

            const discEl = document.getElementById(`disc-${productId}`);
            if (discEl) {
                if (variant.mrp > variant.price) {
                    const off = Math.round(((variant.mrp - variant.price) / variant.mrp) * 100);
                    discEl.innerText = `${off}% OFF`;
                    discEl.style.display = 'inline-block';
                } else {
                    discEl.style.display = 'none';
                }
            }

            const pkgEl = document.getElementById(`pkg-${productId}`);
            if (pkgEl) {
                pkgEl.innerText = variant.packaging_type || '';
            }

            // --- FEATURE: Image Switching on Grid Card ---
            if (variant.packaging_type) {
                const normalized = variant.packaging_type.toLowerCase().trim();
                const productImages = state.allProductImages || [];
                const matchingImg = productImages.find(img => {
                    if (img.product_id !== productId) return false;
                    const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                    return tags.some(tag => tag.includes(normalized) || normalized.includes(tag));
                });

                if (matchingImg) {
                    const cardImg = data.card.querySelector('.product-image');
                    if (cardImg) {
                        cardImg.src = matchingImg.image_url;
                    }
                }
            }

            // Hide Dropdown
            document.getElementById(`var-list-${productId}`).style.display = 'none';

            // Refresh Buttons (ADD vs Qty) for THIS variant
            window.refreshGridCardUI(productId);
        };

        // Close dropdowns on clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.variant-selector')) {
                document.querySelectorAll('.variant-dropdown-list').forEach(el => el.style.display = 'none');
            }
        });

        // --- View: Product ---
        async function renderProductView(slugOrId, direction = 'fade') {
            // Find product by slug first, then by ID (backwards compatibility)
            let product = state.allProducts.find(p => p.slug === slugOrId);
            if (!product) {
                product = state.allProducts.find(p => p.id == slugOrId);
            }
            if (!product) {
                document.getElementById('app').innerHTML = `
                    <div class="error-state">
                        <div class="error-card">
                            <div class="error-icon" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); color: #2563EB;">
                                <i class="fas fa-search"></i>
                            </div>
                            <h2>Product Not Found</h2>
                            <p>We couldn't find the product you're looking for. It may have been removed or the link is incorrect.</p>
                            <div class="error-actions">
                                <a href="/sales" class="action-btn-pill primary">
                                    <i class="fas fa-store"></i> Browse Products
                                </a>
                                <a href="/" class="action-btn-pill outline">
                                    <i class="fas fa-home"></i> Go Home
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Set global current product for cart actions & share context
            state.currentProduct = product;
            state.detailQty = 1;

            // Update Category Context (for navigation/breadcrumbs)
            const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
            state.currentCategory = catSlug; // Ensure category context is valid
            const category = state.categories.find(c => c.slug === catSlug);

            // Resolve Images
            const productImages = state.allProductImages || [];
            const showcaseImg = productImages.find(img => img.product_id === product.id && img.is_default) || productImages.find(img => img.product_id === product.id);
            const displayImg = showcaseImg?.image_url || product.showcase_image || state.placeholder;

            // 1. Get Product Data & Sort Variants by MRP lowest to highest
            // Standardize variants
            let rawVars = [];
            try {
                rawVars = typeof product.quantity_variants === 'string' ? JSON.parse(product.quantity_variants) : (product.quantity_variants || []);
            } catch (e) { }

            // SORT: Lowest MRP to Highest
            const sortedVariants = [...rawVars].sort((a, b) => {
                const mrpA = Number(a.mrp || a.price) || 0;
                const mrpB = Number(b.mrp || b.price) || 0;
                return mrpA - mrpB;
            });

            // Re-assign sorted variants to a reference if needed
            product.quantity_variants = sortedVariants;
            const defaultV = sortedVariants[0] || { price: product.price, mrp: product.mrp, quantity: product.quantity };

            // Find Prev/Next
            const catProducts = state.allProducts.filter(p => (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === catSlug);
            const currentIdx = catProducts.findIndex(p => p.id === product.id);
            const prev = catProducts[currentIdx - 1] || catProducts[catProducts.length - 1];
            const next = catProducts[currentIdx + 1] || catProducts[0];

            updateHistory(product, displayImg);

            const app = document.getElementById('app');

            // Clean up previous transition classes if any
            app.style.position = '';
            app.style.overflow = '';

            const animationClass = direction === 'right' ? 'slide-in-right' : (direction === 'left' ? 'slide-in-left' : 'fade-in');

            app.innerHTML = `
                <div class="grid-layout slide-container ${animationClass}">
                    <!-- Breadcrumbs + Nav Container -->
                    <div class="breadcrumb-section" style="display:flex; justify-content:space-between; align-items:center; grid-area:bread;">
                        ${window.renderSmartBreadcrumbs(catSlug, product.product_name)}
                        
                        <!-- Navigation (Right on Desktop, Hidden on Mobile) -->
                        <div class="nav-group desktop-only-nav">
                            <a href="/sales/${prev.slug || prev.id}" class="nav-btn-pill prev" data-id="${prev.slug || prev.id}" title="${prev.product_name}" onclick="event.preventDefault(); navigateToProduct('${prev.slug || prev.id}', 'left')"><i class="fas fa-arrow-left"></i> <span>Prev</span></a>
                            <a href="/sales/${next.slug || next.id}" class="nav-btn-pill next" data-id="${next.slug || next.id}" title="${next.product_name}" onclick="event.preventDefault(); navigateToProduct('${next.slug || next.id}', 'right')"><span>Next</span> <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <article class="main-product-area">
                        <!-- Mobile Swipe Hint (replaces prev/next buttons) -->
                        <div class="swipe-hint-row" style="display: flex; justify-content: center; align-items: center; margin-bottom: 5px; padding: 0 10px;">
                            <span class="swipe-hint-text">Photos: Swipe image | Products: Swipe details</span>
                        </div>
                        
                        <div class="gallery-wrapper">
                            <div class="product-gallery" id="productFlipper">
                                ${category?.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}" class="overlay-logo">` : ''}
                                <div class="gallery-inner">
                                    <!-- Front: Image -->
                                    <div class="gallery-front">
                                        <!-- Image Carousel -->
                                        <div class="image-carousel" id="mainCarousel">
                                            <div class="carousel-item">
                                                <img src="${displayImg}" class="carousel-img" alt="${product.product_name}">
                                            </div>
                                        </div>
                                        <!-- Dots -->
                                        <div class="carousel-dots" id="carouselDots"></div>
                                        
                                        <div class="product-disclaimer-overlay">All images are representative, change in colour expected due to variability in ingredients</div>
                                        
                                        <!-- Mobile Variant Dropdown REMOVED FROM GALLERY per user request -->
                                        
                                        <!-- Overlay Action Bar (Add/Qty) - Bottom-Right -->
                                        <div class="card-action-container" onclick="event.stopPropagation()">
                                            <button class="btn-add" id="detailAddBtnOverlay" 
                                                onclick="event.stopPropagation(); window.addToCartFromDetail()">Add</button>
                                            <div class="qty-counter" id="detailQtyCounterOverlay" style="display:none;"
                                                onclick="event.stopPropagation()">
                                                <button onclick="event.stopPropagation(); window.updateDetailQty(-1)">-</button>
                                                <span class="qty-val" id="detailQtyValOverlay" onclick="event.stopPropagation()">1</span>
                                                <button onclick="event.stopPropagation(); window.updateDetailQty(1)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Back: Description -->
                                    <div class="gallery-back">
                                        <h3 style="margin-bottom:15px; color:var(--color-primary-blue);">About Product</h3>
                                        <p>${(product.product_description || 'No description available.').replace(/\n/g, '<br>')}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Toggle Button Below Image (Mobile Only) -->
                            <div class="toggle-btn-container toggle-mobile" style="text-align:center; margin-top:15px; display:none;">
                                <button id="toggleDescriptionBtnMobile" onclick="toggleFlip()" class="action-btn-pill outline toggleDescriptionBtn">
                                    <i class="fas fa-info-circle"></i> About Product
                                </button>
                            </div>

                            
                            <!-- Image Thumbnail Strip (Populated by JS if multiple images exist) -->
                            <div class="image-thumbnail-strip" id="imageThumbnailStrip" style="display:none; margin-top:15px;">
                                <!-- Thumbnails will be injected here -->
                            </div>
                        </div>

                        <script>
                            // Initialize components after HTML is in DOM
                            setTimeout(() => {
                                window.loadProductImageGallery('${product.id}', '${displayImg}', '${product.product_name.replace(/'/g, "\\'")}');
                                window.initProductInteractions();
                                window.updateBreadcrumbScroll();
                            }, 0);
                        <\/script>

                        


    <div class="product-details">
        <div class="details-body">
            ${!category?.sub_brand_logo_url && category?.sub_brand ? `<div
                style="text-transform:uppercase; font-size:0.8rem; font-weight:700; color:var(--text-muted);">
                ${category.sub_brand}</div>` : ''}
            
            <!-- GROUP 1: Name, Telugu Name, Tagline -->
            <div class="detail-group detail-group-name">
                <h1 class="product-title">${product.product_name}</h1>
                <div class="telugu-title">${product.product_name_telugu || ''}</div>
                ${product.product_tagline ? `<div class="product-tagline">${product.product_tagline}</div>` : ''}
            </div>

            <!-- GROUP 2: Price, Variant Dropdown -->
            <div class="detail-group detail-group-price">
                <div class="price-row-container">
                    <div class="price-row">
                        <span class="current-price" id="view-price">‚Çπ${defaultV.price}</span>
                        <span class="mrp-strike" id="view-mrp"
                            style="${defaultV.mrp > defaultV.price ? '' : 'display:none'}">‚Çπ${defaultV.mrp}</span>
                        <span class="discount-badge" id="view-discount"
                            style="${defaultV.mrp > defaultV.price ? '' : 'display:none'}"></span>
                        <div class="packaging-type-inline" id="view-pkg-inline" style="font-size: 0.9rem; color: #64748b; font-weight: 500; display: ${defaultV.mrp > defaultV.price ? 'none' : 'block'};">
                            (${defaultV.packaging_type || ''})
                        </div>
                    </div>
                    <div class="packaging-type-block" id="view-pkg-block" style="font-size: 0.9rem; color: #64748b; font-weight: 500; display: ${defaultV.mrp > defaultV.price ? 'block' : 'none'};">
                        (${defaultV.packaging_type || ''})
                    </div>
                </div>

                <!-- Mobile Variant Selector -->
                <div class="mobile-variant-container" id="mobileVariantContainer" style="display:none;">
                    <div class="mobile-variant-trigger" id="mobileVariantTrigger" onclick="window.openMobileVariantDropdown(this)">
                        <span class="mv-label" id="mobileVariantLabel">Select Variant</span>
                        <i class="fas fa-caret-down"></i>
                    </div>
                </div>

                <!-- Variant Selection (Desktop) -->
                <div class="selection-area">
                    ${renderVariants(product)}
                </div>
            </div>

            <!-- GROUP 3: About Product Button, Info Tabs -->
            <div class="detail-group detail-group-actions">
                <!-- About Product Toggle Button (Desktop Only) -->
                <div class="toggle-btn-container toggle-desktop">
                    <button id="toggleDescriptionBtnDesktop" onclick="toggleFlip()" class="action-btn-pill outline toggleDescriptionBtn">
                        <i class="fas fa-info-circle"></i> About Product
                    </button>
                </div>

                <div class="info-tabs">
                    <div class="info-toggles" id="tabs-buttons">
                        <!-- Buttons injected here -->
                    </div>
                    <div class="info-content-wrapper">
                        <div id="ingredients-content" class="info-content-block"></div>
                        <div id="nutrition-content" class="info-content-block"></div>
                        <div id="usage-content" class="info-content-block"></div>
                        <div id="shelf-life-content" class="info-content-block"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </article>

    <!-- Sidebar -->
    <aside class="sidebar">
        <section class="sidebar-card">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="similar" onclick="window.switchSidebarTab('similar')">Similar</div>
                <div class="sidebar-tab" data-tab="trending" onclick="window.switchSidebarTab('trending')">Trending</div>
            </div>
            <div id="side-content">
                ${renderVerticalItems(getSimilarProducts(product))}
            </div>
        </section>
    </aside>

    <!-- Recent Section -->
    <section class="recent-section">
        <h3 style="margin-bottom:20px;">Recently Viewed</h3>
        <div class="recent-grid">
            ${renderHistoryItems()}
        </div>
    </section>
    </div>
    `;

            initProductInteractions(product);
            window.initSwipeNavigation();
            window.initImageZoom();

            // Load product images gallery (multi-image support)
            loadProductImageGallery(product.id, displayImg);

            // Final Sync (After all components are ready)
            if (window.syncDetailPageCart) {
                const vars = typeof product.quantity_variants === 'string' ? JSON.parse(product.quantity_variants) : (product.quantity_variants || []);
                window.syncDetailPageCart(vars[0]);
            }
        }

        // --- Product Image Gallery ---
        // --- Product Image Gallery ---
        window.loadProductImageGallery = async function (productId, fallbackImage, productName = '') {
            const thumbnailStrip = document.getElementById('imageThumbnailStrip');
            const mainCarousel = document.getElementById('mainCarousel'); // NEW
            const dotsContainer = document.getElementById('carouselDots'); // NEW

            if (!thumbnailStrip || !mainCarousel) return;

            try {
                // Fetch images from product_images table
                const { data: images, error } = await supabase
                    .from('product_images')
                    .select('*')
                    .eq('product_id', productId)
                    .order('display_order', { ascending: true });

                if (error) {
                    // console.warn('Could not load product images:', error);
                    return;
                }

                // Filter: Only show images that have TAGS
                let visibleImages = images.filter(img => img.tags && img.tags.length > 0);

                // --- CUSTOM SORTING LOGIC ---
                // Order: 1. fallbackImage (current display) 2. Default tag 3. Glass tag 4. Standup tag 5. Nutrition tag 6. Rest
                visibleImages.sort((a, b) => {
                    const getRank = (img) => {
                        if (img.image_url === fallbackImage) return -1;
                        const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                        if (tags.some(t => t.includes('glass jar'))) return 0;
                        if (tags.some(t => t.includes('standup'))) return 1;
                        if (tags.some(t => t.includes('pet jar'))) return 2;
                        if (tags.some(t => t.includes('nutrition'))) return 3;
                        if (tags.some(t => t === 'default')) return 4;
                        return 10;
                        return 10;
                    };
                    const rankA = getRank(a);
                    const rankB = getRank(b);
                    if (rankA !== rankB) return rankA - rankB;
                    // Tie-breaker: use original display_order from DB
                    return (a.display_order || 0) - (b.display_order || 0);
                });

                // If no visible images, keep default static image (already in HTML) but hide strips
                if (!visibleImages || visibleImages.length === 0) {
                    thumbnailStrip.style.display = 'none';
                    if (dotsContainer) dotsContainer.style.display = 'none';
                    return;
                }

                // --- 1. POPULATE CAROUSEL ---
                // We always repopulate to ensure correct order and fresh state
                mainCarousel.innerHTML = visibleImages.map((img, idx) => `
                    <div class="carousel-item" id="slide-${idx}">
                         <img src="${img.image_url}" class="carousel-img" alt="Product view ${idx + 1}"
                              onerror="window.handleProductImageError(this, '${productId}', '${fallbackImage}')">
                    </div>
                `).join('');

                // --- 2. POPULATE DOTS ---
                if (dotsContainer) {
                    if (visibleImages.length > 1) {
                        dotsContainer.style.display = 'flex';
                        dotsContainer.innerHTML = visibleImages.map((_, idx) => `
                            <div class="carousel-dot ${idx === 0 ? 'active' : ''}" data-idx="${idx}"></div>
                        `).join('');
                    } else {
                        dotsContainer.style.display = 'none';
                        dotsContainer.innerHTML = '';
                    }
                }

                // --- 3. POPULATE THUMBNAILS (Desktop) ---
                thumbnailStrip.style.display = 'flex';
                // Use passed productName or fallback to global state
                const pName = productName || state.currentProduct?.product_name || '';
                thumbnailStrip.innerHTML = visibleImages.map((img, idx) => {
                    const tag = (img.tags && img.tags.length > 0) ? img.tags[0] : '';
                    const fullLabel = tag ? `${pName} - ${tag}` : pName;
                    return `
                        <div class="image-thumb ${idx === 0 ? 'active' : ''}" 
                             id="thumb-${idx}"
                             onclick="window.scrollToSlide(${idx})"
                             data-idx="${idx}">
                            <img src="${img.image_url}" alt="Product view ${idx + 1}" loading="lazy"
                                 onerror="this.parentElement.style.display='none'">
                            <span class="thumb-tag">${tag}</span>
                            <span class="dot-label">${fullLabel}</span>
                        </div>
                    `;
                }).join('');

                // Store global images for external logic
                window._productImages = visibleImages;

                // Function to update UI visibility based on active image tags
                window.updateUIVisibilityByTags = function (idx) {
                    const img = visibleImages[idx];
                    if (!img) return;

                    const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                    const isNutrition = tags.some(t => t.includes('nutrition'));

                    // Toggle Dot Mode Class
                    if (thumbnailStrip) {
                        thumbnailStrip.classList.toggle('nutrition-active', isNutrition);
                    }

                    // 1. Hide/Show Overlay Logo (Sub-brand text/logo)
                    const overlayLogo = document.querySelector('.overlay-logo');
                    if (overlayLogo) {
                        overlayLogo.style.opacity = isNutrition ? '0' : '1';
                        overlayLogo.style.pointerEvents = isNutrition ? 'none' : 'auto';
                    }

                    // 2. Hide/Show Add-to-Cart Buttons Overlay
                    const actionContainer = document.querySelector('.gallery-front .card-action-container');
                    if (actionContainer) {
                        actionContainer.style.opacity = isNutrition ? '0' : '1';
                        actionContainer.style.pointerEvents = isNutrition ? 'none' : 'auto';
                    }

                    // 3. Desktop Thumbnails: Always flex on desktop (Dot Mode handled by CSS)
                    const isDesktop = window.innerWidth >= 1024;
                    if (isDesktop && thumbnailStrip) {
                        thumbnailStrip.style.display = 'flex';
                    } else if (thumbnailStrip) {
                        thumbnailStrip.style.display = 'none'; // Keep hidden on mobile
                    }
                };

                // Initial visibility check
                window.updateUIVisibilityByTags(0);


                // --- 4. CAROUSEL EVENTS (Stop Propagation) ---
                ['touchstart', 'touchmove', 'touchend'].forEach(evt => {
                    mainCarousel.addEventListener(evt, (e) => e.stopPropagation(), { padding: true });
                });

                // --- 5. DOT SYNC ON SCROLL ---
                let scrollTimeout;
                mainCarousel.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const scrollLeft = mainCarousel.scrollLeft;
                        const width = mainCarousel.clientWidth;
                        const idx = Math.round(scrollLeft / width);

                        // Update Dots
                        if (dotsContainer) {
                            const dots = dotsContainer.children;
                            for (let i = 0; i < dots.length; i++) {
                                dots[i].classList.toggle('active', i === idx);
                            }
                        }
                        // Update Thumbnails
                        const thumbs = thumbnailStrip.children;
                        for (let i = 0; i < thumbs.length; i++) {
                            thumbs[i].classList.toggle('active', i === idx);
                        }

                        // Update UI Visibility
                        if (window.updateUIVisibilityByTags) {
                            const scrollLeft = mainCarousel.scrollLeft;
                            const width = mainCarousel.clientWidth;
                            const idx = Math.round(scrollLeft / width);
                            window.updateUIVisibilityByTags(idx);
                        }
                    }, 50);
                });

                // Prioritize Default Image if exists
                const defaultIdx = visibleImages.findIndex(i => i.is_default);
                if (defaultIdx > 0) {
                    // Scroll to it immediately
                    setTimeout(() => window.scrollToSlide(defaultIdx), 100);
                }

            } catch (e) {
                console.warn('Error loading product gallery:', e);
            }
        }

        // Helper: Handle Broken Images in Gallery
        window.handleProductImageError = function (imgEl, productId, fallbackImage) {
            const item = imgEl.closest('.carousel-item');
            if (!item) return;

            const idx = item.id.replace('slide-', '');
            const dot = document.querySelector(`.carousel-dot[data-idx="${idx}"]`);
            const thumb = document.getElementById(`thumb-${idx}`);

            // Remove/Hide broken elements
            item.remove();
            if (dot) dot.remove();
            if (thumb) thumb.style.display = 'none';

            // Check if gallery is now empty
            const carousel = document.getElementById('mainCarousel');
            if (carousel && carousel.querySelectorAll('.carousel-item').length === 0) {
                const finalFallback = fallbackImage || state.placeholder;
                carousel.innerHTML = `
                    <div class="carousel-item" id="slide-error-fallback">
                        <img src="${finalFallback}" class="carousel-img" alt="Product image placeholder"
                             onerror="this.src='${state.placeholder}'">
                    </div>
                `;
                document.getElementById('carouselDots').style.display = 'none';
                document.getElementById('imageThumbnailStrip').style.display = 'none';
            } else {
                // Update dots display if only 1 image remains
                const dots = document.getElementById('carouselDots');
                if (dots && dots.querySelectorAll('.carousel-dot').length <= 1) {
                    dots.style.display = 'none';
                }
            }
        };

        // Helper: Scroll to specific slide
        window.scrollToSlide = function (idx) {
            const mainCarousel = document.getElementById('mainCarousel');
            if (!mainCarousel) return;
            const slide = document.getElementById(`slide-${idx}`);
            if (slide) {
                // Smooth scroll
                slide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
            }
        };

        // Switch image based on variant packaging type  
        window.switchImageByPackaging = function (packagingType) {
            if (!packagingType || !window._productImages) return;

            // Normalize for matching
            const normalized = packagingType.toLowerCase().trim();

            const idx = window._productImages.findIndex(img => {
                const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                return tags.some(tag => tag.includes(normalized) || normalized.includes(tag));
            });

            if (idx > -1) {
                window.scrollToSlide(idx);
            }
        };

        // Deprecated: selectProductImage (Replaced by scrollToSlide)
        window.selectProductImage = function (imageUrl, thumbEl) {
            // Backward compat or no-op
        };


        // --- Helpers: Components ---
        function renderVariants(p) {
            const variants = window.getSortedVariants(p);

            if (variants.length === 0) return '';

            if (variants.length === 1) {
                return `<div style="color:var(--text-secondary); font-size: 0.95rem; display:flex; flex-direction:column;">
                    <strong>Pack Size:</strong> 
                    <span style="font-size:0.9rem;">${variants[0].quantity} ${variants[0].packaging_type ? `<span class="variant-pkg" style="display:inline; margin-left:4px;">(${variants[0].packaging_type})</span>` : ''}</span>
                </div>`;
            }

            // Default to first variant label
            const activeV = variants[0];
            const label = `<span class="variant-qty">${activeV.quantity}</span>${activeV.packaging_type ? `<span class="variant-pkg" style="display:inline; margin-left:4px;">(${activeV.packaging_type})</span>` : ''} - ‚Çπ${activeV.price}`;

            // Store variants in window for dropdown access
            window._currentVariants = variants;

            return `
            <div class="variant-select-wrapper">
                <div class="variant-trigger" id="variantTrigger" onclick="event.stopPropagation(); window.openVariantDropdown(this)">
                    <span id="variantLabel">${label}</span>
                    <i class="fas fa-chevron-down" style="font-size:0.8rem; opacity:0.7;"></i>
                </div>
            </div>
            `;
        }

        function initProductInteractions(p) {
            console.log('Product Data for Tabs:', { name: p.product_name, shelf_life: p.shelf_life, is_refrigerated: p.is_refrigerated });
            const variants = window.getSortedVariants(p);

            // Initialize Mobile Variant Trigger (Custom dropdown)
            const mobileVariantLabel = document.getElementById('mobileVariantLabel');
            const mobileVarContainer = document.getElementById('mobileVariantContainer');

            if (variants.length > 1 && mobileVariantLabel) {
                // Multiple variants - show dropdown with first variant selected
                const defaultV = variants[0];
                mobileVariantLabel.innerHTML = `<span class="variant-qty">${defaultV.quantity}</span>${defaultV.packaging_type ? `<span class="variant-pkg" style="display:inline; margin-left:4px;">(${defaultV.packaging_type})</span>` : ''} <span style="font-weight:700;">‚Çπ${defaultV.price}</span>`;
                window._mobileActiveVariantIdx = 0;
                window._currentVariants = variants;

                // FORCE DISPLAY: RELY ON CSS MEDIA QUERY instead of inline style
                // This prevents it from showing on desktop
                if (mobileVarContainer) {
                    mobileVarContainer.removeAttribute('style'); // Clear inline "display: none" if present
                }
            } else if (mobileVarContainer) {
                // Single or no variants - FORCE hide the dropdown
                mobileVarContainer.style.setProperty('display', 'none', 'important');
            }

            let activeVariantIdx = 0;
            window._detailActiveVariantIdx = 0; // Global state for cart sync

            const updatePrice = (v) => {
                const hasDiscount = v.mrp && v.mrp > v.price;
                document.getElementById('view-price').innerText = '‚Çπ' + v.price;
                const mrpEl = document.getElementById('view-mrp');
                const discEl = document.getElementById('view-discount');
                if (hasDiscount) {
                    mrpEl.innerText = '‚Çπ' + v.mrp;
                    mrpEl.style.display = 'inline';
                    const off = Math.round(((v.mrp - v.price) / v.mrp) * 100);
                    discEl.innerText = off + '% OFF';
                    discEl.style.display = 'inline-block';
                } else {
                    mrpEl.style.display = 'none';
                    discEl.style.display = 'none';
                }

                // Update Packaging Display
                const pkgInline = document.getElementById('view-pkg-inline');
                const pkgBlock = document.getElementById('view-pkg-block');
                const pkgLabel = v.packaging_type ? `(${v.packaging_type})` : '';

                if (pkgInline) {
                    pkgInline.innerText = pkgLabel;
                    pkgInline.style.display = hasDiscount ? 'none' : (pkgLabel ? 'block' : 'none');
                }
                if (pkgBlock) {
                    pkgBlock.innerText = pkgLabel;
                    pkgBlock.style.display = hasDiscount ? (pkgLabel ? 'block' : 'none') : 'none';
                }
            };

            window.openVariantDropdown = function (triggerEl) {
                const variants = window._currentVariants;
                if (!variants || !variants.length) return;

                const existing = document.getElementById('variant-portal-dropdown');
                if (existing) {
                    existing.remove();
                    return;
                }

                const menu = document.createElement('div');
                menu.id = 'variant-portal-dropdown';
                menu.className = 'variant-portal-menu';

                menu.innerHTML = variants.map((v, i) => `
                    <div class="variant-portal-item ${i === activeVariantIdx ? 'active' : ''}" 
                         onclick="window.handleVariantClick(${i})" style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px;">
                        <div class="variant-info">
                            <span class="variant-qty">${v.quantity}</span>
                            ${v.packaging_type ? `<span class="variant-pkg">${v.packaging_type}</span>` : ''}
                        </div>
                        <span class="var-price" style="font-weight:700;">‚Çπ${v.price}</span>
                    </div>
                `).join('');

                document.body.appendChild(menu);

                const rect = triggerEl.getBoundingClientRect();
                menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                menu.style.left = (rect.left + window.scrollX) + 'px';
                menu.style.width = rect.width + 'px';

                requestAnimationFrame(() => menu.classList.add('open'));

                const closeHandler = (e) => {
                    if (!menu.contains(e.target) && !triggerEl.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeHandler), 0);
            };

            window.handleVariantClick = function (idx) {
                const variants = window._currentVariants;
                if (!variants || !variants[idx]) return;

                activeVariantIdx = idx;
                window._detailActiveVariantIdx = idx; // Update global state
                const v = variants[idx];
                const labelEl = document.getElementById('variantLabel');
                if (labelEl) labelEl.innerHTML = `<span class="variant-qty">${v.quantity}</span>${v.packaging_type ? `<span class="variant-pkg" style="display:inline; margin-left:4px;">(${v.packaging_type})</span>` : ''} - ‚Çπ${v.price}`;

                updatePrice(v);
                window.syncDetailPageCart(v);

                // Switch product image to match variant packaging (if tagged image exists)
                if (v.packaging_type && window.switchImageByPackaging) {
                    window.switchImageByPackaging(v.packaging_type);
                }

                // Sync mobile dropdown
                const mobileSelect = document.getElementById('mobileVariantSelect');
                if (mobileSelect) mobileSelect.value = idx;

                // Update Nutrition if toggle logic exists
                const nutContent = document.getElementById('nutrition-content');
                if (nutContent && nutritionData) {
                    nutContent.innerHTML = renderNutrition(nutritionData, v);
                }

                const menu = document.getElementById('variant-portal-dropdown');
                if (menu) menu.remove();
            };

            // Mobile Variant Portal Dropdown
            window.openMobileVariantDropdown = function (triggerEl) {
                const variants = window._currentVariants;
                if (!variants || variants.length <= 1) return;

                // Close existing if any
                const existing = document.getElementById('mv-portal-dropdown');
                if (existing) {
                    existing.remove();
                    return;
                }

                // Create portal menu
                const menu = document.createElement('div');
                menu.id = 'mv-portal-dropdown';
                menu.className = 'mv-portal-menu';

                const activeIdx = window._mobileActiveVariantIdx || 0;

                menu.innerHTML = variants.map((v, i) => `
                    <div class="mv-portal-item ${i === activeIdx ? 'active' : ''}" 
                         onclick="window.handleMobileVariantSelect(${i})" style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px;">
                        <div class="variant-info">
                            <span class="variant-qty">${v.quantity}</span>
                            ${v.packaging_type ? `<span class="variant-pkg">${v.packaging_type}</span>` : ''}
                        </div>
                        <span class="mv-price" style="font-weight:700;">‚Çπ${v.price}</span>
                    </div>
                `).join('');

                document.body.appendChild(menu);

                // Position above the trigger
                const rect = triggerEl.getBoundingClientRect();
                menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                menu.style.left = rect.left + 'px';

                requestAnimationFrame(() => menu.classList.add('open'));

                // Close on click outside
                const closeHandler = (e) => {
                    if (!menu.contains(e.target) && !triggerEl.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeHandler), 0);
            };

            window.handleMobileVariantSelect = function (idx) {
                const variants = window._currentVariants;
                if (!variants || !variants[idx]) return;

                window._mobileActiveVariantIdx = idx;
                const v = variants[idx];

                // Update mobile label
                const label = document.getElementById('mobileVariantLabel');
                if (label) label.innerHTML = `<span class="variant-qty">${v.quantity}</span>${v.packaging_type ? `<span class="variant-pkg" style="display:inline; margin-left:4px;">(${v.packaging_type})</span>` : ''} <span style="font-weight:700;">‚Çπ${v.price}</span>`;

                // Trigger the main variant click handler
                window.handleVariantClick(idx);

                // Close menu
                const menu = document.getElementById('mv-portal-dropdown');
                if (menu) menu.remove();
            };


            // Sync Function is defined globally at window.syncDetailPageCart
            // calling it here to ensure initial state
            if (variants[0]) {
                updatePrice(variants[0]);
                window.syncDetailPageCart(variants[0]);
            }


            // 2. Toggles & Content
            const btnContainer = document.getElementById('tabs-buttons');
            const sections = [];

            // Helper to parsing weight: "250g" -> 250, "1kg" -> 1000
            const parseWeight = (str) => {
                if (!str) return 0;
                const match = str.toLowerCase().match(/([\d\.]+)\s*([a-z]+)/);
                if (!match) return 0;
                let val = parseFloat(match[1]);
                let unit = match[2];
                if (unit === 'kg') val *= 1000;
                return val;
            };

            // --- Feature: Image Zoom (Desktop Hover + Mobile Tap Lightbox) ---
            window.initImageZoom = function () {
                const container = document.getElementById('mainCarousel');
                if (!container) return;

                const isMobile = window.innerWidth < 1024;

                if (isMobile) {
                    // --- MOBILE: Tap to open fullscreen lightbox ---
                    container.style.cursor = 'zoom-in';
                    container.addEventListener('click', function (e) {
                        e.stopPropagation();
                        // Get currently visible item
                        const scrollLeft = container.scrollLeft;
                        const width = container.clientWidth;
                        const idx = Math.round(scrollLeft / width);
                        const slide = document.getElementById(`slide-${idx}`);
                        const img = slide ? slide.querySelector('img') : null;

                        if (img) {
                            window.openImageLightbox(img.src);
                        }
                    });
                } else {
                    // --- DESKTOP: Hover to zoom ---
                    container.style.cursor = 'crosshair';
                    container.addEventListener('mousemove', function (e) {
                        // Find the hovered slide
                        const item = e.target.closest('.carousel-item');
                        if (!item) return;

                        // Prevent zoom when mouse is over the action buttons
                        if (e.target.closest('.card-action-container')) {
                            const activeImgs = container.querySelectorAll('.carousel-img');
                            activeImgs.forEach(i => i.style.transform = 'scale(1)');
                            return;
                        }

                        const img = item.querySelector('.carousel-img');
                        if (!img) return;

                        const rect = item.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        let xPercent = Math.max(0, Math.min(100, (x / rect.width) * 100));
                        let yPercent = Math.max(0, Math.min(100, (y / rect.height) * 100));

                        img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
                        img.style.transform = 'scale(2.5)';
                        img.parentElement.style.zIndex = '10'; // Ensure active slide is on top if needed
                    });

                    container.addEventListener('mouseleave', function () {
                        const imgs = container.querySelectorAll('.carousel-img');
                        imgs.forEach(img => {
                            img.style.transform = 'scale(1)';
                            setTimeout(() => { img.style.transformOrigin = 'center center'; }, 100);
                        });
                    });
                }
            };

            // --- Lightbox: Fullscreen Image Viewer ---
            window.openImageLightbox = function (src) {
                // Create overlay if not exists
                let overlay = document.getElementById('imageLightbox');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'imageLightbox';
                    overlay.innerHTML = `
                        <div class="lightbox-backdrop"></div>
                        <div class="lightbox-content">
                            <img src="" alt="Product Image" class="lightbox-img">
                            <button class="lightbox-close" aria-label="Close">&times;</button>
                        </div>
                    `;
                    document.body.appendChild(overlay);

                    // Close handlers
                    overlay.querySelector('.lightbox-backdrop').addEventListener('click', window.closeImageLightbox);
                    overlay.querySelector('.lightbox-close').addEventListener('click', window.closeImageLightbox);

                    // Pinch zoom support using CSS transform
                    let scale = 1;
                    let startDistance = 0;
                    const lightboxImg = overlay.querySelector('.lightbox-img');

                    lightboxImg.addEventListener('touchstart', function (e) {
                        if (e.touches.length === 2) {
                            startDistance = Math.hypot(
                                e.touches[0].pageX - e.touches[1].pageX,
                                e.touches[0].pageY - e.touches[1].pageY
                            );
                        }
                    }, { passive: true });

                    lightboxImg.addEventListener('touchmove', function (e) {
                        if (e.touches.length === 2) {
                            const currentDistance = Math.hypot(
                                e.touches[0].pageX - e.touches[1].pageX,
                                e.touches[0].pageY - e.touches[1].pageY
                            );
                            scale = Math.min(3, Math.max(1, scale * (currentDistance / startDistance)));
                            startDistance = currentDistance;
                            lightboxImg.style.transform = `scale(${scale})`;
                        }
                    }, { passive: true });

                    lightboxImg.addEventListener('touchend', function (e) {
                        if (e.touches.length === 0) {
                            // Reset scale on release
                            scale = 1;
                            lightboxImg.style.transform = 'scale(1)';
                        }
                    });
                }

                // Set image and show
                overlay.querySelector('.lightbox-img').src = src;
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            };

            window.closeImageLightbox = function () {
                const overlay = document.getElementById('imageLightbox');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            };

            console.log(`[Use By Final Check] Product: ${p.product_name}`);
            console.log(`[Use By Final Check] Available Keys:`, Object.keys(p));
            console.log(`[Use By Final Check] shelf_life prop:`, p.shelf_life);

            // Nutrition - parse first since it's needed for the first tab
            let nutritionData = null;
            if (p.nutrition_info) {
                try { nutritionData = typeof p.nutrition_info === 'string' ? JSON.parse(p.nutrition_info) : p.nutrition_info; }
                catch (e) { }
            }

            const renderNutrition = (nData, currentVariant) => {
                if (!nData) return '';

                // Normalize Keys (Handle legacy/different formats)
                const getVal = (keys) => {
                    if (!Array.isArray(keys)) keys = [keys];
                    for (const k of keys) {
                        if (nData[k] !== undefined && nData[k] !== null && nData[k] !== '') return nData[k];
                    }
                    return null;
                };

                const servingSize = getVal(['serving_size', 'servingSize']);
                const totalServings = getVal(['total_servings', 'totalServings']);

                // Field Mapping for actual nutrition data
                const fields = [
                    { k: ['calories', 'Calories'], label: 'Calories' },
                    { k: ['protein', 'Protein'], label: 'Protein' },
                    { k: ['total_fat', 'fat', 'Total Fat', 'Fat'], label: 'Fat' },
                    { k: ['carbs', 'Carbs'], label: 'Carbs' },
                    { k: ['fiber', 'Fiber'], label: 'Fiber' },
                    { k: ['sugars', 'sugar', 'Sugars'], label: 'Sugar' },
                    { k: ['sodium', 'Sodium'], label: 'Sodium' }
                ];

                // 1. Check if ACTUAL nutrition data exists (not just serving info)
                const hasActualNutritionData = fields.some(f => getVal(f.k) !== null);

                // Build inline text with separators
                const items = [];

                // 2. Only calculate/show servings if actual nutrition data exists
                if (hasActualNutritionData) {
                    if (servingSize) items.push(`<strong>Serving:</strong> ${servingSize}`);

                    // Calculate Servings per pack from variant
                    let displayedServings = null;
                    if (currentVariant && currentVariant.quantity && servingSize) {
                        const packWeight = parseWeight(currentVariant.quantity);
                        const sSize = parseWeight(servingSize);
                        if (packWeight > 0 && sSize > 0) {
                            displayedServings = Math.round(packWeight / sSize);
                        }
                    }
                    // Fallback to totalServings if calculation failed
                    if (!displayedServings && totalServings) {
                        displayedServings = totalServings;
                    }

                    if (displayedServings) items.push(`<strong>~${displayedServings} servings</strong>`);
                }

                // Add nutrition fields
                fields.forEach(f => {
                    const val = getVal(f.k);
                    if (val !== null) {
                        items.push(`<strong>${f.label}:</strong> ${val}`);
                    }
                });

                // 3. If no items to show, return empty
                if (items.length === 0) return '';

                // Return as inline wrapped text with comma separators
                return `<p style="color:var(--text-secondary); margin:0; text-align:justify;">${items.join(', ')}</p>`;
            };

            // Count actual nutrition values (not serving info)
            const nutritionFieldKeys = ['calories', 'Calories', 'protein', 'Protein', 'total_fat', 'fat', 'Fat', 'carbs', 'Carbs', 'fiber', 'Fiber', 'sugars', 'sugar', 'Sugars', 'sodium', 'Sodium'];
            const actualNutritionCount = nutritionData ? nutritionFieldKeys.filter(k =>
                nutritionData[k] !== undefined && nutritionData[k] !== null && nutritionData[k] !== ''
            ).length : 0;

            // === BUILD SECTIONS IN ORDER: Nutrition, Usage, Ingredients, Use By ===

            // 1. Nutrition (first tab)
            if (actualNutritionCount > 0) {
                sections.push({
                    id: 'nut',
                    label: 'Nutrition',
                    icon: 'fas fa-heartbeat',
                    target: 'nutrition-content',
                    html: renderNutrition(nutritionData, variants[0])
                });
            }

            // 2. Usage
            if (p.serving_suggestion) {
                sections.push({
                    id: 'use', label: 'Usage', icon: 'fas fa-utensils', target: 'usage-content', html: `<p style="text-align:justify;">
            ${p.serving_suggestion}</p>`
                });
            }

            // 3. Ingredients
            if (p.ingredients) {
                sections.push({
                    id: 'ing', label: 'Ingredients', icon: 'fas fa-carrot', target: 'ingredients-content', html: `
        <p style="text-align:justify;">${p.ingredients}</p>`
                });
            }

            // 4. Use By (Shelf Life)
            if (p.shelf_life && p.shelf_life.toString().trim() !== '') {
                let shelfText = `<p style="text-align:justify; margin:0;">The product is best consumed within <strong>${p.shelf_life}</strong> days from the date of packing.</p>`;

                // Refrigeration Alert Append (Visual Icon/Box)
                if (p.is_refrigerated) {
                    shelfText += `<div style="margin-top:6px; padding:6px 10px; background:#e0f2fe; border-left:4px solid #0284c7; border-radius:4px; color:#0c4a6e; font-size:0.85em; line-height:1.2;">
                        <i class="fas fa-snowflake"></i> <strong>Note:</strong> Refrigeration Required.
                    </div>`;
                }

                sections.push({
                    id: 'shelf', label: 'Use By', icon: 'fas fa-history', target: 'shelf-life-content', html: shelfText
                });
            }

            // Render Buttons & Inject Content
            if (btnContainer) {
                btnContainer.className = 'info-btns-row'; // Use standard CSS class
                btnContainer.innerHTML = sections.map(s =>
                    `<button class="info-btn" id="btn-${s.id}" data-target="${s.target}">
                        <i class="${s.icon}" style="margin-right:5px;"></i>
                        <span class="bt-txt">${s.label}</span>
                    </button>`
                ).join('');

                sections.forEach(s => {
                    const el = document.getElementById(s.target);
                    if (el) el.innerHTML = s.html;
                });

                // Add Toggle Logic
                // Local adjustFontSize removed in favor of window.adjustFontSize


                // Pre-adjust ALL tab contents immediately
                sections.forEach(s => {
                    const el = document.getElementById(s.target);
                    if (el) {
                        el.innerHTML = s.html;
                        // Important: el must have its styles (like padding) to measure scrollHeight correctly
                        // We run it after a tiny delay to ensure DOM is ready
                        // setTimeout(() => window.adjustFontSize(el), 50);
                    }
                });

                btnContainer.onclick = (e) => {
                    const btn = e.target.closest('.info-btn');
                    if (!btn) return;

                    const targetId = btn.dataset.target;
                    const contentDiv = document.getElementById(targetId);

                    const wasActive = btn.classList.contains('active');

                    // Close ALL
                    document.querySelectorAll('.info-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.info-content-block').forEach(d => d.classList.remove('active'));

                    if (!wasActive) {
                        btn.classList.add('active');
                        contentDiv.classList.add('active');
                        // Just call adjustFontSize - it will use cached value if available
                        // window.adjustFontSize(contentDiv);
                    }
                };
            }


            // Initialize sidebar tab switcher
            window.switchSidebarTab = function (mode) {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                const activeTab = document.querySelector(`.sidebar-tab[data-tab="${mode}"]`);
                if (activeTab) activeTab.classList.add('active');

                const sideContent = document.getElementById('side-content');
                if (sideContent) {
                    sideContent.innerHTML = renderVerticalItems(mode === 'similar' ?
                        getSimilarProducts(p) : state.allProducts.filter(x => x.is_trending));
                }
            };

            // Auto-activate default tab (Nutrition if available, else first available)
            setTimeout(() => {
                if (!btnContainer) return;
                const nutBtn = document.getElementById('btn-nut');
                const firstBtn = btnContainer.querySelector('.info-btn');
                const activeBtn = nutBtn || firstBtn;
                if (activeBtn) activeBtn.click();
            }, 100);
        }

        // --- Logic: Data Helpers ---
        function getSimilarProducts(target) {
            return state.allProducts
                .filter(p => p.id !== target.id)
                .map(p => {
                    const isSameCat = p.product_category === target.product_category;
                    return { ...p, score: isSameCat ? 1 : 0 };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
        }

        function renderVerticalItems(items) {
            if (!items || !items.length) return `<p style="text-align:center; padding:20px; color:var(--text-muted)">No items found.</p>`;
            return items.map((item, index) => {
                // Use sorted variants (default-tag-matching first)
                const sortedVariants = window.getSortedVariants(item);
                const firstVariant = sortedVariants[0] || {};
                const variantLabel = firstVariant.quantity || '';
                const displayPrice = firstVariant.price || item.price || item.mrp || '';

                // Check Cart State
                const cartList = state.cart || [];
                const cartItem = cartList.find(c => c.id == item.id &&
                    (c.variant ? c.variant.quantity === firstVariant.quantity : true)
                );
                const qty = cartItem ? cartItem.qty : 0;

                const escapedProduct = JSON.stringify(item).replace(/'/g, "&apos;");
                const escapedVariant = JSON.stringify(firstVariant).replace(/'/g, "&apos;");

                return `
        <div class="sim-item" data-product-id="${item.id}" data-product='${escapedProduct}' data-variant='${escapedVariant}' onclick="window.location.href='/sales/${item.slug || item.id}'" style="cursor:pointer;">
            <img src="${(state.allProductImages || []).find(img => img.product_id === item.id && img.is_default)?.image_url || (state.allProductImages || []).find(img => img.product_id === item.id)?.image_url || item.showcase_image || state.placeholder}" class="sim-img"
                onerror="this.src='${state.placeholder}'">
            <div class="sim-info">
                <h4 style="font-size:0.9rem; margin:0; line-height:1.2; cursor:pointer;" onclick="window.location.href='/sales/${item.slug || item.id}'">${item.product_name}</h4>
                ${item.product_tagline ? `<span style="font-size:0.75rem; color:var(--text-secondary); display:block; margin:2px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.product_tagline}</span>` : ''}
                <!-- Price + Add Button inline -->
                <div class="price-action-row" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:4px;">
                    <span style="font-size:0.8rem; font-weight:700; color:var(--color-primary-blue);">‚Çπ${displayPrice} ${variantLabel ? `<span style="font-size:0.75em; font-weight:500; opacity:0.8;">(${variantLabel})</span>` : ''}</span>
                    <!-- Add Button -->
                    <button class="btn-add sidebar-add-btn" id="sidebar-add-${index}" onclick="event.stopPropagation(); showSidebarQty(${index})" style="${qty > 0 ? 'display:none;' : 'display:block;'}">Add</button>
                    <!-- Quantity Controls -->
                    <div class="qty-counter sidebar-qty-controls ${qty > 0 ? 'show' : ''}" id="sidebar-qty-wrap-${index}" style="${qty > 0 ? 'display:flex;' : 'display:none;'}">
                        <button onclick="event.stopPropagation(); updateSidebarQty(${index}, -1)">‚àí</button>
                        <span class="qty-val" id="sidebar-qty-${index}">${qty || 1}</span>
                        <button onclick="event.stopPropagation(); updateSidebarQty(${index}, 1)">+</button>
                    </div>
                </div>
            </div>
        </div>
        `;
            }).join('');
        }

        // Show quantity controls and add first item to cart
        window.showSidebarQty = function (index) {
            const addBtn = document.getElementById('sidebar-add-' + index);
            const qtyWrap = document.getElementById('sidebar-qty-wrap-' + index);
            if (addBtn) addBtn.style.display = 'none';
            if (qtyWrap) qtyWrap.classList.add('show');

            // Add 1 to cart immediately
            updateSidebarQty(index, 0, true);
        };

        // Sidebar quantity helper with cart integration
        window.updateSidebarQty = function (index, delta, isInit = false) {
            const qtyEl = document.getElementById('sidebar-qty-' + index);
            const addBtn = document.getElementById('sidebar-add-' + index);
            const qtyWrap = document.getElementById('sidebar-qty-wrap-' + index);
            if (!qtyEl) return;

            let val = parseInt(qtyEl.innerText) || 0;
            val = isInit ? 1 : Math.max(0, val + delta);
            qtyEl.innerText = val;

            // Get product data and update cart
            const simItem = document.querySelector(`#sidebar-qty-${index}`).closest('.sim-item');
            if (simItem) {
                try {
                    // dataset items are already HTML-decoded by the browser
                    const product = JSON.parse(simItem.dataset.product);
                    const variant = JSON.parse(simItem.dataset.variant);

                    // Find or update cart item
                    const existingIdx = state.cart.findIndex(item =>
                        item.id === product.id &&
                        (item.variant ? item.variant.quantity === variant.quantity : true)
                    );

                    if (val === 0) {
                        if (existingIdx > -1) {
                            state.cart.splice(existingIdx, 1);
                        }
                        if (addBtn) addBtn.style.display = 'block';
                        if (qtyWrap) {
                            qtyWrap.style.display = 'none';
                            qtyWrap.classList.remove('show');
                        }
                    } else {
                        if (existingIdx > -1) {
                            state.cart[existingIdx].qty = val;
                        } else {
                            state.cart.push({
                                id: product.id,
                                name: product.product_name,
                                telugu_name: product.product_name_telugu,
                                price: variant.price || product.price || product.mrp,
                                image: (state.allProductImages || []).find(img => img.product_id === product.id && img.is_default)?.image_url || (state.allProductImages || []).find(img => img.product_id === product.id)?.image_url || product.showcase_image,
                                variant: variant,
                                qty: val
                            });
                        }
                        if (addBtn) addBtn.style.display = 'none';
                        if (qtyWrap) {
                            qtyWrap.style.display = 'flex';
                            qtyWrap.classList.add('show');
                        }
                    }
                    window.saveCart();
                } catch (e) {
                    console.error('Cart update error:', e);
                }
            }
        };

        // Reset sidebar qty for a specific product ID
        function resetSidebarForProduct(productId) {
            document.querySelectorAll('.sim-item').forEach((simItem, index) => {
                if (simItem.dataset.productId == productId) {
                    const addBtn = document.getElementById('sidebar-add-' + index);
                    const qtyWrap = document.getElementById('sidebar-qty-wrap-' + index);
                    const qtyEl = document.getElementById('sidebar-qty-' + index);
                    if (addBtn) addBtn.style.display = 'inline-block';
                    if (qtyWrap) qtyWrap.classList.remove('show');
                    if (qtyEl) qtyEl.innerText = '1';
                }
            });
        }

        // Reset ALL sidebar qty selectors (for clearCart)
        function resetAllSidebarQty() {
            document.querySelectorAll('.sidebar-add-btn').forEach(btn => btn.style.display = 'inline-block');
            document.querySelectorAll('.sidebar-qty-controls').forEach(wrap => wrap.classList.remove('show'));
            document.querySelectorAll('.sidebar-qty-controls .quantity-display').forEach(el => el.innerText = '1');
        }

        function updateHistory(p, resolvedImg) {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            hist = hist.filter(x => x.slug !== p.slug && x.id !== p.id);
            hist.unshift({ id: p.id, slug: p.slug, name: p.product_name, img: resolvedImg || p.showcase_image });
            localStorage.setItem('td_history', JSON.stringify(hist.slice(0, 8)));
        }

        function renderHistoryItems() {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            if (!hist.length) return `<p style="grid-column:1/-1; color:var(--text-muted)">Your viewing history will appear
            here.</p>`;
            return hist.slice(0, 5).map(h => `
        <div class="sim-item" onclick="window.location.href='/sales/${h.slug || h.id}'"
            style="background:var(--bg-primary); border:1px solid var(--border-light); display:flex; align-items:center; gap:10px; padding:5px;">
            <img src="${h.img || state.placeholder}" class="sim-img" style="width:50px; height:50px; object-fit:cover; border-radius:4px; flex-shrink:0;" onerror="this.src='${state.placeholder}'">
            <div class="sim-info" style="min-width:0;">
                <h4 style="font-size:0.85rem; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${h.name}</h4>
                <span style="font-size:0.75rem; color:var(--text-secondary)">View Product</span>
            </div>
        </div>
        `).join('');
        }

        // --- Global Share Function ---
        // NOTE: This functionality is currently NOT used on the Sales Page (no button triggers it).
        // It is kept here for consistency with the Main Page. If needed, add a button calling shareCatalogue().
        window.shareCatalogue = async function () {
            const settings = state.settings || {};
            const catalogueUrl = settings.catalogue_image_url;
            const shareMessage = settings.catalogue_share_message || 'Check out our latest catalogue of delicious treats!';

            if (!catalogueUrl) {
                window.showToast('Catalogue is not available at the moment.', 'error');
                return;
            }

            try {
                // Use pre-loaded file if available
                let file = state.catalogueFile;
                if (!file) {
                    const response = await fetch(catalogueUrl);
                    const blob = await response.blob();
                    file = new File([blob], 'Telugu_Delicacies_Catalogue.jpg', { type: 'image/jpeg' });
                }

                const fileUrl = URL.createObjectURL(file);

                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile && navigator.share) {
                    try {
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'Telugu Delicacies Catalogue',
                                text: shareMessage,
                                files: [file]
                            });
                            return;
                        }
                    } catch (shareErr) {
                        console.error('Mobile file share failed:', shareErr);
                    }
                }

                // Desktop Download + Paste
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = 'Telugu_Delicacies_Catalogue.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Removed Clipboard write attempt to be consistent with script.js (simple Download + Open flow)

                window.showToast('Catalogue downloaded! You can now attach or paste it directly in WhatsApp.', 'success');
                const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(shareMessage)}`;
                window.open(whatsappUrl, '_blank');

            } catch (err) {
                console.error('Sharing failed:', err);
                window.showToast('Could not prepare the catalogue for sharing.', 'error');
            }
        };

        // --- UI Utilities ---
        // --- UI Utilities ---
        window.showToast = function (message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            // Add icon based on type? For now just text
            toast.innerHTML = type === 'success' ? '<i class="fas fa-check-circle" style="color:#4ade80"></i> ' + message : message;

            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Auto dismiss
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000); // 2 seconds
        };

        // --- Cart Functions ---
        window.initCart = function () {
            try {
                const saved = localStorage.getItem('td_cart');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state.cart = Array.isArray(parsed) ? parsed : [];
                }
            } catch (e) {
                console.error('Cart load error', e);
                state.cart = [];
            }
            updateCartUI();
        };

        window.saveCart = function () {
            localStorage.setItem('td_cart', JSON.stringify(state.cart));
            updateCartUI();
        };

        window.toggleCartDrawer = function () {
            const drawer = document.getElementById('cartDrawer');
            const overlay = document.getElementById('cartOverlay');
            if (drawer && overlay) {
                drawer.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        };

        window.updateDetailQty = function (delta) {
            if (!state.currentProduct) return;

            // Get selected variant
            const variants = typeof state.currentProduct.quantity_variants === 'string' ? JSON.parse(state.currentProduct.quantity_variants) : (state.currentProduct.quantity_variants || []);

            let idx = 0;
            if (typeof window._detailActiveVariantIdx === 'number') {
                idx = window._detailActiveVariantIdx;
            } else {
                const select = document.getElementById('variantSelect');
                idx = select ? select.value : 0;
            }
            const variant = variants[idx];

            // Update cart relative to delta
            window.addToCart(state.currentProduct, variant, delta);

            // Sync detail page UI (ADD button vs Qty counter)
            window.syncDetailPageCart(variant);
        };


        // Helper for cart animation
        function animateCartBtn() {
            const btn = document.getElementById('cartBtn');
            if (btn) {
                btn.classList.add('cart-pop');
                setTimeout(() => btn.classList.remove('cart-pop'), 400);
            }
        }

        window.addToCart = function (product, variant, qty) {
            // Hardened Validation: Check existing cart qty + new qty against stock
            const existingIdx = state.cart.findIndex(item =>
                item.id == product.id &&
                (item.variant ? (item.variant.quantity === variant.quantity && (item.variant.packaging_type || '') === (variant.packaging_type || '')) : true)
            );

            const currentCartQty = existingIdx > -1 ? state.cart[existingIdx].qty : 0;
            const maxStock = variant ? (variant.stock || 0) : (product.total_stock || 0);

            // Calculation check
            const targetQty = currentCartQty + qty;

            if (targetQty < 0) {
                // If removing more than we have, just set to 0 (which usually removes it or keeps at min)
                // But normally delta is -1, so targetQty would be at least 0.
                window.showToast('Minimum quantity reached', 'error');
                return;
            }

            if (targetQty > maxStock) {
                if (maxStock <= 0) {
                    window.showToast('Out of Stock', 'error');
                } else {
                    window.showToast(`Cannot add more. Max stock is ${maxStock}. (You have ${currentCartQty} in cart)`, 'error');
                }
                return;
            }

            if (existingIdx > -1) {
                state.cart[existingIdx].qty = targetQty;
                // If 0, handle removal
                if (state.cart[existingIdx].qty === 0) {
                    state.cart.splice(existingIdx, 1);
                    window.showToast('Item removed from cart', 'info');
                }
            } else if (qty > 0) {
                state.cart.push({
                    id: product.id,
                    name: product.product_name,
                    telugu_name: product.product_name_telugu,
                    price: variant ? variant.price : product.mrp,
                    image: (state.allProductImages || []).find(img => img.product_id === product.id && img.is_default)?.image_url || (state.allProductImages || []).find(img => img.product_id === product.id)?.image_url || product.showcase_image,
                    variant: variant,
                    qty: qty
                });
            }

            state.cart = [...state.cart];
            window.saveCart();
            animateCartBtn();
            window.showToast(`${product.product_name} added to cart!`, 'success');
        };

        window.quickAddComboToCart = function (id, name, price, imageUrl) {
            const existingIdx = state.cart.findIndex(item => item.id === id && item.type === 'combo');
            if (existingIdx > -1) {
                state.cart[existingIdx].qty += 1;
            } else {
                state.cart.push({
                    id: id,
                    name: name,
                    price: price,
                    image: imageUrl,
                    type: 'combo',
                    qty: 1
                });
            }
            window.saveCart();
            if (window.updateCartUI) window.updateCartUI();
            if (window.animateCartBtn) window.animateCartBtn();
            window.showToast(`${name} added to cart!`, 'success');
        };

        window.addToCartFromDetail = function () {
            if (!state.currentProduct) return;

            let variants = [];
            try {
                variants = typeof state.currentProduct.quantity_variants === 'string' ?
                    JSON.parse(state.currentProduct.quantity_variants) :
                    (state.currentProduct.quantity_variants || []);
            } catch (e) { }

            let selectedVariant = null;
            if (variants.length > 0) {
                const select = document.getElementById('variantSelect');
                let variantIdx = 0;

                if (typeof window._detailActiveVariantIdx === 'number') {
                    variantIdx = window._detailActiveVariantIdx;
                } else if (select) {
                    variantIdx = parseInt(select.value, 10) || 0;
                } else if (typeof window._mobileActiveVariantIdx === 'number') {
                    // Use mobile portal dropdown selection
                    variantIdx = window._mobileActiveVariantIdx;
                }

                selectedVariant = variants[variantIdx];
            }

            const qtyInput = document.getElementById('detailQty');
            const qty = parseInt(qtyInput ? qtyInput.value : 1) || 1;

            window.addToCart(state.currentProduct, selectedVariant, qty);
            window.syncDetailPageCart(selectedVariant);
        };

        window.updateCartItemQty = function (index, deltaOrVal, isDirect = false) {
            const item = state.cart[index];
            if (!item) return;
            let newQty;

            if (isDirect) {
                newQty = parseInt(deltaOrVal);
                if (isNaN(newQty) || newQty < 1) newQty = 1;
            } else {
                newQty = item.qty + deltaOrVal;
            }

            // Check stock
            const maxStock = item.variant ? (item.variant.stock || 0) : 999;

            if (newQty <= 0) {
                // QUICK COMMERCE PATTERN: Immediate removal + Toast (No confirm dialog)
                const removedId = item.id; // Store ID before removal
                state.cart.splice(index, 1);
                window.saveCart();
                window.showToast('Item removed from cart', 'info');
                // Refresh grid card to show ADD button
                window.refreshGridCardUI(removedId);
            } else if (newQty > maxStock) {
                window.showToast(`Max stock reached (${maxStock})`, 'error');
                item.qty = maxStock;
                window.saveCart();
            } else {
                item.qty = newQty;
                window.saveCart();
            }
        };

        window.syncDetailPageCart = function (selectedVariant = null) {
            if (!state.currentProduct) return;
            const product = state.currentProduct;

            // If specific variant not passed, try to get from UI
            if (!selectedVariant) {
                const variants = typeof product.quantity_variants === 'string' ? JSON.parse(product.quantity_variants) : (product.quantity_variants || []);
                if (variants.length > 0) {
                    let idx = 0;
                    if (typeof window._detailActiveVariantIdx === 'number') {
                        idx = window._detailActiveVariantIdx;
                    } else {
                        const select = document.getElementById('variantSelect');
                        idx = select ? select.value : 0;
                    }
                    selectedVariant = variants[idx];
                }
            }

            // Find in cart
            const cartItem = state.cart.find(item =>
                item.id == product.id &&
                (item.variant && selectedVariant ?
                    (item.variant.quantity === selectedVariant.quantity && (item.variant.packaging_type || '') === (selectedVariant.packaging_type || '')) :
                    true)
            );

            const qty = cartItem ? cartItem.qty : 0;

            const btnAdd = document.getElementById('detailAddBtnOverlay');
            const qtyCounter = document.getElementById('detailQtyCounterOverlay');
            const qtyVal = document.getElementById('detailQtyValOverlay');

            if (btnAdd && qtyCounter && qtyVal) {
                if (qty > 0) {
                    btnAdd.style.display = 'none';
                    qtyCounter.style.display = 'flex';
                    qtyVal.innerText = qty;
                } else {
                    btnAdd.style.display = 'block';
                    qtyCounter.style.display = 'none';
                    // Reset add input to 1?
                    const detailQtyInput = document.getElementById('detailQty');
                    if (detailQtyInput) detailQtyInput.value = 1;
                }
            }
        };

        window.removeItem = function (index) {
            // Get item before removing to reset sidebar
            const item = state.cart[index];

            // Direct removal - no confirm popup
            state.cart.splice(index, 1);
            window.saveCart();
            window.showToast('Item removed from cart', 'success');

            // Reset sidebar for this product if it exists
            if (item) {
                resetSidebarForProduct(item.id);
                // Refresh grid card to show ADD button
                window.refreshGridCardUI(item.id);
                // Sync detail page if it's the same product
                if (window.syncDetailPageCart) window.syncDetailPageCart();
            }
        };

        window.clearCart = function () {
            if (state.cart.length === 0) return;

            // 1. Clear Data
            state.cart = [];
            window.saveCart();

            // 2. Reset Header Badge
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.innerText = '0';
                cartCount.style.display = 'none';
            }

            // 3. VISUAL RESET (The Fix)
            // Restore "ADD" buttons and hide Qty Counters for ALL cards
            document.querySelectorAll('.qty-counter').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.btn-add').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.qty-val').forEach(el => el.innerText = '0');

            // 4. Reset ALL sidebar quantity selectors
            resetAllSidebarQty();

            // 5. Update Cart Drawer UI
            window.updateCartUI();

            // 6. Sync current detail page
            if (window.syncDetailPageCart) window.syncDetailPageCart();

            window.showToast('Cart cleared', 'info');
        };

        window.updateCartUI = function () {
            const cartCount = document.getElementById('mainCartCount');
            const mobileCartCount = document.getElementById('mobileCartCount');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const clearBtn = document.querySelector('.clear-cart-btn');

            // Update Badge (Desktop + Mobile)
            const totalQty = state.cart.reduce((sum, item) => sum + item.qty, 0);
            [cartCount, mobileCartCount].forEach(badge => {
                if (badge) {
                    badge.innerText = totalQty;
                    badge.style.display = totalQty > 0 ? 'flex' : 'none';
                }
            });

            // Show/Hide Clear Button
            if (clearBtn) {
                // Ensure display logic is correct based on cart state
                clearBtn.style.display = state.cart.length > 0 ? 'block' : 'none';
            }

            // Update Drawer
            if (state.cart.length === 0) {
                if (cartItems) cartItems.innerHTML = '<div class="empty-cart-msg">Your cart is empty</div>';
                if (cartTotal) cartTotal.innerText = '0';
                return;
            }

            let total = 0;
            if (cartItems) {
                cartItems.innerHTML = state.cart.map((item, index) => {
                    const itemTotal = item.price * item.qty;
                    total += itemTotal;
                    const variantLabel = item.variant ? `<div class="cart-item-variant">${item.variant.quantity}</div>` : '';

                    // Find the default image for the product
                    const defaultImage = (state.allProductImages || []).find(img => img.product_id === item.id && img.is_default);
                    // If no default, find any image for the product
                    const anyImage = (state.allProductImages || []).find(img => img.product_id === item.id);
                    // Determine the image source
                    const imgSrc = defaultImage?.image_url || anyImage?.image_url || item.image || state.placeholder;

                    return `
                        <div class="cart-item">
                            ${item.type === 'combo' ?
                            `<div class="cart-item-combo-placeholder">
                                    <span>${item.name}</span>
                                </div>` :
                            `<img src="${imgSrc}" alt="${item.name}" onerror="this.src='${state.placeholder}'">`
                        }
                            <div class="cart-item-details">
                                <h4>${item.name}</h4>
                                ${variantLabel}
                                <div class="cart-item-price">‚Çπ${item.price} x ${item.qty} = ‚Çπ${itemTotal}</div>
                                <div class="cart-item-controls">
                                    <button onclick="window.updateCartItemQty(${index}, -1)">‚àí</button>
                                    <span>${item.qty}</span>
                                    <button onclick="window.updateCartItemQty(${index}, 1)">+</button>
                                </div>
                            </div>
                            <button class="remove-item-btn" onclick="window.removeItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            if (cartTotal) cartTotal.innerText = total;

            // Sync detail page quantity if on product view
            if (window.syncDetailPageCart) window.syncDetailPageCart();
        };

        window.sendToWhatsApp = async function () {
            if (state.cart.length === 0) {
                window.showToast('Your cart is empty!', 'error');
                return;
            }

            // Show loading state
            window.showToast('Validating prices...', 'info');

            // --- 1. Price Validation ---
            try {
                const itemIds = [...new Set(state.cart.map(i => i.id))];
                const { data: dbProducts, error } = await supabase
                    .from('products')
                    .select('id, price, quantity_variants')
                    .in('id', itemIds);

                if (!error && dbProducts) {
                    let pricesChanged = false;
                    state.cart.forEach(cartItem => {
                        const dbProd = dbProducts.find(p => p.id === cartItem.id);
                        if (dbProd) {
                            let currentPrice = dbProd.price; // Default base price

                            // If variant, find variant price
                            if (cartItem.variant) {
                                let vars = [];
                                try {
                                    vars = typeof dbProd.quantity_variants === 'string'
                                        ? JSON.parse(dbProd.quantity_variants)
                                        : (dbProd.quantity_variants || []);
                                } catch (e) { }

                                // Match by quantity label matches
                                const v = vars.find(x => x.quantity === cartItem.variant.quantity);
                                if (v) currentPrice = v.price;
                            }

                            // Update if different
                            if (cartItem.price !== currentPrice) {
                                console.log(`Price update for ${cartItem.name}: ${cartItem.price} -> ${currentPrice}`);
                                cartItem.price = currentPrice;
                                pricesChanged = true;
                            }
                        }
                    });

                    if (pricesChanged) {
                        window.saveCart();
                        window.showToast('Prices updated to latest values.', 'info');
                    }
                }
            } catch (err) {
                console.error('Price validation error:', err);
                // Continue with existing cart prices if check fails
            }

            // --- 2. Background Stock Update (Fire & Forget) ---
            const updateStock = async () => {
                for (const item of state.cart) {
                    try {
                        const { error } = await supabase.rpc('process_order_stock', {
                            p_product_id: item.id,
                            p_variant_label: item.variant ? item.variant.quantity : '',
                            p_qty: item.qty
                        });
                        if (error) throw error;
                    } catch (e) {
                        console.error('Stock update failed for item:', item.id, e);
                    }
                }
            };
            updateStock();

            // --- 3. Construct Message ---
            let message = `üëã Hi Telugu Delicacies! I would like to place an order.\n\nüõí *ORDER SUMMARY*`;
            let total = 0;
            state.cart.forEach(item => {
                const sub = item.price * item.qty;
                total += sub;
                // bullet: ‚ñ™Ô∏è, format: item (variant) x qty = price
                message += `\n‚ñ™Ô∏è ${item.name} ${item.variant ? '(' + item.variant.quantity + ')' : ''} x ${item.qty} = ‚Çπ${sub}`;
            });

            message += `\n\nüí∞ *Item Total: ‚Çπ${total}* (Shipping calculated later)`;
            message += `\n\nPlease confirm availability and share payment details! ‚úÖ`;

            const phone = '919618519191';

            // Use web.whatsapp for desktop, api.whatsapp for mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const baseUrl = isMobile ? 'https://api.whatsapp.com/send' : 'https://web.whatsapp.com/send';
            const whatsappUrl = `${baseUrl}?phone=${phone}&text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');

            // Immediate Actions
            window.clearCart(); // Handles reset and toast
            window.showToast('Thanks for the order! Cart cleared.', 'success'); // Override toast msg

            // Close the cart drawer
            window.toggleCartDrawer();
        };

        // Close dropdowns when clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.sb-dropdown-trigger')) {
                document.querySelectorAll('.sb-dropdown-menu').forEach(el => el.classList.remove('show'));
            }
        });

        // --- Smart Breadcrumbs Helper (Native Select) ---
        // --- Smart Breadcrumbs Helper (Custom Portal) ---
        window.renderSmartBreadcrumbs = function (activeCategorySlug, activeProductName) {
            // 1. Home Link (Desktop & Mobile)
            // Mobile: Icon only (via CSS classes)
            // Desktop: Text "Home" (via CSS classes)
            let html = `<div class="smart-breadcrumbs">
                <span class="sb-desktop-root">
                    <a href="/" class="sb-home-link">
                        <i class="fas fa-home sb-mobile-icon"></i>
                        <span class="sb-desktop-text">Home</span>
                    </a>
                    <span class="sep">/</span>
                    <a href="/sales/all-products" class="sb-all-link" onclick="event.preventDefault(); window.navigateToCategory('all-products')">
                        <span class="sb-mobile-text">All</span>
                        <span class="sb-desktop-text">All Products</span>
                    </a>
                    <span class="sep">/</span>
                </span>`;

            // 2. Category Dropdown Trigger
            const categories = state.categories;
            let activeCat = categories.find(c => c.slug === activeCategorySlug);
            let label = activeCat ? activeCat.title : (activeCategorySlug === 'all-products' ? 'Select Category' : 'Select Category');

            if (activeCategorySlug === 'combo-offers') {
                label = 'Combo Offers';
            }

            // Pass active slug to the opener to highlight it
            html += `
                <div class="sb-select-wrapper" onclick="event.stopPropagation(); window.openCategoryDropdown(this, '${activeCategorySlug}')">
                    <span class="sb-label">${label} <i class="fas fa-caret-down"></i></span>
                </div>
            `;

            // 3. Product Name (if present)
            if (activeProductName) {
                html += `<span class="sep">/</span> <span class="current">${activeProductName}</span>`;
            }

            html += `</div>`;
            return html;
        };

        // --- Portal Dropdown Logic ---
        window.openCategoryDropdown = function (triggerEl, activeSlug) {
            // Close existing if any
            const existing = document.getElementById('sb-portal-dropdown');
            if (existing) existing.remove();

            // Create Menu
            const menu = document.createElement('div');
            menu.id = 'sb-portal-dropdown';
            menu.className = 'sb-portal-menu';

            // Content
            let itemsHtml = `
                <div class="sb-portal-item ${activeSlug === 'all-products' ? 'active' : ''}" 
                     onclick="window.handlePortalClick('all-products')">
                     All Products
                </div>
            `;

            state.categories.forEach(c => {
                itemsHtml += `
                    <div class="sb-portal-item ${c.slug === activeSlug ? 'active' : ''}" 
                         onclick="window.handlePortalClick('${c.slug}')">
                         ${c.title}
                    </div>
                `;
            });

            // Add Combo Offers to Dropdown
            itemsHtml += `
                <div class="sb-portal-item ${activeSlug === 'combo-offers' ? 'active' : ''}" 
                     style="border-top: 1px solid #eee; margin-top: 5px; color: var(--color-primary-blue); font-weight: 700;"
                     onclick="window.handlePortalClick('combo-offers')">
                     <i class="fas fa-percent" style="margin-right: 8px; font-size: 0.8rem;"></i> Combo Offers
                </div>
            `;
            menu.innerHTML = itemsHtml;

            // Append to Body (Portal)
            document.body.appendChild(menu);

            // Position
            const rect = triggerEl.getBoundingClientRect();
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.style.minWidth = Math.max(rect.width, 200) + 'px';

            // Animation
            requestAnimationFrame(() => menu.classList.add('open'));

            // Click Outside to Close
            const closeHandler = (e) => {
                if (!menu.contains(e.target) && !triggerEl.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => document.addEventListener('click', closeHandler), 0);
        };

        window.handlePortalClick = function (slug) {
            // Navigate
            window.navigateToCategory(slug);
            // Close menu
            const menu = document.getElementById('sb-portal-dropdown');
            if (menu) menu.remove();
        };

        // Scroll Breadcrumbs to ensure active item is visible (Mobile UX)
        window.updateBreadcrumbScroll = function () {
            setTimeout(() => {
                const container = document.querySelector('.smart-breadcrumbs');
                const trigger = document.querySelector('.sb-select-wrapper');
                const current = document.querySelector('.smart-breadcrumbs .current');

                if (container && (trigger || current)) {
                    // Scroll to show the Category Select or Product Name
                    // Prefer Product Name if exists, else Category
                    const target = current || trigger;
                    const offset = target.offsetLeft;

                    // Center it or scroll to ensure visibility? 
                    // Let's scroll so the target is slightly from the left edge (e.g. 50px context)
                    // But if it's the category dropdown, we probably want to see a bit of "Home" / "All" if possible?
                    // No, let's prioritize showing the current context.

                    container.scrollTo({
                        left: offset - 40, // Leave 40px left padding to see separator/context
                        behavior: 'smooth'
                    });
                }
            }, 50); // Small delay for rendering
        };

        // --- View: All Combos ---
        window.renderAllCombosView = function () {
            const app = document.getElementById('app');
            state.currentCategory = 'combo-offers';
            state.currentProduct = null;

            app.innerHTML = `
                <div class="breadcrumb-section">
                    ${window.renderSmartBreadcrumbs('combo-offers', '')}
                </div>
                <section class="category-grid-container" style="width:95%; max-width:1200px; margin:0 auto; padding-bottom:100px;">
                    <div class="category-header-clean">
                        <div class="cat-title-row">
                            <h2 class="cat-title">Special Combo Offers</h2>
                            <p class="cat-count">${state.allCombos.length} Bundles Available</p>
                        </div>
                        <p class="cat-desc">Hand-picked combinations for the ultimate Telugu flavor experience.</p>
                    </div>

                    <div class="combo-cards-grid">
                        ${state.allCombos.map(combo => {
                let totalMrp = 0;
                const productNames = [];
                const variantImages = [];
                const productImages = [];

                (combo.combo_items || []).forEach(it => {
                    if (it.products) {
                        productNames.push(it.products.product_name);

                        const pImgs = (state.allProductImages || []).filter(pi => String(pi.product_id) === String(it.products.id));
                        const pkg = (it.packaging_type || '').toLowerCase().trim();
                        const variantImg = pImgs.find(img => {
                            const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                            return tags.some(tag => tag.includes(pkg) || pkg.includes(tag));
                        });

                        if (variantImg) variantImages.push(variantImg.image_url);
                        else if (it.products.showcase_image) productImages.push(it.products.showcase_image);

                        let variants = [];
                        try {
                            variants = typeof it.products.quantity_variants === 'string' ? JSON.parse(it.products.quantity_variants) : (it.products.quantity_variants || []);
                        } catch (e) { }

                        const match = variants.find(v =>
                            String(v.quantity) === String(it.variant_quantity) &&
                            String(v.packaging_type || '') === String(it.packaging_type || '')
                        ) || variants[0];
                        totalMrp += (match ? (match.mrp || match.price || 0) : 0);
                    }
                });

                const discountPercent = combo.discount_percent || 10;
                const offerPrice = Math.round(totalMrp * (1 - discountPercent / 100));
                const savings = Math.round(totalMrp - offerPrice);
                const productListDisplay = productNames.join(', ');

                let allImages = variantImages.length > 0 ? variantImages : productImages;
                allImages = [...new Set(allImages.filter(img => img && img !== state.placeholder))];

                let visualHTML = '';
                if (allImages.length > 0) {
                    visualHTML = `
                                    <div class="combo-visual-container">
                                        <div class="combo-bundle-slots" data-images='${JSON.stringify(allImages)}'>
                                            <img src="${allImages[0]}" class="fan-slot-img fan-slot-front">
                                            <img src="${allImages[1] || allImages[0]}" class="fan-slot-img fan-slot-back-right">
                                            <img src="${allImages[2] || allImages[0]}" class="fan-slot-img fan-slot-back-left">
                                        </div>
                                    </div>
                                `;
                } else {
                    visualHTML = `
                                    <div class="combo-visual-container">
                                        <div class="combo-image-placeholder"><i class="fas fa-gift"></i></div>
                                    </div>
                                `;
                }

                const theme = combo.name.toLowerCase().includes('tiranga') ? 'tiranga' : 'default';

                return `
                                <div class="combo-card" data-theme="${theme}" onclick="window.location.href='/sales/${combo.slug}'">
                                    ${visualHTML}
                                    <div class="combo-content">
                                        <h3 class="combo-title">${combo.name}</h3>
                                        ${combo.tagline ? `<p class="combo-descriptor">${combo.tagline}</p>` : ''}
                                        <p class="combo-product-list">${productListDisplay}</p>
                                        <div class="combo-price-row">
                                            <div class="combo-price-main">‚Çπ${offerPrice}</div>
                                            ${totalMrp > offerPrice ? `<div class="combo-price-mrp">‚Çπ${totalMrp}</div>` : ''}
                                            ${discountPercent > 0 ? `<div class="combo-save-label">${discountPercent}% OFF</div>` : ''}
                                        </div>
                                        <div class="combo-buttons-row">
                                            <button class="combo-button-buy" onclick="event.stopPropagation(); window.orderComboWhatsApp('${combo.id}')">
                                                Buy Bundle
                                            </button>
                                            <button class="combo-button-cart" onclick="event.stopPropagation(); window.quickAddComboToCart('${combo.id}', '${combo.name.replace(/'/g, "\\'")}', ${offerPrice}, '${combo.image_url || allImages[0] || ''}')" title="Add to Cart">
                                                <i class="fas fa-cart-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>
                </section>
                <style>
                    /* Mobile Stacking for Combo Offers Page */
                    @media (max-width: 767px) {
                        .combo-cards-grid {
                            display: flex !important;
                            flex-direction: column !important;
                            gap: 20px !important;
                            padding: 10px !important;
                        }
                        .combo-card {
                            max-width: none !important;
                            width: 100% !important;
                        }
                    }
                </style>
            `;

            app.scrollIntoView({ behavior: 'smooth' });
            window.updateBreadcrumbScroll();
            if (typeof window.initComboFanCarousels === 'function') window.initComboFanCarousels();
        }

        // --- View: Combo ---
        async function renderComboView(slug) {
            const combo = state.allCombos.find(c => c.slug === slug);
            if (!combo) {
                renderAllProductsView(); // Fallback
                return;
            }

            // Update state context
            state.currentCategory = 'all-products';
            state.currentProduct = null;

            const app = document.getElementById('app');

            // 1. Logic: Calculate Total MRP, Select Images, and Pre-render Bundle List
            let calculatedTotalMrp = 0;
            const galleryList = [combo.image_url];
            let bundleItemsHtml = '';

            combo.combo_items.forEach((it, index) => {
                if (!it.products) return;

                // Price matching
                let variants = [];
                try {
                    variants = typeof it.products.quantity_variants === 'string'
                        ? JSON.parse(it.products.quantity_variants)
                        : (it.products.quantity_variants || []);
                } catch (e) { }

                const match = variants.find(v =>
                    String(v.quantity) === String(it.variant_quantity) &&
                    String(v.packaging_type || '') === String(it.packaging_type || '')
                ) || variants[0];
                calculatedTotalMrp += (match ? (match.mrp || match.price || 0) : 0);

                // Image Selection (Packaging/Nutrition)
                const pImgs = (state.allProductImages || []).filter(pi => String(pi.product_id) === String(it.products.id));
                const pkg = (it.packaging_type || '').toLowerCase().trim();
                const variantImg = pImgs.find(img => {
                    const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                    return tags.some(tag => tag.includes(pkg) || pkg.includes(tag));
                });

                if (variantImg) galleryList.push(variantImg.image_url);
                else if (it.products.showcase_image) galleryList.push(it.products.showcase_image);

                const nutritionImg = pImgs.find(img => {
                    const tags = (img.tags || []).map(t => t.toLowerCase().trim());
                    return tags.some(tag => tag.includes('nutrition'));
                });
                if (nutritionImg) galleryList.push(nutritionImg.image_url);

                // Bundle Item HTML
                const displayImg = variantImg?.image_url || it.products.showcase_image || pImgs[0]?.image_url || state.placeholder;
                const bundleItem = `
                    <li style="display: flex; align-items: flex-start; gap: 20px; padding-bottom: 20px; border-bottom: ${index < combo.combo_items.length - 1 ? '1px solid #eef2f6' : 'none'};">
                        <div style="width: 70px; height: 70px; background: #fff; border-radius: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #f1f5f9;">
                            <img src="${displayImg}" style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 700; color: #1e293b; font-size: 1.05rem; line-height: 1.3;">
                                ${it.products.product_name}
                            </div>
                            <div style="margin-top: 6px; color: #64748b; font-size: 0.9rem;">
                                ${it.variant_quantity} ${it.packaging_type}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); window.showProductQuickInfo('${it.products.id}')" 
                                style="flex-shrink: 0; background: #f0f9ff; border: none; color: #0077B6; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-info" style="font-size: 0.8rem;"></i>
                        </button>
                    </li>`;
                bundleItemsHtml += bundleItem;
                console.log(`[ComboDebug] Item ${index} rendered:`, it.products.product_name);
            });

            console.log('[ComboDebug] Total HTML length:', bundleItemsHtml.length);
            if (!bundleItemsHtml) console.warn('[ComboDebug] bundleItemsHtml is empty!');

            const discountPercent = combo.discount_percent || 10;
            const offerPrice = Math.round(calculatedTotalMrp * (1 - discountPercent / 100));
            const savings = Math.round(calculatedTotalMrp - offerPrice);
            const finalGallery = [...new Set(galleryList.filter(img => img && img !== state.placeholder))];

            const themeColor = combo.name.toLowerCase().includes('tiranga') ? '#fff9c4' : '#ffffff';

            app.innerHTML = `
                <div class="breadcrumb-section">
                    ${window.renderSmartBreadcrumbs('combo-offers', combo.name)}
                </div>

                <div class="combo-detail-page fade-in" style="background: ${themeColor}; min-height: 100vh;">
                    <div class="combo-detail-layout" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 40px; max-width: 1200px; margin: 40px auto; padding: 20px;">
                        
                        <!-- Visual Area -->
                        <div class="combo-visual-stack" style="position: relative;">
                            <div id="combo-main-gallery" class="main-combo-image" style="background: #ffffff; border-radius: 24px; padding: 40px; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); border: 1px solid rgba(0, 119, 182, 0.05); overflow: hidden; position: relative;">
                                <div id="combo-gallery-inner" style="width:100%; height:100%; position:relative;">
                                    <img id="combo-active-img" src="${finalGallery[0] || combo.image_url}" 
                                         alt="${combo.name}"
                                         style="width: 100%; height: 100%; object-fit: contain; transition: opacity 0.5s ease-in-out;">
                                </div>

                                <!-- Gallery Controls -->
                                <div style="position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 10;">
                                    <div id="combo-gallery-dots" style="display: flex; gap: 8px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Area -->
                        <div class="combo-info-stack" style="display: flex; flex-direction: column; gap: 25px;">
                            <div class="combo-page-header">
                                <h1 style="font-size: 2.5rem; font-weight: 800; color: var(--color-brand-blue-primary); margin-bottom: 10px;">${combo.name}</h1>
                                <p style="font-size: 1.1rem; color: var(--color-gray-600); line-height: 1.6;">${combo.description || 'Experience the perfect blend of tradition and taste with our curated bundle.'}</p>
                            </div>

                            <!-- Bundle Items Section - Robust Container -->
                            <div class="combo-product-list" style="padding: 10px 0;">
                                <h4 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 25px; color: #0077B6; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-box-open" style="font-size: 1rem; opacity: 0.8;"></i> Bundle Includes:
                                </h4>
                                <ul id="bundle-items-list-target" style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 15px; border: 2px dashed #0077B610; border-radius: 16px; min-height: 50px;">
                                    <li style="color: #64748b; font-size: 0.9rem; padding: 20px; text-align: center;">Loading bundle items...</li>
                                </ul>
                            </div>

                            <!-- Desktop Action Card -->
                            <div class="combo-price-action-card" style="background: var(--color-brand-blue-primary); color: white; border-radius: 24px; padding: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 40px rgba(0, 119, 182, 0.25);">
                                <div>
                                    <div style="font-size: 0.9rem; opacity: 0.8; text-decoration: line-through;">Total MRP: ‚Çπ${calculatedTotalMrp}</div>
                                    <div style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">‚Çπ${offerPrice}</div>
                                    ${savings > 0 ? `<div style="font-size: 0.8rem; background: var(--color-brand-yellow); color: var(--color-brand-blue-primary); padding: 4px 12px; border-radius: 100px; display: inline-block; font-weight: 800; margin-top: 8px;">SAVE ‚Çπ${savings}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 10px; flex-grow: 1; margin-left: 30px; height: 55px;">
                                    <button style="flex: 0 0 75%; background: var(--color-brand-yellow); color: var(--color-brand-blue-primary); border: none; font-weight: 800; font-size: 1rem; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="window.orderComboWhatsApp('${combo.id}')">
                                        Buy the Bundle <i class="fab fa-whatsapp"></i>
                                    </button>
                                    <button style="flex: 0 0 25%; background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); font-weight: 700; font-size: 1.2rem; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;" onclick="window.quickAddComboToCart('${combo.id}', '${combo.name.replace(/'/g, "\\'")}', ${offerPrice}, '${combo.image_url || finalGallery[0] || ''}')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sticky Mobile Action Bar -->
                <div class="sticky-mobile-action">
                    <div style="flex-shrink: 0; color: white;">
                        <div style="font-size: 0.75rem; opacity: 0.7; text-decoration: line-through;">‚Çπ${calculatedTotalMrp}</div>
                        <div style="font-size: 1.4rem; font-weight: 900;">‚Çπ${offerPrice}</div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-grow: 1; height: 48px;">
                        <button style="flex: 0 0 75%; background: var(--color-brand-yellow); color: var(--color-brand-blue-primary); border: none; font-weight: 800; font-size: 0.9rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 6px;" onclick="window.orderComboWhatsApp('${combo.id}')">
                            Buy Bundle <i class="fab fa-whatsapp"></i>
                        </button>
                        <button style="flex: 0 0 25%; background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;" onclick="window.quickAddComboToCart('${combo.id}', '${combo.name.replace(/'/g, "\\'")}', ${offerPrice}, '${combo.image_url || finalGallery[0] || ''}')">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                    </div>
                </div>

                <style>
                    @media (max-width: 992px) {
                        .combo-detail-layout { grid-template-columns: 1fr !important; gap: 30px !important; margin: 0 auto !important; padding: 15px !important; }
                        .combo-page-header h1 { font-size: 2rem !important; }
                        .combo-visual-stack .main-combo-image { padding: 30px !important; border-radius: 20px !important; }
                        .combo-price-action-card { display: none !important; }
                    }
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateY(15px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                </style>
            `;

            // 3. Post-Render: Inject Bundle List & Initialize Gallery
            setTimeout(() => {
                const target = document.getElementById('bundle-items-list-target');
                if (target) {
                    target.innerHTML = bundleItemsHtml || '<li style="color: #64748b; font-size: 0.95rem; padding: 20px; text-align: center;">No items found in this bundle</li>';
                    console.log('[ComboDebug] Successfully injected HTML into DOM target.');
                } else {
                    console.error('[ComboDebug] FAILED to find bundle-items-list-target in DOM!');
                }
            }, 0);

            if (finalGallery.length > 1) {
                const dotsContainer = document.getElementById('combo-gallery-dots');
                const activeImg = document.getElementById('combo-active-img');
                let currentIndex = 0;

                // Create dots
                finalGallery.forEach((_, idx) => {
                    const dot = document.createElement('div');
                    dot.style.cssText = `width: 8px; height: 8px; border-radius: 50%; background: ${idx === 0 ? 'var(--color-brand-blue-primary)' : '#cbd5e1'}; cursor: pointer; transition: all 0.3s;`;
                    dot.onclick = () => updateGallery(idx);
                    dotsContainer.appendChild(dot);
                });

                function updateGallery(idx) {
                    currentIndex = idx;
                    activeImg.style.opacity = '0';
                    setTimeout(() => {
                        activeImg.src = finalGallery[currentIndex];
                        activeImg.style.opacity = '1';
                    }, 300);

                    // Update dots
                    Array.from(dotsContainer.children).forEach((dot, i) => {
                        dot.style.background = (i === currentIndex) ? 'var(--color-brand-blue-primary)' : '#cbd5e1';
                        dot.style.width = (i === currentIndex) ? '20px' : '8px';
                        dot.style.borderRadius = (i === currentIndex) ? '4px' : '50%';
                    });
                }

                // Auto-play
                const timer = setInterval(() => {
                    if (!document.getElementById('combo-main-gallery')) {
                        clearInterval(timer);
                        return;
                    }
                    updateGallery((currentIndex + 1) % finalGallery.length);
                }, 4000);
            }

            app.scrollIntoView({ behavior: 'smooth' });
        }

        window.showProductQuickInfo = function (productId) {
            const product = state.allProducts.find(p => String(p.id) === String(productId));
            if (!product) return;

            // Remove existing
            const existing = document.getElementById('product-quick-info-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'product-quick-info-overlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center;
                z-index: 10000; backdrop-filter: blur(5px); padding: 20px;
            `;

            overlay.innerHTML = `
                <div style="background: white; border-radius: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; animation: slideIn 0.3s ease-out;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="padding: 30px;">
                        <h2 style="color: var(--color-brand-blue-primary); font-weight: 800; margin-bottom: 5px;">${product.product_name}</h2>
                        <p style="color: var(--color-gray-500); font-size: 0.9rem; margin-bottom: 20px;">${product.product_name_telugu || ''}</p>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-weight: 700; color: var(--color-gray-800); margin-bottom: 8px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px;">About this product:</h4>
                            <p style="color: var(--color-gray-600); line-height: 1.6; font-size: 0.95rem;">${product.product_description || 'No description available.'}</p>
                        </div>

                        ${product.ingredients ? `
                        <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                            <h4 style="font-weight: 700; color: var(--color-gray-800); margin-bottom: 5px; font-size: 0.9rem;">Ingredients:</h4>
                            <p style="color: var(--color-gray-600); font-size: 0.85rem; line-height: 1.5;">${product.ingredients}</p>
                        </div>` : ''}

                        ${product.serving_suggestion ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-weight: 700; color: var(--color-gray-800); margin-bottom: 5px; font-size: 0.9rem;">Usage Information:</h4>
                            <p style="color: var(--color-gray-600); font-size: 0.85rem; line-height: 1.5;">${product.serving_suggestion}</p>
                        </div>` : ''}

                        ${product.shelf_life ? `
                        <div style="margin-bottom: 25px; display: flex; align-items: flex-start; gap: 10px; background: #fff7ed; padding: 12px; border-radius: 12px; border: 1px solid #ffedd5;">
                            <i class="fas fa-history" style="color: #f97316; margin-top: 3px;"></i>
                            <div>
                                <h4 style="font-weight: 700; color: #9a3412; margin-bottom: 2px; font-size: 0.85rem;">Use By:</h4>
                                <p style="color: #c2410c; font-size: 0.8rem; line-height: 1.4;">Best consumed within <strong>${product.shelf_life} days</strong> from packing.</p>
                                ${product.is_refrigerated ? `<p style="color: #1d4ed8; font-size: 0.75rem; margin-top: 4px; font-weight: 600;"><i class="fas fa-snowflake"></i> Keep Refrigerated</p>` : ''}
                            </div>
                        </div>` : ''}

                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="width: 100%; background: var(--color-brand-blue-primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 119, 182, 0.2); transition: all 0.2s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 119, 182, 0.3)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 119, 182, 0.2)'">
                            Got it, Thanks!
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        };

        window.orderComboWhatsApp = async function (comboId) {
            const combo = state.allCombos.find(c => c.id === comboId);
            if (!combo) return;

            const itemList = combo.combo_items.map(it => `- ${it.products.product_name} (${it.variant_quantity} ${it.packaging_type})`).join('%0A');

            // Re-calculate offer price for message
            let calculatedTotalMrp = 0;
            combo.combo_items.forEach(it => {
                let variants = typeof it.products.quantity_variants === 'string' ? JSON.parse(it.products.quantity_variants) : (it.products.quantity_variants || []);
                const match = variants.find(v => String(v.quantity) === String(it.variant_quantity) && String(v.packaging_type || '') === String(it.packaging_type || '')) || variants[0];
                calculatedTotalMrp += (match ? (match.mrp || match.price || 0) : 0);
            });
            const offerPrice = Math.round(calculatedTotalMrp * (1 - (combo.discount_percent || 10) / 100));

            const message = `Namaste! I would like to order the *${combo.name}* bundle.%0A%0A*Items in Bundle:*%0A${itemList}%0A%0A*Offer Price:* ‚Çπ${offerPrice}`;

            const phone = state.settings.contact_phone_primary ? state.settings.contact_phone_primary.replace(/[\s\+]/g, '') : "919391102929";

            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const baseUrl = isMobile ? "https://wa.me/" : "https://web.whatsapp.com/send";
            const url = `${baseUrl}?phone=${phone}&text=${message}`;

            window.open(url, '_blank');
        };

        window.quickAddComboToCart = function (id, name, price, image) {
            let cart = JSON.parse(localStorage.getItem('td_cart') || '[]');

            const existingIndex = cart.findIndex(item => item.id === id && item.isCombo);
            if (existingIndex > -1) {
                cart[existingIndex].qty += 1;
            } else {
                cart.push({
                    id: id,
                    name: name,
                    price: price,
                    image: image,
                    qty: 1,
                    isCombo: true
                });
            }

            localStorage.setItem('td_cart', JSON.stringify(cart));
            window.initHeaderCartButton();
            window.showToast?.(`${name} added to cart!`, 'success');

            // Refresh cart drawer if open
            if (document.getElementById('cartDrawer').classList.contains('open')) {
                window.renderCartItems?.();
            }
        };

        // --- PWA Installation Logic ---
        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            console.log('PWA Installable');

            // Show install buttons
            const btn = document.getElementById('pwaInstallBtn');
            const btnMobile = document.getElementById('pwaInstallBtnMobile');
            if (btn) btn.style.display = 'inline-block';
            if (btnMobile) btnMobile.style.display = 'inline-block';
        });

        window.installPWA = async () => {
            if (!window.deferredPrompt) return;
            window.deferredPrompt.prompt();
            const { outcome } = await window.deferredPrompt.userChoice;
            console.log(`User response to install prompt: ${outcome}`);
            window.deferredPrompt = null;

            // Hide buttons
            const btn = document.getElementById('pwaInstallBtn');
            const btnMobile = document.getElementById('pwaInstallBtnMobile');
            if (btn) btn.style.display = 'none';
            if (btnMobile) btnMobile.style.display = 'none';
        };

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }

        window.initCart();

        init().catch(err => {
            console.error("Critical Runtime Error:", err);
            const app = document.getElementById('app');
            if (app) {
                app.innerHTML = `
                    <div class="error-state">
                        <div class="error-card">
                            <h2>Something went wrong</h2>
                            <p>We encountered a technical error while loading the page.</p>
                            <button onclick="location.reload()" class="action-btn-pill primary">Try Again</button>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>