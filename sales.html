<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telugu Delicacies - Shop</title>
    <!-- Core Assets -->
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/favicon.png">

    <!-- Isolated Page Styles -->
    <link rel="stylesheet" href="sales-page.css">
</head>

<body>
    <header class="sales-header">
        <div class="logo-area" style="display:flex; align-items:center; gap:10px;">
            <img src="/favicon.png" id="headerLogo" alt="Logo" class="logo"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="logo-fallback"
                style="display:none; background:var(--bg-gradient-primary); color:white; width:40px; height:40px; border-radius:8px; align-items:center; justify-content:center; font-weight:bold;">
                TD
            </div>
            <span class="brand-name">Telugu Delicacies</span>
        </div>
        <nav>
            <a href="/" class="nav-btn">Home</a>
        </nav>
    </header>

    <main class="sales-page-container" id="app">
        <!-- Loader -->
        <div style="text-align: center; padding: 100px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--color-primary-blue)"></i>
        </div>
    </main>

    <script type="module">
        import { supabase } from './lib/supabase.js';

        // State Management
        const state = {
            allProducts: [],
            categories: [],
            settings: {},
            loading: true,
            currentCategory: null,
            currentProduct: null
        };

        // Initialize App
        async function init() {
            try {
                const [settingsRes, productsRes, categoriesRes] = await Promise.all([
                    supabase.from('site_settings').select('*').single(),
                    supabase.from('products').select('*'),
                    supabase.from('categories').select('*').order('display_order', { ascending: true })
                ]);

                state.settings = settingsRes.data || {};
                state.allProducts = productsRes.data || [];
                state.categories = categoriesRes.data || [];
                state.placeholder = state.settings.product_placeholder_url || './images/placeholder-product.jpg';

                // Sync Logo
                if (state.settings.logo_url) document.getElementById('headerLogo').src = state.settings.logo_url;

                handleRouting();
            } catch (err) {
                console.error("Initialization Failed:", err);
                document.getElementById('app').innerHTML = "<h2>Something went wrong. Please try again later.</h2>";
            }
        }

        function handleRouting() {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            const catSlug = params.get('category');

            if (productId) {
                renderProductView(productId);
            } else {
                renderCategoryView(catSlug);
            }
        }

        // --- View: Category ---
        function renderCategoryView(slug) {
            const app = document.getElementById('app');

            const cardsHtml = state.categories.map(cat => {
                const catProducts = state.allProducts.filter(p =>
                    (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === cat.slug
                );

                return `
                    <article class="master-card" id="card-${cat.slug}">
                        <div class="card-hero-image">
                            <img src="${cat.image_url || state.placeholder}" alt="${cat.title}" onerror="this.src='${state.placeholder}'">
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">${cat.title}</h3>
                            ${cat.sub_brand ? `<p class="category-sub-brand" style="font-weight:600; color:var(--text-secondary);">${cat.sub_brand}</p>` : ''}
                            <p class="telugu-subtitle" style="font-family:var(--font-telugu); color:var(--text-muted);">${cat.telugu_title || ''}</p>
                            <p class="card-desc">${cat.description || ''}</p>
                            
                            <div class="dropdown-wrapper">
                                <select class="product-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-medium);" onchange="if(this.value) window.location.href='sales.html?id='+this.value">
                                    <option value="" disabled selected>Select Product</option>
                                    ${catProducts.map(p => `
                                        <option value="${p.id}">${p.product_name} ${p.product_name_telugu ? '(' + p.product_name_telugu + ')' : ''}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            app.innerHTML = `
                <div class="breadcrumb-section">
                    <a href="/" style="color:var(--text-secondary)">Home</a> / 
                    <span style="color:var(--color-primary-blue); font-weight:600;">All Collections</span>
                </div>
                <section class="category-view-container">
                    <div class="master-cards-grid">
                        ${cardsHtml}
                    </div>
                </section>
            `;

            if (slug) {
                const el = document.getElementById(`card-${slug}`);
                if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            }
        }

        // --- View: Product ---
        async function renderProductView(id) {
            const product = state.allProducts.find(p => p.id == id);
            if (!product) {
                document.getElementById('app').innerHTML = "<h2>Product Not Found</h2>";
                return;
            }

            // Category & Context
            const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
            const category = state.categories.find(c => c.slug === catSlug);

            // Navigation
            const siblingProducts = state.allProducts.filter(p => (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === catSlug);
            const idx = siblingProducts.findIndex(p => p.id === product.id);
            const prev = idx > 0 ? siblingProducts[idx - 1] : null;
            const next = idx < siblingProducts.length - 1 ? siblingProducts[idx + 1] : null;

            updateHistory(product);

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="grid-layout">
                    <!-- Breadcrumbs -->
                    <div class="breadcrumb-section" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <a href="/" style="color:var(--text-secondary)">Home</a> / 
                            <a href="sales.html?category=${catSlug}" style="color:var(--text-secondary)">${category?.title || 'Back'}</a> / 
                            <span style="color:var(--color-primary-blue); font-weight:600;">${product.product_name}</span>
                        </div>
                        <div class="nav-arrows">
                            ${prev ? `<a href="sales.html?id=${prev.id}" class="nav-arrow-btn" style="padding:5px 15px; border:1px solid var(--border-light); border-radius:20px; font-size:0.8rem;"><i class="fas fa-chevron-left"></i> Prev</a>` : ''}
                            ${next ? `<a href="sales.html?id=${next.id}" class="nav-arrow-btn" style="padding:5px 15px; border:1px solid var(--border-light); border-radius:20px; font-size:0.8rem; margin-left:10px;">Next <i class="fas fa-chevron-right"></i></a>` : ''}
                        </div>
                    </div>

                    <!-- Main Content -->
                    <article class="main-product-area">
                        <div class="product-gallery">
                            ${category?.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}" class="overlay-logo">` : ''}
                            <img src="${product.showcase_image || state.placeholder}" class="main-img" alt="${product.product_name}">
                        </div>
                        
                        <div class="product-details">
                            ${!category?.sub_brand_logo_url && category?.sub_brand ? `<div style="text-transform:uppercase; font-size:0.8rem; font-weight:700; color:var(--text-muted);">${category.sub_brand}</div>` : ''}
                            <h1 class="product-title">${product.product_name}</h1>
                            <div class="telugu-title">${product.product_name_telugu || ''}</div>

                            <div class="price-row">
                                <span class="current-price" id="view-price">₹${product.price}</span>
                                <span class="mrp-strike" id="view-mrp" style="${product.mrp > product.price ? '' : 'display:none'}">₹${product.mrp}</span>
                                <span class="discount-badge" id="view-discount" style="${product.mrp > product.price ? '' : 'display:none'}"></span>
                            </div>

                            <div class="selection-area">
                                ${renderVariants(product)}
                            </div>

                            <div class="info-tabs">
                                <div class="info-btns-row" id="tabs-container"></div>
                                <div class="info-display-area" id="tabs-content"></div>
                            </div>

                            <div class="actions" style="margin-top:30px;">
                                <a href="https://wa.me/c/919618519191" target="_blank" class="buy-btn" style="background:var(--color-success); color:white; display:flex; align-items:center; justify-content:center; gap:10px; padding:15px; border-radius:30px; font-weight:700; text-decoration:none;">
                                    <i class="fab fa-whatsapp"></i> Order on WhatsApp
                                </a>
                            </div>
                        </div>
                    </article>

                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <section class="sidebar-card">
                            <div class="sidebar-tabs">
                                <div class="sidebar-tab active" data-tab="similar">Similar</div>
                                <div class="sidebar-tab" data-tab="trending">Trending</div>
                            </div>
                            <div id="side-content">
                                ${renderVerticalItems(getSimilarProducts(product))}
                            </div>
                        </section>
                    </aside>

                    <!-- Recent Section -->
                    <section class="recent-section">
                        <h3 style="margin-bottom:20px;">Recently Viewed</h3>
                        <div class="recent-grid">
                            ${renderHistoryItems()}
                        </div>
                    </section>
                </div>
            `;

            initProductInteractions(product);
        }

        // --- Helpers: Components ---
        function renderVariants(p) {
            let variants = [];
            try { variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : (p.quantity_variants || []); } catch (e) { }

            if (variants.length <= 1) return `<p style="color:var(--text-secondary)"><strong>Pack Size:</strong> ${variants[0]?.quantity || 'Standard'}</p>`;

            return `
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px; color:var(--text-muted);">SELECT SIZE</label>
                    <select id="variantSelect" style="width:100%; max-width:300px; padding:12px; border-radius:8px; border:1px solid var(--border-medium); background:var(--bg-secondary);">
                        ${variants.map((v, i) => `<option value="${i}">${v.quantity} - ₹${v.price}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        function initProductInteractions(p) {
            const vSelect = document.getElementById('variantSelect');
            let variants = [];
            try { variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : (p.quantity_variants || []); } catch (e) { }

            const updatePrice = (v) => {
                document.getElementById('view-price').innerText = '₹' + v.price;
                const mrpEl = document.getElementById('view-mrp');
                const discEl = document.getElementById('view-discount');
                if (v.mrp && v.mrp > v.price) {
                    mrpEl.innerText = '₹' + v.mrp;
                    mrpEl.style.display = 'inline';
                    const off = Math.round(((v.mrp - v.price) / v.mrp) * 100);
                    discEl.innerText = off + '% OFF';
                    discEl.style.display = 'inline-block';
                } else {
                    mrpEl.style.display = 'none';
                    discEl.style.display = 'none';
                }
            };

            if (vSelect) {
                vSelect.onchange = (e) => updatePrice(variants[e.target.value]);
            }
            if (variants[0]) updatePrice(variants[0]);

            // Tabs
            const tabs = [];
            if (p.ingredients) tabs.push({ id: 'ing', label: 'Ingredients', icon: 'fas fa-carrot', html: `<p>${p.ingredients}</p>` });
            if (p.nutrition_info) {
                let n = {}; try { n = typeof p.nutrition_info === 'string' ? JSON.parse(p.nutrition_info) : p.nutrition_info; } catch (e) { }
                let grid = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
                Object.entries(n).forEach(([k, v]) => {
                    if (k !== 'serving_size' && k !== 'total_servings' && v) {
                        grid += `<div style="padding:10px; background:white; border-radius:6px; display:flex; justify-content:space-between; font-size:0.8rem;">
                            <strong>${k.replace('_', ' ')}</strong> <span>${v}</span>
                        </div>`;
                    }
                });
                grid += `</div>`;
                tabs.push({ id: 'nut', label: 'Nutrition', icon: 'fas fa-heartbeat', html: grid });
            }
            if (p.serving_suggestion) tabs.push({ id: 'use', label: 'Usage', icon: 'fas fa-utensils', html: `<p>${p.serving_suggestion}</p>` });

            const tabContainer = document.getElementById('tabs-container');
            const tabContent = document.getElementById('tabs-content');

            const switchTab = (id) => {
                const active = tabs.find(t => t.id === id);
                tabContent.innerHTML = active?.html || '';
                document.querySelectorAll('.info-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.id === id));
            };

            tabContainer.innerHTML = tabs.map(t => `<button class="info-btn" data-id="${t.id}"><i class="${t.icon}"></i> ${t.label}</button>`).join('');
            tabContainer.onclick = (e) => {
                const btn = e.target.closest('.info-btn');
                if (btn) switchTab(btn.dataset.id);
            };

            if (tabs[0]) switchTab(tabs[0].id);

            // Sidebar Tabs
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const mode = tab.dataset.tab;
                    document.getElementById('side-content').innerHTML = renderVerticalItems(mode === 'similar' ? getSimilarProducts(p) : state.allProducts.filter(x => x.is_trending));
                };
            });
        }

        // --- Logic: Data Helpers ---
        function getSimilarProducts(target) {
            return state.allProducts
                .filter(p => p.id !== target.id)
                .map(p => {
                    const isSameCat = p.product_category === target.product_category;
                    return { ...p, score: isSameCat ? 1 : 0 };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
        }

        function renderVerticalItems(items) {
            if (!items.length) return `<p style="text-align:center; padding:20px; color:var(--text-muted)">No items found.</p>`;
            return items.map(item => `
                <div class="sim-item" onclick="window.location.href='sales.html?id=${item.id}'">
                    <img src="${item.showcase_image || state.placeholder}" class="sim-img" onerror="this.src='${state.placeholder}'">
                    <div class="sim-info">
                        <h4 style="font-size:0.9rem; margin:0;">${item.product_name}</h4>
                        <span style="font-size:0.8rem; color:var(--color-primary-blue)">View Product</span>
                    </div>
                </div>
            `).join('');
        }

        function updateHistory(p) {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            hist = hist.filter(x => x.id !== p.id);
            hist.unshift({ id: p.id, name: p.product_name, img: p.showcase_image });
            localStorage.setItem('td_history', JSON.stringify(hist.slice(0, 8)));
        }

        function renderHistoryItems() {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            if (!hist.length) return `<p style="grid-column:1/-1; color:var(--text-muted)">Your viewing history will appear here.</p>`;
            return hist.map(h => `
                <div class="sim-item" onclick="window.location.href='sales.html?id=${h.id}'" style="background:var(--bg-primary); border:1px solid var(--border-light);">
                    <img src="${h.img || state.placeholder}" class="sim-img" onerror="this.src='${state.placeholder}'">
                    <div class="sim-info">
                        <h4 style="font-size:0.9rem; margin:0;">${h.name}</h4>
                        <span style="font-size:0.8rem; color:var(--text-secondary)">View Product</span>
                    </div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>

</html>