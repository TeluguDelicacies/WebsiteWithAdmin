<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <!-- Prevent auto-scroll on refresh -->
    <script>if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; window.scrollTo(0, 0);</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telugu Delicacies</title>
    <meta name="description"
        content="Order authentic Telugu podis, soft chapatis and crispy parotas made with traditional recipes and hygienic methods. Taste real Andhra flavours at Telugu Delicacies." />

    <!-- Open Graph Meta Tags (WhatsApp Sharing) -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://telugudelicacies.com/sales.html" />
    <meta property="og:title" content="Telugu Delicacies â€“ Modern Yet Traditional" />
    <meta property="og:description"
        content="Home of traditional Telugu podis, tasty chapatis, and flaky parotas â€“ crafted with authentic recipes and modern hygiene." />
    <meta property="og:image"
        content="https://pfffotghmcofyrvqynbl.supabase.co/storage/v1/object/public/site-assets/1767276219672_20aiu9.png" />
    <meta property="og:image:width" content="600" />
    <meta property="og:image:height" content="600" />
    <!-- Core Assets -->
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Mallanna&family=Montserrat:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Ubuntu+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png"
        href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" id="dynamic-favicon">

    <!-- Isolated Page Styles -->
    <link rel="stylesheet" href="sales-page.css?v=2.0">
</head>

<body>
    <header class="header sales-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo Section -->
                <a href="/" class="logo-section">
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                        id="headerLogo" alt="Telugu Delicacies Logo" class="logo"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="logo-fallback" style="display: none;">TD</div>
                    <div class="logo-text">
                        <h1 class="brand-name" id="header-site-title">Telugu Delicacies</h1>
                        <span id="header-telugu-brand" class="telugu-brand"></span>
                    </div>
                </a>

                <!-- Desktop Navigation -->
                <nav class="desktop-nav">
                    <button class="nav-btn share-page-btn" onclick="window.shareCurrentPage()"
                        data-tooltip="Share Page">
                        <i class="fas fa-arrow-up-from-bracket"></i>
                    </button>
                    <button class="nav-btn cart-btn" id="cartBtn" onclick="window.toggleCartDrawer()"
                        data-tooltip="View Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="mainCartCount" style="display:none;">0</span>
                    </button>
                    <a href="/" class="nav-btn home-btn" data-tooltip="Back Home">
                        <i class="fas fa-home"></i>
                    </a>
                </nav>

                <!-- Mobile Actions -->
                <div class="mobile-actions">
                    <button class="nav-btn share-page-btn" onclick="window.shareCurrentPage()"
                        data-tooltip="Share Page">
                        <i class="fas fa-arrow-up-from-bracket"></i>
                    </button>
                    <button class="nav-btn cart-btn" id="mobileCartBtn" onclick="window.toggleCartDrawer()"
                        data-tooltip="View Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="mobileCartCount" style="display:none;">0</span>
                    </button>
                    <a href="/" class="nav-btn home-btn" data-tooltip="Back Home">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="sales-page-container" id="app">
        <!-- Loader -->
        <div style="text-align: center; padding: 100px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--color-primary-blue)"></i>
        </div>
    </main>

    <!-- Cart Drawer -->
    <div id="cartOverlay" class="cart-overlay" onclick="window.toggleCartDrawer()"></div>
    <div id="cartDrawer" class="cart-drawer">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="clear-cart-btn" onclick="window.clearCart()" style="display:none;">Clear All</button>
                <button class="close-cart-btn" onclick="window.toggleCartDrawer()">&times;</button>
            </div>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Items will be populated here -->
            <div class="empty-cart-msg">Your cart is empty</div>
        </div>
        <div class="cart-footer">
            <div class="delivery-note">* Delivery charges may apply</div>
            <div class="cart-total-row">
                <span>Total:</span>
                <span class="total-amount">â‚¹<span id="cartTotal">0</span></span>
            </div>
            <button class="order-whatsapp-btn" onclick="window.sendToWhatsApp()">
                <i class="fab fa-whatsapp"></i> Order on WhatsApp
            </button>
        </div>
    </div>

    </div>

    <script type="module">
        import { supabase } from './lib/supabase.js';

        // Expose supabase to window for HeaderComponent
        window.supabase = supabase;

        // State Management
        const state = {
            allProducts: [],
            categories: [],
            settings: {},
            loading: true,
            currentCategory: null,
            currentProduct: null,
            cart: [],
            detailQty: 1,
            catalogueFile: null
        };

        // Expose state for debugging
        window.state = state;

        // Initialize header cart button visibility
        window.initHeaderCartButton = function () {
            try {
                const cart = JSON.parse(localStorage.getItem('td_cart') || '[]');

                // Update Badge Count
                const count = cart.reduce((sum, item) => sum + (item.qty || item.quantity || 1), 0);
                ['mainCartCount', 'mobileCartCount'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = count;
                        // Only show badge if count > 0
                        el.style.display = count > 0 ? 'flex' : 'none';
                    }
                });

                // Check if we should auto-open cart (from legal page redirect)
                // Use a slight delay to ensure drawer JS is ready if needed, 
                // though window.toggleCartDrawer comes from sales.html external script/previous definition
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('cart') === 'open' && window.toggleCartDrawer) {
                    setTimeout(() => window.toggleCartDrawer(), 300);
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                }
            } catch (e) {
                console.warn('[Cart Init] Error:', e);
            }
        };

        async function preloadCatalogue() {
            const catalogueUrl = state.settings.catalogue_image_url;
            if (!catalogueUrl) return;

            try {
                const response = await fetch(catalogueUrl);
                const blob = await response.blob();
                state.catalogueFile = new File([blob], 'Telugu_Delicacies_Catalogue.jpg', { type: 'image/jpeg' });
                console.log('Catalogue pre-loaded successfully');
            } catch (err) {
                console.warn('Failed to pre-load catalogue:', err);
            }
        }

        // GLOBAL SHARE CURRENT PAGE FUNCTION
        window.shareCurrentPage = function () {
            const currentUrl = window.location.href;
            let shareText = "Check out Telugu Delicacies!";

            // Context-aware message
            if (state.currentProduct) {
                const product = state.currentProduct;
                const tagline = product.product_tagline ? ` - "${product.product_tagline}"` : '';
                shareText = `Check out ${product.product_name}${tagline} at Telugu Delicacies! ðŸ˜‹`;
            } else if (state.currentCategory === 'all-products') {
                // Special message for All Products page
                shareText = `ðŸ½ï¸ From Podis to Parotas - explore our complete range at Telugu Delicacies!`;
            } else if (state.currentCategory) {
                const cat = state.categories.find(c => c.slug === state.currentCategory);
                if (cat) {
                    // Fetch top 2 products for this category
                    const catProducts = state.allProducts.filter(p =>
                        (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === state.currentCategory
                    );
                    const topProducts = catProducts.slice(0, 2).map(p => p.product_name).join(', ');
                    const productText = topProducts ? ` featuring ${topProducts} and more` : '';

                    shareText = `Check out our ${cat.title} collection${productText} at Telugu Delicacies!`;
                }
            }

            const fullMessage = `${shareText}\n${currentUrl}`;

            // Mobile: Use native share if available
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && navigator.share) {
                navigator.share({
                    title: 'Telugu Delicacies',
                    text: fullMessage
                    // Note: Removing 'url' parameter to prevent duplicate links in apps like WhatsApp
                }).catch(err => console.log('Share cancelled'));
                return;
            }

            // Fallback: Open WhatsApp with URL
            const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(fullMessage)}`;
            window.open(whatsappUrl, '_blank');
        };

        // Initialize App
        async function init() {
            // Expose toggleFlip globally
            window.toggleFlip = function () {
                const el = document.querySelector('.gallery-inner');
                const btn = document.querySelector('.gallery-wrapper > div:last-child .action-btn-pill');
                const disclaimer = document.querySelector('.product-disclaimer-overlay');
                if (el) {
                    el.classList.toggle('flipped');
                    const isFlipped = el.classList.contains('flipped');

                    // Hide/Show action container (Add/Qty buttons)
                    const actionContainer = document.querySelector('.gallery-front .card-action-container');
                    if (actionContainer) {
                        actionContainer.style.opacity = isFlipped ? '0' : '1';
                        actionContainer.style.pointerEvents = isFlipped ? 'none' : 'auto';
                    }

                    // Hide/Show mobile variant container
                    const mobileVariantContainer = document.getElementById('mobileVariantContainer');
                    if (mobileVariantContainer) {
                        mobileVariantContainer.style.opacity = isFlipped ? '0' : '1';
                        mobileVariantContainer.style.pointerEvents = isFlipped ? 'none' : 'auto';
                    }

                    // Update button text based on state
                    if (btn) {
                        btn.innerHTML = isFlipped
                            ? '<i class="fas fa-image"></i> Back to Image'
                            : '<i class="fas fa-info-circle"></i> View Description';
                    }
                    // Hide/show disclaimer
                    if (disclaimer) {
                        disclaimer.style.opacity = isFlipped ? '0' : '1';
                    }
                }
            };

            // Mobile Swipe Navigation
            window.initSwipeNavigation = function () {
                const gallery = document.querySelector('.product-gallery');
                if (!gallery) return;

                let touchStartX = 0;
                let touchEndX = 0;
                const minSwipeDistance = 50;

                gallery.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                gallery.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });

                function handleSwipe() {
                    // Only navigate if NOT flipped (image is visible)
                    const inner = gallery.querySelector('.gallery-inner');
                    if (inner && inner.classList.contains('flipped')) return;

                    const swipeDistance = touchEndX - touchStartX;

                    if (Math.abs(swipeDistance) < minSwipeDistance) return;

                    // Find navigation links
                    const prevLink = document.querySelector('.nav-btn-pill.prev:not(.disabled)');
                    const nextLink = document.querySelector('.nav-btn-pill.next:not(.disabled)');

                    if (swipeDistance > 0 && prevLink) {
                        // Swiped right -> go to previous product
                        const prevId = prevLink.getAttribute('data-id');
                        navigateToProduct(prevId, 'left');
                    } else if (swipeDistance < 0 && nextLink) {
                        // Swiped left -> go to next product
                        const nextId = nextLink.getAttribute('data-id');
                        navigateToProduct(nextId, 'right');
                    }
                }
            };

            window.navigateToProduct = function (slugOrId, direction = 'fade') {
                const newUrl = `/sales/${slugOrId}`;

                // If it's the same product, do nothing
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts[pathParts.length - 1] === slugOrId) return;

                // Update URL without reload
                history.pushState({ slugOrId, direction, type: 'product' }, '', newUrl);

                // Perform view update with animation
                performTransition(slugOrId, direction);
            };

            window.navigateToCategory = function (slug) {
                const newUrl = `/sales/${slug}`;
                history.pushState({ slug, type: 'category' }, '', newUrl);

                if (slug === 'all-products') {
                    renderAllProductsView();
                } else {
                    renderCategoryView(slug);
                }
            };

            async function performTransition(slugOrId, direction) {
                const app = document.getElementById('app');
                const oldContent = app.querySelector('.grid-layout');

                if (!oldContent || direction === 'fade') {
                    renderProductView(slugOrId);
                    app.scrollIntoView({ behavior: 'smooth' });
                    return;
                }

                // Create wrapper for transition
                app.style.position = 'relative';
                app.style.overflow = 'hidden';

                // Add exit animation to old content
                oldContent.classList.add('slide-container');
                oldContent.classList.add(direction === 'right' ? 'slide-out-left' : 'slide-out-right');

                // Wait for animation or just render new
                setTimeout(() => {
                    renderProductView(slugOrId, direction);
                    app.scrollIntoView({ behavior: 'smooth' });
                }, 150); // Small delay to start the exit
            }

            window.addEventListener('popstate', (e) => {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const lastPart = pathParts[pathParts.length - 1];

                if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'sales' && lastPart !== 'sales.html') {
                    renderProductView(lastPart, e.state?.direction || 'fade');
                } else if (window.location.pathname.endsWith('sales.html') || pathParts[pathParts.length - 1] === 'sales') {
                    renderCategoryView();
                }
            });

            try {
                console.log('[Sales Init] Starting data fetch...');
                const [settingsRes, productsRes, categoriesRes] = await Promise.all([
                    supabase.from('site_settings').select('*').single(),
                    supabase.from('products').select('*').order('display_order', { ascending: true }),
                    supabase.from('categories').select('*').order('display_order', { ascending: true })
                ]);

                // Check for Supabase errors (these don't throw, they return .error)
                if (settingsRes.error) {
                    console.error('[Sales Init] Settings Error:', settingsRes.error);
                }
                if (productsRes.error) {
                    console.error('[Sales Init] Products Error:', productsRes.error);
                    throw new Error('Failed to load products: ' + productsRes.error.message);
                }
                if (categoriesRes.error) {
                    console.error('[Sales Init] Categories Error:', categoriesRes.error);
                    throw new Error('Failed to load categories: ' + categoriesRes.error.message);
                }

                console.log('[Sales Init] Data fetched:', {
                    settings: settingsRes.data ? 'OK' : 'Empty',
                    products: productsRes.data?.length || 0,
                    categories: categoriesRes.data?.length || 0
                });

                state.settings = settingsRes.data || {};
                preloadCatalogue(); // Pre-load after settings
                // Filter out hidden products
                state.allProducts = (productsRes.data || []).filter(p => p.is_visible !== false);
                // Filter out hidden categories
                state.categories = (categoriesRes.data || []).filter(c => c.is_visible !== false);
                state.placeholder = state.settings.product_placeholder_url || './images/placeholder-product.jpg';

                // Sync Logo & Favicon
                if (state.settings.logo_url) {
                    const logoImg = document.getElementById('headerLogo');
                    if (logoImg) logoImg.src = state.settings.logo_url;

                    // Also set favicon if available, otherwise use logo
                    const faviconLink = document.getElementById('dynamic-favicon');
                    if (faviconLink) faviconLink.href = state.settings.favicon_url || state.settings.logo_url;
                }

                // Populate Telugu Brand Name in Header
                if (state.settings.site_title_telugu) {
                    const teluguBrand = document.getElementById('header-telugu-brand');
                    if (teluguBrand) {
                        teluguBrand.textContent = state.settings.site_title_telugu;
                    }
                }

                console.log('[Sales Init] Routing...');
                handleRouting();

                // Initialize header cart button visibility
                initHeaderCartButton();
            } catch (err) {
                console.error("Initialization Failed:", err);
                document.getElementById('app').innerHTML = `
                    <div class="error-state">
                        <div class="error-card">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h2>Oops! Something went wrong</h2>
                            <p>We couldn't load the products right now. This might be a temporary issue.</p>
                            <div class="error-actions">
                                <button class="action-btn-pill primary" onclick="location.reload()">
                                    <i class="fas fa-redo"></i> Try Again
                                </button>
                                <a href="/" class="action-btn-pill outline">
                                    <i class="fas fa-home"></i> Go Home
                                </a>
                            </div>
                            <p class="error-hint">If the problem persists, please contact us via WhatsApp.</p>
                        </div>
                    </div>
                `;
            }
        }

        function handleRouting() {
            // Support clean URLs: /sales/product-slug
            const pathParts = window.location.pathname.split('/').filter(Boolean);
            const lastPart = pathParts[pathParts.length - 1];

            // Check if it's a product or category
            if (pathParts.length >= 2 && pathParts[pathParts.length - 2] === 'sales' && lastPart !== 'sales.html') {
                // Check if it's 'all-products'
                if (lastPart === 'all-products') {
                    renderAllProductsView();
                    return;
                }

                // Check if it's a category
                const isCategory = state.categories.find(c => c.slug === lastPart);
                if (isCategory) {
                    renderCategoryView(lastPart);
                } else {
                    renderProductView(lastPart);
                }
                return;
            }

            // Fallback: Support legacy query params for backwards compatibility
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            const catSlug = params.get('category');

            if (productId) {
                renderProductView(productId);
            } else if (catSlug) {
                if (catSlug === 'all-products') {
                    renderAllProductsView();
                } else {
                    renderCategoryView(catSlug);
                }
            } else {
                // Default handling for /sales.html root
                if (state.categories.length > 0) {
                    // Check if we want to default to All Products or First Category
                    // Let's stick to first category for now unless requested otherwise, 
                    // OR redirect to all-products? 
                    // User just asked for the view, not to change default.
                    renderCategoryView(state.categories[0].slug);
                }
            }
        }

        // --- View: All Products ---
        function renderAllProductsView() {
            const app = document.getElementById('app');

            // Update State
            state.currentCategory = 'all-products';
            state.currentProduct = null;

            // Sort by Category Order, then Product Order
            // 1. Create a map of "Category Slug" -> "Category Index/Order"
            const catOrderMap = {};
            state.categories.forEach((c, idx) => {
                catOrderMap[c.slug] = idx;
            });

            // 2. Sort products
            const allVisible = [...state.allProducts].sort((a, b) => {
                const catSlugA = (a.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
                const catSlugB = (b.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');

                const orderA = catOrderMap[catSlugA] !== undefined ? catOrderMap[catSlugA] : 9999;
                const orderB = catOrderMap[catSlugB] !== undefined ? catOrderMap[catSlugB] : 9999;

                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                // Secondary sort: Product's own display_order (already handled by initial fetch, but good to be explicit if needed)
                return (a.display_order || 0) - (b.display_order || 0);
            });

            app.innerHTML = `
                <div class="breadcrumb-section">
                    ${window.renderSmartBreadcrumbs('all-products', '')}
                </div>

                <section class="category-grid-container" style="width:95%; max-width:95%; margin:0 auto; padding-bottom:50px;">
                    <!-- Widget Header -->
                    ${window.renderBrandWidget()}

                    <!-- New Grid Container -->
                    <div class="category-grid">
                        ${allVisible.map(p => renderProductCard(p, { title: 'All Products' })).join('')}
                    </div>
                </section>
            `;

            // Start Widget Cycle
            window.startBrandWidgetCycle();

            // Scroll breadcrumbs
            window.updateBreadcrumbScroll();
        }

        // --- Widget: Dynamic Sub-Brand Header ---
        window.renderBrandWidget = function () {
            // 1. Collect your brands (Keep your existing logic here)
            const brands = [];
            const seen = new Set();
            state.categories.forEach(c => {
                if (c.sub_brand && c.sub_brand_logo_url && !seen.has(c.sub_brand)) {
                    brands.push(c);
                    seen.add(c.sub_brand);
                }
            });

            if (brands.length === 0) return '';

            const tagline = state.settings?.all_products_tagline || 'Featuring our premium brands';

            // 2. THE CRITICAL CHANGE: 
            // We create ONE single container (.category-header-simple).
            // Child 1: The Text Div.
            // Child 2: The Logo Wrapper (The Carousel).

            return `
            <div class="category-header-simple brand-widget-container" style="display: flex; align-items: center; justify-content: space-between;">
                
                <div class="header-text-group">
                    <h1>All Products</h1>
                    <p>${tagline}</p>
                </div>
                
                <div class="brand-logos-wrapper">
                    <div class="desktop-brand-grid">
                        ${brands.map(b => `
                            <div class="desktop-logo-wrapper">
                                <img src="${b.sub_brand_logo_url}" class="brand-logo-item" alt="${b.sub_brand}">
                            </div>
                        `).join('')}
                    </div>
                </div>

            </div>`;
        };

        window.startBrandWidgetCycle = function () {
            // ONLY target logos within the mobile carousel
            const mobileLogos = document.querySelectorAll('.mobile-brand-carousel .brand-logo-item');
            if (mobileLogos.length <= 1) return;

            // Clear existing interval
            if (window.brandInterval) clearInterval(window.brandInterval);

            let current = 0;
            window.brandInterval = setInterval(() => {
                mobileLogos.forEach(l => l.classList.remove('active'));
                current = (current + 1) % mobileLogos.length;
                mobileLogos[current].classList.add('active');
            }, 2000);
        };

        // --- View: Category ---
        function renderCategoryView(slug) {
            const app = document.getElementById('app');

            // If no category slug, redirect to home page
            if (!slug) {
                window.location.href = '/';
                return;
            }

            // Update State
            state.currentCategory = slug;
            state.currentProduct = null;

            // Single Category Grid View
            renderSingleCategoryGrid(slug);
        }

        function renderSingleCategoryGrid(slug) {
            const app = document.getElementById('app');
            const category = state.categories.find(c => c.slug === slug);

            if (!category) {
                app.innerHTML = '<h2 class="text-center">Category Not Found</h2>';
                return;
            }

            const catProducts = state.allProducts.filter(p =>
                (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === slug
            );

            // Use the NEW Quick Commerce HTML Structure
            app.innerHTML = `
                <div class="breadcrumb-section">
                    ${window.renderSmartBreadcrumbs(slug, '')}
                </div>

                <section class="category-grid-container" style="width:95%; max-width:95%; margin:0 auto; padding-bottom:50px;">
                    <!-- Header -->
                    <div class="category-header-simple">
                        <div>
                            <h1>${category.title}</h1>
                            <p class="category-short-desc">${category.short_description || ''}</p>
                        </div>
                        ${category.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}">` : ''}
                    </div>

                    <!-- New Grid Container -->
                    <div class="category-grid">
                        ${catProducts.map(p => renderProductCard(p, category)).join('')}
                    </div>
                </section>
            `;

            // Scroll breadcrumbs
            window.updateBreadcrumbScroll();
        }

        // --- Helper: Render Individual Card ---
        function renderProductCard(product, category) {
            // 1. Parsing Variants & sorting (Smallest First)
            let variants = [];
            try {
                if (typeof product.quantity_variants === 'string') {
                    variants = JSON.parse(product.quantity_variants);
                } else if (Array.isArray(product.quantity_variants)) {
                    variants = product.quantity_variants;
                }
            } catch (e) {
                console.warn('Variant parse error', e);
            }

            // Fallback for non-variant products
            if (variants.length === 0) {
                variants = [{
                    quantity: product.quantity || 'Standard',
                    price: product.price,
                    mrp: product.mrp,
                    stock: product.total_stock
                }];
            }

            // Sort variants by price (proxy for weight/size) ascending
            const sortedVariants = [...variants].sort((a, b) => (Number(a.price) || 0) - (Number(b.price) || 0));

            // Default selected variant (Index 0 after sort)
            const defaultVar = sortedVariants[0];
            const defaultVarIdx = 0;

            // 2. Check Cart State for this specific variant
            const cartList = state.cart || [];
            const cartItem = cartList.find(item => item.id === product.id &&
                (item.variant ? item.variant.quantity === defaultVar.quantity : true)
            );
            const qty = cartItem ? cartItem.qty : 0;

            // 3. Discount Logic
            let discountTag = '';
            if (defaultVar.mrp > defaultVar.price) {
                const off = Math.round(((defaultVar.mrp - defaultVar.price) / defaultVar.mrp) * 100);
                discountTag = `<span class="discount" id="disc-${product.id}">${off}% OFF</span>`;
            }

            // 4. Resolve Category / Sub-brand
            let dispCategory = category;
            if (!dispCategory.sub_brand) {
                // Try to find the actual category for this product
                const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
                const realCat = state.categories.find(c => c.slug === catSlug);
                if (realCat) {
                    dispCategory = realCat;
                }
            }

            // 5. Render
            return `
            <article class="product-card" id="card-${product.id}" data-variants='${JSON.stringify(sortedVariants).replace(/'/g, "&apos;")}' data-current-idx="0">
                
                 <!-- Image Area -->
                <div class="card-image-container">
                    <img src="${product.showcase_image || state.placeholder}" 
                         alt="${product.product_name}" 
                         class="product-image" 
                         loading="lazy"
                         onclick="navigateToProduct('${product.slug || product.id}', 'fade')">
                    
                    <!-- Floating Action -->
                    <div class="card-action-container">
                         <!-- Add Button (Visible if Qty 0) -->
                        <button class="btn-add" id="btn-add-${product.id}" 
                                style="${qty > 0 ? 'display:none' : ''}"
                                onclick="window.gridAddToCart('${product.id}')">
                            ADD
                        </button>
                        
                        <!-- Qty Counter (Visible if Qty > 0) -->
                        <div class="qty-counter" id="qty-counter-${product.id}" 
                             style="${qty > 0 ? 'display:flex' : 'display:none'}">
                            <button class="qty-btn" onclick="window.gridUpdateQty('${product.id}', -1)">-</button>
                            <span class="qty-val" id="qty-val-${product.id}">${qty}</span>
                            <button class="qty-btn" onclick="window.gridUpdateQty('${product.id}', 1)">+</button>
                        </div>
                    </div>
                </div>

                <!-- Info Area -->
                <div class="card-info">
                     <!-- 1. Sub-Brand (Top) -->
                     ${dispCategory.sub_brand ? `<span class="card-sub-brand">${dispCategory.sub_brand}</span>` : ''}

                     <!-- 2. English Title -->
                    <h3 class="product-title" onclick="navigateToProduct('${product.slug || product.id}', 'fade')">
                        ${product.product_name}
                    </h3>

                    <!-- 3. Telugu Title -->
                    <p class="product-subtitle">${product.product_name_telugu || category.telugu_title || ''}</p>

                     <!-- 4. Price Row -->
                    <div class="price-row">
                        <span class="price-pill" id="price-${product.id}">â‚¹${defaultVar.price}</span>
                        ${defaultVar.mrp > defaultVar.price ? `<span class="mrp" id="mrp-${product.id}">â‚¹${defaultVar.mrp}</span>` : ''}
                        ${discountTag}
                    </div>

                     <!-- 5. Variant Selector (Bottom) -->
                    ${sortedVariants.length > 0 ? `
                        <div class="variant-selector" onclick="window.toggleGridVariantDropdown('${product.id}')" tabindex="0">
                            <span class="current-variant" id="var-label-${product.id}">${defaultVar.quantity || 'Standard'}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <!-- Dropdown List -->
                        <div class="variant-dropdown-list" id="var-list-${product.id}" style="display:none; position:absolute; bottom:50px; left:12px; background:white; border:1px solid #eee; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:20; width:150px; overflow:hidden;">
                            ${sortedVariants.map((v, idx) => `
                                <div class="var-option" 
                                     style="padding:10px 14px; font-size:0.85rem; cursor:pointer; color:#333; border-bottom:1px solid #f0f0f0;" 
                                     onclick="window.selectGridVariant('${product.id}', ${idx})">
                                    <div style="font-weight:600;">${v.quantity}</div>
                                    <div style="font-size:0.75rem; color:#666;">â‚¹${v.price}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                </div>
            </article>
            `;
        }

        // --- Grid Interaction Helpers ---
        window.getGridCardData = function (productId) {
            const card = document.getElementById(`card-${productId}`);
            if (!card) return null;
            const variants = JSON.parse(card.getAttribute('data-variants') || '[]');
            const currentIdx = parseInt(card.getAttribute('data-current-idx') || '0');
            return { card, variants, currentIdx };
        };

        window.gridAddToCart = function (productId) {
            const data = window.getGridCardData(productId);
            if (!data) return;
            const product = state.allProducts.find(p => p.id == productId);
            if (!product) return;

            const variant = data.variants[data.currentIdx];

            // Add 1 to cart
            window.addToCart(product, variant, 1);

            // We don't need to manually update UI here because addToCart triggers saveCart -> updateCartUI?
            // Wait, updateCartUI() updates the drawer. We SHOULD also update the grid card state.
            window.refreshGridCardUI(productId);
        };

        window.gridUpdateQty = function (productId, delta) {
            const data = window.getGridCardData(productId);
            if (!data) return;
            const variant = data.variants[data.currentIdx];

            // Find existing cart item to update
            const existingIdx = state.cart.findIndex(item =>
                item.id == productId &&
                (item.variant ? item.variant.quantity === variant.quantity : true)
            );

            if (existingIdx > -1) {
                // Determine logic: directly update cart or use updateCartItemQty
                // Using updateCartItemQty handles removing if 0
                window.updateCartItemQty(existingIdx, delta, false);
            } else if (delta > 0) {
                // Should have been in cart if using this button, but fallback
                window.gridAddToCart(productId);
            }

            window.refreshGridCardUI(productId);
        };

        window.refreshGridCardUI = function (productId) {
            const data = window.getGridCardData(productId);
            if (!data) return;
            const variant = data.variants[data.currentIdx];

            // Check Cart State
            const cartItem = state.cart.find(item => item.id == productId &&
                (item.variant ? item.variant.quantity === variant.quantity : true)
            );
            const qty = cartItem ? cartItem.qty : 0;

            const btnAdd = document.getElementById(`btn-add-${productId}`);
            const qtyCounter = document.getElementById(`qty-counter-${productId}`);
            const qtyVal = document.getElementById(`qty-val-${productId}`);

            if (qty > 0) {
                btnAdd.style.display = 'none';
                qtyCounter.style.display = 'flex';
                qtyVal.innerText = qty;
            } else {
                btnAdd.style.display = 'block';
                qtyCounter.style.display = 'none';
            }
        };

        window.toggleGridVariantDropdown = function (productId) {
            // Close others
            document.querySelectorAll('.variant-dropdown-list').forEach(el => {
                if (el.id !== `var-list-${productId}`) el.style.display = 'none';
            });

            const list = document.getElementById(`var-list-${productId}`);
            if (list) {
                list.style.display = (list.style.display === 'none' || list.style.display === '') ? 'block' : 'none';
            }
        };

        window.selectGridVariant = function (productId, idx) {
            const data = window.getGridCardData(productId);
            if (!data) return;

            // Update State
            data.card.setAttribute('data-current-idx', idx);
            const variant = data.variants[idx];

            // Update UI Labels
            const label = document.getElementById(`var-label-${productId}`);
            if (label) label.innerText = variant.quantity;

            const priceEl = document.getElementById(`price-${productId}`);
            if (priceEl) priceEl.innerText = `â‚¹${variant.price}`;

            const mrpEl = document.getElementById(`mrp-${productId}`);
            if (mrpEl) {
                if (variant.mrp > variant.price) {
                    mrpEl.style.display = 'inline';
                    mrpEl.innerText = `â‚¹${variant.mrp}`;
                } else {
                    mrpEl.style.display = 'none';
                }
            }

            const discEl = document.getElementById(`disc-${productId}`);
            if (discEl) {
                if (variant.mrp > variant.price) {
                    const off = Math.round(((variant.mrp - variant.price) / variant.mrp) * 100);
                    discEl.innerText = `${off}% OFF`;
                    discEl.style.display = 'inline-block';
                } else {
                    discEl.style.display = 'none';
                }
            }

            // Hide Dropdown
            document.getElementById(`var-list-${productId}`).style.display = 'none';

            // Refresh Buttons (ADD vs Qty) for THIS variant
            window.refreshGridCardUI(productId);
        };

        // Close dropdowns on clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.variant-selector')) {
                document.querySelectorAll('.variant-dropdown-list').forEach(el => el.style.display = 'none');
            }
        });

        // --- View: Product ---
        async function renderProductView(slugOrId, direction = 'fade') {
            // Find product by slug first, then by ID (backwards compatibility)
            let product = state.allProducts.find(p => p.slug === slugOrId);
            if (!product) {
                product = state.allProducts.find(p => p.id == slugOrId);
            }
            if (!product) {
                document.getElementById('app').innerHTML = `
                    <div class="error-state">
                        <div class="error-card">
                            <div class="error-icon" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); color: #2563EB;">
                                <i class="fas fa-search"></i>
                            </div>
                            <h2>Product Not Found</h2>
                            <p>We couldn't find the product you're looking for. It may have been removed or the link is incorrect.</p>
                            <div class="error-actions">
                                <a href="/sales" class="action-btn-pill primary">
                                    <i class="fas fa-store"></i> Browse Products
                                </a>
                                <a href="/" class="action-btn-pill outline">
                                    <i class="fas fa-home"></i> Go Home
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Set global current product for cart actions & share context
            state.currentProduct = product;
            state.detailQty = 1;

            // Update Category Context (for navigation/breadcrumbs)
            const catSlug = (product.product_category || '').toLowerCase().trim().replace(/\s+/g, '-');
            state.currentCategory = catSlug; // Ensure category context is valid
            const category = state.categories.find(c => c.slug === catSlug);

            // Navigation
            const siblingProducts = state.allProducts.filter(p => (p.product_category || '').toLowerCase().trim().replace(/\s+/g, '-') === catSlug);
            const idx = siblingProducts.findIndex(p => p.id === product.id);
            const prev = idx > 0 ? siblingProducts[idx - 1] : null;
            const next = idx < siblingProducts.length - 1 ? siblingProducts[idx + 1] : null;

            updateHistory(product);

            const app = document.getElementById('app');

            // Clean up previous transition classes if any
            app.style.position = '';
            app.style.overflow = '';

            const animationClass = direction === 'right' ? 'slide-in-right' : (direction === 'left' ? 'slide-in-left' : 'fade-in');

            app.innerHTML = `
                <div class="grid-layout slide-container ${animationClass}">
                    <!-- Breadcrumbs + Nav Container -->
                    <div class="breadcrumb-section" style="display:flex; justify-content:space-between; align-items:center; grid-area:bread;">
                        ${window.renderSmartBreadcrumbs(catSlug, product.product_name)}
                        
                        <!-- Navigation (Right on Desktop, Hidden on Mobile) -->
                        <div class="nav-group desktop-only-nav">
                            ${prev ? `<a href="/sales/${prev.slug || prev.id}" class="nav-btn-pill prev" data-id="${prev.slug || prev.id}" title="${prev.product_name}" onclick="event.preventDefault(); navigateToProduct('${prev.slug || prev.id}', 'left')"><i class="fas fa-arrow-left"></i> <span>Prev</span></a>` : '<span class="nav-btn-pill disabled"><i class="fas fa-arrow-left"></i> <span>Prev</span></span>'}
                            ${next ? `<a href="/sales/${next.slug || next.id}" class="nav-btn-pill next" data-id="${next.slug || next.id}" title="${next.product_name}" onclick="event.preventDefault(); navigateToProduct('${next.slug || next.id}', 'right')"><span>Next</span> <i class="fas fa-arrow-right"></i></a>` : '<span class="nav-btn-pill disabled"><span>Next</span> <i class="fas fa-arrow-right"></i></span>'}
                        </div>
                    </div>

                    <!-- Main Content -->
                    <article class="main-product-area">
                        <!-- Navigation Row - Above Image -->
                        <div class="nav-row mobile-only-nav" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px;">
                            ${prev ? `<a href="/sales/${prev.slug || prev.id}" class="nav-btn-pill prev" data-id="${prev.slug || prev.id}" title="${prev.product_name}" onclick="event.preventDefault(); navigateToProduct('${prev.slug || prev.id}', 'left')"><i class="fas fa-arrow-left"></i> Prev</a>` : '<span class="nav-btn-pill disabled"><i class="fas fa-arrow-left"></i> Prev</span>'}
                            ${next ? `<a href="/sales/${next.slug || next.id}" class="nav-btn-pill next" data-id="${next.slug || next.id}" title="${next.product_name}" onclick="event.preventDefault(); navigateToProduct('${next.slug || next.id}', 'right')">Next <i class="fas fa-arrow-right"></i></a>` : '<span class="nav-btn-pill disabled">Next <i class="fas fa-arrow-right"></i></span>'}
                        </div>
                        
                        <div class="gallery-wrapper">
                            <div class="product-gallery" id="productFlipper">
                                ${category?.sub_brand_logo_url ? `<img src="${category.sub_brand_logo_url}" class="overlay-logo">` : ''}
                                <div class="gallery-inner">
                                    <!-- Front: Image -->
                                    <div class="gallery-front">
                                        <img src="${product.showcase_image || state.placeholder}" class="main-img" alt="${product.product_name}">
                                        <div class="product-disclaimer-overlay">All images are representative, change in colour expected due to variability in ingredients</div>
                                        
                                        <!-- Mobile Variant Dropdown (Bottom-Left) - Custom Styled -->
                                        <div class="mobile-variant-container" id="mobileVariantContainer" onclick="event.stopPropagation()">
                                            <div class="mobile-variant-trigger" id="mobileVariantTrigger" 
                                                onclick="event.stopPropagation(); window.openMobileVariantDropdown(this)">
                                                <span class="mv-label" id="mobileVariantLabel">100gms (â‚¹100)</span>
                                                <i class="fas fa-caret-down"></i>
                                            </div>
                                        </div>
                                        
                                        <!-- Overlay Action Bar (Add/Qty) - Bottom-Right -->
                                        <div class="card-action-container" onclick="event.stopPropagation()">
                                            <button class="btn-add" id="detailAddBtnOverlay" 
                                                onclick="event.stopPropagation(); window.addToCartFromDetail()">Add</button>
                                            <div class="qty-counter" id="detailQtyCounterOverlay" style="display:none;"
                                                onclick="event.stopPropagation()">
                                                <button onclick="event.stopPropagation(); window.updateDetailQty(-1)">-</button>
                                                <span class="qty-val" id="detailQtyValOverlay" onclick="event.stopPropagation()">1</span>
                                                <button onclick="event.stopPropagation(); window.updateDetailQty(1)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Back: Description -->
                                    <div class="gallery-back">
                                        <h3 style="margin-bottom:15px; color:var(--color-primary-blue);">About Product</h3>
                                        <p>${product.product_description || 'No description available.'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Toggle Button Below Image -->
                            <div style="text-align:center; margin-top:15px;">
                                <button onclick="toggleFlip()" class="action-btn-pill outline">
                                    <i class="fas fa-info-circle"></i> View Description
                                </button>
                            </div>
                        </div>
                        


    <div class="product-details">
        <div class="details-body">
            ${!category?.sub_brand_logo_url && category?.sub_brand ? `<div
                style="text-transform:uppercase; font-size:0.8rem; font-weight:700; color:var(--text-muted);">
                ${category.sub_brand}</div>` : ''}
            <div class="product-header-fields">
                <h1 class="product-title">${product.product_name}</h1>
                <div class="telugu-title">${product.product_name_telugu || ''}</div>
                ${product.product_tagline ? `<div class="product-tagline">${product.product_tagline}</div>` : ''}

                <div class="price-row">
                    <span class="current-price" id="view-price">â‚¹${product.price}</span>
                    <span class="mrp-strike" id="view-mrp"
                        style="${product.mrp > product.price ? '' : 'display:none'}">â‚¹${product.mrp}</span>
                    <span class="discount-badge" id="view-discount"
                        style="${product.mrp > product.price ? '' : 'display:none'}"></span>
                </div>

                <div class="selection-area">
                    ${renderVariants(product)}
                </div>
            </div>

            <div class="info-tabs">
                <div class="info-toggles" id="tabs-buttons">
                    <!-- Buttons injected here -->
                </div>
                <div id="ingredients-content" class="info-content-block"></div>
                <div id="nutrition-content" class="info-content-block"></div>
                <div id="usage-content" class="info-content-block"></div>
                <div id="shelf-life-content" class="info-content-block"></div>
            </div>
        </div>

    </div>
    </article>

    <!-- Sidebar -->
    <aside class="sidebar">
        <section class="sidebar-card">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="similar" onclick="window.switchSidebarTab('similar')">Similar</div>
                <div class="sidebar-tab" data-tab="trending" onclick="window.switchSidebarTab('trending')">Trending</div>
            </div>
            <div id="side-content">
                ${renderVerticalItems(getSimilarProducts(product))}
            </div>
        </section>
    </aside>

    <!-- Recent Section -->
    <section class="recent-section">
        <h3 style="margin-bottom:20px;">Recently Viewed</h3>
        <div class="recent-grid">
            ${renderHistoryItems()}
        </div>
    </section>
    </div>
    `;

            initProductInteractions(product);
            window.initSwipeNavigation();
            window.initImageZoom();

            // Final Sync (After all components are ready)
            if (window.syncDetailPageCart) {
                const vars = typeof product.quantity_variants === 'string' ? JSON.parse(product.quantity_variants) : (product.quantity_variants || []);
                window.syncDetailPageCart(vars[0]);
            }
        }

        // --- Helpers: Components ---
        function renderVariants(p) {
            let variants = [];
            try {
                variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : (p.quantity_variants || []);
            } catch (e) { }

            if (variants.length === 0) return '';

            if (variants.length === 1) {
                return `<div style="color:var(--text-secondary); font-size: 0.95rem;">
                    <strong>Pack Size:</strong> ${variants[0].quantity}
                </div>`;
            }

            // Default to first variant label
            const activeV = variants[0];
            const label = `${activeV.quantity} - â‚¹${activeV.price}`;

            // Store variants in window for dropdown access
            window._currentVariants = variants;

            return `
            <div class="variant-select-wrapper">
                <div class="variant-trigger" id="variantTrigger" onclick="event.stopPropagation(); window.openVariantDropdown(this)">
                    <span id="variantLabel">${label}</span>
                    <i class="fas fa-chevron-down" style="font-size:0.8rem; opacity:0.7;"></i>
                </div>
            </div>
            `;
        }

        function initProductInteractions(p) {
            console.log('Product Data for Tabs:', { name: p.product_name, shelf_life: p.shelf_life, is_refrigerated: p.is_refrigerated });
            const vSelect = document.getElementById('variantSelect');
            let variants = [];
            try {
                variants = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) :
                    (p.quantity_variants || []);
            } catch (e) { }

            // Initialize Mobile Variant Trigger (Custom dropdown)
            const mobileVariantLabel = document.getElementById('mobileVariantLabel');
            const mobileVarContainer = document.getElementById('mobileVariantContainer');

            if (variants.length > 1 && mobileVariantLabel) {
                const defaultV = variants[0];
                mobileVariantLabel.innerText = `${defaultV.quantity} (â‚¹${defaultV.price})`;
                window._mobileActiveVariantIdx = 0;
            } else if (mobileVarContainer) {
                mobileVarContainer.style.display = 'none';
            }

            let activeVariantIdx = 0;

            const updatePrice = (v) => {
                document.getElementById('view-price').innerText = 'â‚¹' + v.price;
                const mrpEl = document.getElementById('view-mrp');
                const discEl = document.getElementById('view-discount');
                if (v.mrp && v.mrp > v.price) {
                    mrpEl.innerText = 'â‚¹' + v.mrp;
                    mrpEl.style.display = 'inline';
                    const off = Math.round(((v.mrp - v.price) / v.mrp) * 100);
                    discEl.innerText = off + '% OFF';
                    discEl.style.display = 'inline-block';
                } else {
                    mrpEl.style.display = 'none';
                    discEl.style.display = 'none';
                }
            };

            window.openVariantDropdown = function (triggerEl) {
                const variants = window._currentVariants;
                if (!variants || !variants.length) return;

                const existing = document.getElementById('variant-portal-dropdown');
                if (existing) {
                    existing.remove();
                    return;
                }

                const menu = document.createElement('div');
                menu.id = 'variant-portal-dropdown';
                menu.className = 'variant-portal-menu';

                menu.innerHTML = variants.map((v, i) => `
                    <div class="variant-portal-item ${i === activeVariantIdx ? 'active' : ''}" 
                         onclick="window.handleVariantClick(${i})">
                        <span>${v.quantity}</span>
                        <span class="var-price">â‚¹${v.price}</span>
                    </div>
                `).join('');

                document.body.appendChild(menu);

                const rect = triggerEl.getBoundingClientRect();
                menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                menu.style.left = (rect.left + window.scrollX) + 'px';
                menu.style.width = rect.width + 'px';

                requestAnimationFrame(() => menu.classList.add('open'));

                const closeHandler = (e) => {
                    if (!menu.contains(e.target) && !triggerEl.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeHandler), 0);
            };

            window.handleVariantClick = function (idx) {
                const variants = window._currentVariants;
                if (!variants || !variants[idx]) return;

                activeVariantIdx = idx;
                const v = variants[idx];
                const labelEl = document.getElementById('variantLabel');
                if (labelEl) labelEl.innerText = `${v.quantity} - â‚¹${v.price}`;

                updatePrice(v);
                window.syncDetailPageCart(v);

                // Sync mobile dropdown
                const mobileSelect = document.getElementById('mobileVariantSelect');
                if (mobileSelect) mobileSelect.value = idx;

                // Update Nutrition if toggle logic exists
                const nutContent = document.getElementById('nutrition-content');
                if (nutContent && nutritionData) {
                    nutContent.innerHTML = renderNutrition(nutritionData, v);
                    if (window.adjustFontSize) window.adjustFontSize(nutContent, true);
                }

                const menu = document.getElementById('variant-portal-dropdown');
                if (menu) menu.remove();
            };

            // Mobile Variant Portal Dropdown
            window.openMobileVariantDropdown = function (triggerEl) {
                const variants = window._currentVariants;
                if (!variants || variants.length <= 1) return;

                // Close existing if any
                const existing = document.getElementById('mv-portal-dropdown');
                if (existing) {
                    existing.remove();
                    return;
                }

                // Create portal menu
                const menu = document.createElement('div');
                menu.id = 'mv-portal-dropdown';
                menu.className = 'mv-portal-menu';

                const activeIdx = window._mobileActiveVariantIdx || 0;

                menu.innerHTML = variants.map((v, i) => `
                    <div class="mv-portal-item ${i === activeIdx ? 'active' : ''}" 
                         onclick="window.handleMobileVariantSelect(${i})">
                        <span>${v.quantity}</span>
                        <span class="mv-price">â‚¹${v.price}</span>
                    </div>
                `).join('');

                document.body.appendChild(menu);

                // Position above the trigger
                const rect = triggerEl.getBoundingClientRect();
                menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                menu.style.left = rect.left + 'px';

                requestAnimationFrame(() => menu.classList.add('open'));

                // Close on click outside
                const closeHandler = (e) => {
                    if (!menu.contains(e.target) && !triggerEl.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeHandler), 0);
            };

            window.handleMobileVariantSelect = function (idx) {
                const variants = window._currentVariants;
                if (!variants || !variants[idx]) return;

                window._mobileActiveVariantIdx = idx;
                const v = variants[idx];

                // Update mobile label
                const label = document.getElementById('mobileVariantLabel');
                if (label) label.innerText = `${v.quantity} (â‚¹${v.price})`;

                // Trigger the main variant click handler
                window.handleVariantClick(idx);

                // Close menu
                const menu = document.getElementById('mv-portal-dropdown');
                if (menu) menu.remove();
            };

            // Define adjustFontSize as window property so it's globally accessible
            window.adjustFontSize = (el, force = false) => {
                if (!el) return;

                if (force) delete el.dataset.calculatedSize;

                // IF already sized, just ensure the size is applied and stop
                if (el.dataset.calculatedSize) {
                    el.style.fontSize = el.dataset.calculatedSize + 'rem';
                    return;
                }

                // TARGET CONTENT HEIGHT
                const isMobile = window.innerWidth < 768;
                const targetContentHeight = isMobile ? 94 : 104; // Reduced from 130 per 1/5th rule

                // Reset to base size before measurement
                let size = 1.25;
                el.style.fontSize = size + 'rem';

                let iterations = 0;
                while (el.scrollHeight > targetContentHeight && size > 0.72 && iterations < 20) {
                    size -= 0.02;
                    el.style.fontSize = size + 'rem';
                    iterations++;
                }

                el.dataset.calculatedSize = size;
            };

            // 1. Define Sync Function
            window.syncDetailPageCart = function (v) {
                const addBtn = document.getElementById('detailAddBtnOverlay');
                const qtyCounter = document.getElementById('detailQtyCounterOverlay');
                const qtyVal = document.getElementById('detailQtyValOverlay');

                if (!addBtn || !qtyCounter || !qtyVal) return;

                if (!v) {
                    const vars = typeof p.quantity_variants === 'string' ? JSON.parse(p.quantity_variants) : (p.quantity_variants || []);
                    v = vars[activeVariantIdx];
                }

                if (!v) return;

                const cartItem = state.cart.find(c => c.id == p.id &&
                    (c.variant ? c.variant.quantity === v.quantity : true)
                );

                if (cartItem) {
                    addBtn.style.display = 'none';
                    qtyCounter.style.display = 'flex';
                    qtyVal.innerText = cartItem.qty;
                    state.detailQty = cartItem.qty;
                } else {
                    addBtn.style.display = 'block';
                    qtyCounter.style.display = 'none';
                    qtyVal.innerText = 1;
                    state.detailQty = 1;
                }
            };

            // Check Variants and Sync
            if (variants[0]) {
                updatePrice(variants[0]);
                window.syncDetailPageCart(variants[0]);
            }


            // 2. Toggles & Content
            const btnContainer = document.getElementById('tabs-buttons');
            const sections = [];

            // Helper to parsing weight: "250g" -> 250, "1kg" -> 1000
            const parseWeight = (str) => {
                if (!str) return 0;
                const match = str.toLowerCase().match(/([\d\.]+)\s*([a-z]+)/);
                if (!match) return 0;
                let val = parseFloat(match[1]);
                let unit = match[2];
                if (unit === 'kg') val *= 1000;
                return val;
            };

            // --- Feature: Image Zoom (Desktop Hover + Mobile Tap Lightbox) ---
            window.initImageZoom = function () {
                const container = document.querySelector('.gallery-front');
                const img = container ? container.querySelector('.main-img') : null;
                if (!container || !img) return;

                const isMobile = window.innerWidth < 1024;

                if (isMobile) {
                    // --- MOBILE: Tap to open fullscreen lightbox ---
                    container.style.cursor = 'zoom-in';
                    container.addEventListener('click', function (e) {
                        e.stopPropagation();
                        window.openImageLightbox(img.src);
                    });
                } else {
                    // --- DESKTOP: Hover to zoom ---
                    container.style.cursor = 'crosshair';
                    container.addEventListener('mousemove', function (e) {
                        // Prevent zoom when mouse is over the action buttons
                        if (e.target.closest('.card-action-container')) {
                            img.style.transform = 'scale(1)';
                            img.style.cursor = 'default';
                            return;
                        }

                        const rect = container.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        let xPercent = Math.max(0, Math.min(100, (x / rect.width) * 100));
                        let yPercent = Math.max(0, Math.min(100, (y / rect.height) * 100));
                        img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
                        img.style.transform = 'scale(2.0)';
                    });
                    container.addEventListener('mouseleave', function () {
                        img.style.transform = 'scale(1)';
                        setTimeout(() => { img.style.transformOrigin = 'center center'; }, 100);
                    });
                }
            };

            // --- Lightbox: Fullscreen Image Viewer ---
            window.openImageLightbox = function (src) {
                // Create overlay if not exists
                let overlay = document.getElementById('imageLightbox');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'imageLightbox';
                    overlay.innerHTML = `
                        <div class="lightbox-backdrop"></div>
                        <div class="lightbox-content">
                            <img src="" alt="Product Image" class="lightbox-img">
                            <button class="lightbox-close" aria-label="Close">&times;</button>
                        </div>
                    `;
                    document.body.appendChild(overlay);

                    // Close handlers
                    overlay.querySelector('.lightbox-backdrop').addEventListener('click', window.closeImageLightbox);
                    overlay.querySelector('.lightbox-close').addEventListener('click', window.closeImageLightbox);

                    // Pinch zoom support using CSS transform
                    let scale = 1;
                    let startDistance = 0;
                    const lightboxImg = overlay.querySelector('.lightbox-img');

                    lightboxImg.addEventListener('touchstart', function (e) {
                        if (e.touches.length === 2) {
                            startDistance = Math.hypot(
                                e.touches[0].pageX - e.touches[1].pageX,
                                e.touches[0].pageY - e.touches[1].pageY
                            );
                        }
                    }, { passive: true });

                    lightboxImg.addEventListener('touchmove', function (e) {
                        if (e.touches.length === 2) {
                            const currentDistance = Math.hypot(
                                e.touches[0].pageX - e.touches[1].pageX,
                                e.touches[0].pageY - e.touches[1].pageY
                            );
                            scale = Math.min(3, Math.max(1, scale * (currentDistance / startDistance)));
                            startDistance = currentDistance;
                            lightboxImg.style.transform = `scale(${scale})`;
                        }
                    }, { passive: true });

                    lightboxImg.addEventListener('touchend', function (e) {
                        if (e.touches.length === 0) {
                            // Reset scale on release
                            scale = 1;
                            lightboxImg.style.transform = 'scale(1)';
                        }
                    });
                }

                // Set image and show
                overlay.querySelector('.lightbox-img').src = src;
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            };

            window.closeImageLightbox = function () {
                const overlay = document.getElementById('imageLightbox');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            };

            console.log(`[Use By Final Check] Product: ${p.product_name}`);
            console.log(`[Use By Final Check] Available Keys:`, Object.keys(p));
            console.log(`[Use By Final Check] shelf_life prop:`, p.shelf_life);

            // Ingredients
            if (p.ingredients) {
                sections.push({
                    id: 'ing', label: 'Ingredients', icon: 'fas fa-carrot', target: 'ingredients-content', html: `
        <p style="text-align:justify;">${p.ingredients}</p>`
                });
            }

            // Use By (Shelf Life)
            if (p.shelf_life && p.shelf_life.toString().trim() !== '') {
                let shelfText = `<p style="text-align:justify; margin:0;">The product is best consumed within <strong>${p.shelf_life}</strong> days from the date of packing.</p>`;

                // Refrigeration Alert Append (Visual Icon/Box)
                if (p.is_refrigerated) {
                    shelfText += `<div style="margin-top:6px; padding:6px 10px; background:#e0f2fe; border-left:4px solid #0284c7; border-radius:4px; color:#0c4a6e; font-size:0.85em; line-height:1.2;">
                        <i class="fas fa-snowflake"></i> <strong>Note:</strong> Refrigeration Required.
                    </div>`;
                }

                sections.push({
                    id: 'shelf', label: 'Shelf Life', icon: 'fas fa-history', target: 'shelf-life-content', html: shelfText
                });
            }

            // Nutrition
            // We need to keep a reference to update it later
            let nutritionData = null;
            if (p.nutrition_info) {
                try { nutritionData = typeof p.nutrition_info === 'string' ? JSON.parse(p.nutrition_info) : p.nutrition_info; }
                catch (e) { }
            }

            const renderNutrition = (nData, currentVariant) => {
                if (!nData) return '';

                // Normalize Keys (Handle legacy/different formats)
                const getVal = (keys) => {
                    if (!Array.isArray(keys)) keys = [keys];
                    for (const k of keys) {
                        if (nData[k] !== undefined && nData[k] !== null && nData[k] !== '') return nData[k];
                    }
                    return null;
                };

                const servingSize = getVal(['serving_size', 'servingSize']);
                const totalServings = getVal(['total_servings', 'totalServings']);

                // Field Mapping for actual nutrition data
                const fields = [
                    { k: ['calories', 'Calories'], label: 'Calories' },
                    { k: ['protein', 'Protein'], label: 'Protein' },
                    { k: ['total_fat', 'fat', 'Total Fat', 'Fat'], label: 'Fat' },
                    { k: ['carbs', 'Carbs'], label: 'Carbs' },
                    { k: ['fiber', 'Fiber'], label: 'Fiber' },
                    { k: ['sugars', 'sugar', 'Sugars'], label: 'Sugar' },
                    { k: ['sodium', 'Sodium'], label: 'Sodium' }
                ];

                // 1. Check if ACTUAL nutrition data exists (not just serving info)
                const hasActualNutritionData = fields.some(f => getVal(f.k) !== null);

                // Build inline text with separators
                const items = [];

                // 2. Only calculate/show servings if actual nutrition data exists
                if (hasActualNutritionData) {
                    if (servingSize) items.push(`<strong>Serving:</strong> ${servingSize}`);

                    // Calculate Servings per pack from variant
                    let displayedServings = null;
                    if (currentVariant && currentVariant.quantity && servingSize) {
                        const packWeight = parseWeight(currentVariant.quantity);
                        const sSize = parseWeight(servingSize);
                        if (packWeight > 0 && sSize > 0) {
                            displayedServings = Math.round(packWeight / sSize);
                        }
                    }
                    // Fallback to totalServings if calculation failed
                    if (!displayedServings && totalServings) {
                        displayedServings = totalServings;
                    }

                    if (displayedServings) items.push(`<strong>~${displayedServings} servings</strong>`);
                }

                // Add nutrition fields
                fields.forEach(f => {
                    const val = getVal(f.k);
                    if (val !== null) {
                        items.push(`<strong>${f.label}:</strong> ${val}`);
                    }
                });

                // 3. If no items to show, return empty
                if (items.length === 0) return '';

                // Return as inline wrapped text with comma separators
                return `<p style="color:var(--text-secondary); margin:0; text-align:justify;">${items.join(', ')}</p>`;
            };


            // Count actual nutrition values (not serving info)
            const nutritionFieldKeys = ['calories', 'Calories', 'protein', 'Protein', 'total_fat', 'fat', 'Fat', 'carbs', 'Carbs', 'fiber', 'Fiber', 'sugars', 'sugar', 'Sugars', 'sodium', 'Sodium'];
            const actualNutritionCount = nutritionData ? nutritionFieldKeys.filter(k =>
                nutritionData[k] !== undefined && nutritionData[k] !== null && nutritionData[k] !== ''
            ).length : 0;

            // Only show Nutrition button if data exists
            if (actualNutritionCount > 0) {
                sections.push({
                    id: 'nut',
                    label: 'Nutrition',
                    icon: 'fas fa-heartbeat',
                    target: 'nutrition-content',
                    // Initial render with first variant (or default)
                    html: renderNutrition(nutritionData, variants[0])
                });
            }

            // Usage
            if (p.serving_suggestion) {
                sections.push({
                    id: 'use', label: 'Usage', icon: 'fas fa-utensils', target: 'usage-content', html: `<p style="text-align:justify;">
            ${p.serving_suggestion}</p>`
                });
            }

            // Render Buttons & Inject Content
            if (btnContainer) {
                btnContainer.className = 'info-btns-row'; // Use standard CSS class
                btnContainer.innerHTML = sections.map(s =>
                    `<button class="info-btn" id="btn-${s.id}" data-target="${s.target}">
                        <i class="${s.icon}" style="margin-right:5px;"></i>
                        <span class="bt-txt">${s.label}</span>
                    </button>`
                ).join('');

                sections.forEach(s => {
                    const el = document.getElementById(s.target);
                    if (el) el.innerHTML = s.html;
                });

                // Add Toggle Logic
                // Local adjustFontSize removed in favor of window.adjustFontSize


                // Pre-adjust ALL tab contents immediately
                sections.forEach(s => {
                    const el = document.getElementById(s.target);
                    if (el) {
                        el.innerHTML = s.html;
                        // Important: el must have its styles (like padding) to measure scrollHeight correctly
                        // We run it after a tiny delay to ensure DOM is ready
                        // setTimeout(() => window.adjustFontSize(el), 50);
                    }
                });

                btnContainer.onclick = (e) => {
                    const btn = e.target.closest('.info-btn');
                    if (!btn) return;

                    const targetId = btn.dataset.target;
                    const contentDiv = document.getElementById(targetId);

                    const wasActive = btn.classList.contains('active');

                    // Close ALL
                    document.querySelectorAll('.info-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.info-content-block').forEach(d => d.classList.remove('active'));

                    if (!wasActive) {
                        btn.classList.add('active');
                        contentDiv.classList.add('active');
                        // Just call adjustFontSize - it will use cached value if available
                        // window.adjustFontSize(contentDiv);
                    }
                };
            }

            // Hook Nutrition Update into Variant Selection
            if (vSelect && nutritionData) {
                const originalChange = vSelect.onchange;
                vSelect.onchange = (e) => {
                    // Call original price updater
                    if (originalChange) originalChange(e);

                    // Update Nutrition HTML
                    const selectedVar = variants[e.target.value];
                    const nutContent = document.getElementById('nutrition-content');
                    if (nutContent) {
                        nutContent.innerHTML = renderNutrition(nutritionData, selectedVar);
                        // FORCE recalculate because content changed
                        // adjustFontSize(nutContent, true);
                    }
                };
            }

            // Initialize sidebar tab switcher
            window.switchSidebarTab = function (mode) {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                const activeTab = document.querySelector(`.sidebar-tab[data-tab="${mode}"]`);
                if (activeTab) activeTab.classList.add('active');

                const sideContent = document.getElementById('side-content');
                if (sideContent) {
                    sideContent.innerHTML = renderVerticalItems(mode === 'similar' ?
                        getSimilarProducts(p) : state.allProducts.filter(x => x.is_trending));
                }
            };

            // Auto-activate default tab (Nutrition if available, else first available)
            setTimeout(() => {
                if (!btnContainer) return;
                const nutBtn = document.getElementById('btn-nut');
                const firstBtn = btnContainer.querySelector('.info-btn');
                const activeBtn = nutBtn || firstBtn;
                if (activeBtn) activeBtn.click();
            }, 100);
        }

        // --- Logic: Data Helpers ---
        function getSimilarProducts(target) {
            return state.allProducts
                .filter(p => p.id !== target.id)
                .map(p => {
                    const isSameCat = p.product_category === target.product_category;
                    return { ...p, score: isSameCat ? 1 : 0 };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
        }

        function renderVerticalItems(items) {
            if (!items || !items.length) return `<p style="text-align:center; padding:20px; color:var(--text-muted)">No items found.</p>`;
            return items.map((item, index) => {
                // Get first variant info or use default price
                let variants = [];
                try {
                    variants = typeof item.quantity_variants === 'string' ? JSON.parse(item.quantity_variants) : (item.quantity_variants || []);
                } catch (e) { }
                const firstVariant = variants[0] || {};
                const variantLabel = firstVariant.quantity || '';
                const displayPrice = firstVariant.price || item.price || item.mrp || '';

                // Check Cart State
                const cartList = state.cart || [];
                const cartItem = cartList.find(c => c.id == item.id &&
                    (c.variant ? c.variant.quantity === firstVariant.quantity : true)
                );
                const qty = cartItem ? cartItem.qty : 0;

                const escapedProduct = JSON.stringify(item).replace(/'/g, "&apos;");
                const escapedVariant = JSON.stringify(firstVariant).replace(/'/g, "&apos;");

                return `
        <div class="sim-item" data-product-id="${item.id}" data-product='${escapedProduct}' data-variant='${escapedVariant}' onclick="window.location.href='/sales/${item.slug || item.id}'" style="cursor:pointer;">
            <img src="${item.showcase_image || state.placeholder}" class="sim-img"
                onerror="this.src='${state.placeholder}'">
            <div class="sim-info">
                <h4 style="font-size:0.9rem; margin:0; line-height:1.2; cursor:pointer;" onclick="window.location.href='/sales/${item.slug || item.id}'">${item.product_name}</h4>
                ${item.product_tagline ? `<span style="font-size:0.7rem; color:var(--text-secondary); display:block; margin:2px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.product_tagline}</span>` : ''}
                <!-- Price + Add Button inline -->
                <div class="price-action-row" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:4px;">
                    <span style="font-size:0.8rem; font-weight:700; color:var(--color-primary-blue);">â‚¹${displayPrice} ${variantLabel ? `<span style="font-size:0.75em; font-weight:500; opacity:0.8;">(${variantLabel})</span>` : ''}</span>
                    <!-- Add Button -->
                    <button class="btn-add sidebar-add-btn" id="sidebar-add-${index}" onclick="event.stopPropagation(); showSidebarQty(${index})" style="${qty > 0 ? 'display:none;' : 'display:block;'}">Add</button>
                    <!-- Quantity Controls -->
                    <div class="qty-counter sidebar-qty-controls ${qty > 0 ? 'show' : ''}" id="sidebar-qty-wrap-${index}" style="${qty > 0 ? 'display:flex;' : 'display:none;'} transform: scale(0.85); transform-origin: right;">
                        <button onclick="event.stopPropagation(); updateSidebarQty(${index}, -1)">âˆ’</button>
                        <span class="qty-val" id="sidebar-qty-${index}">${qty || 1}</span>
                        <button onclick="event.stopPropagation(); updateSidebarQty(${index}, 1)">+</button>
                    </div>
                </div>
            </div>
        </div>
        `;
            }).join('');
        }

        // Show quantity controls and add first item to cart
        window.showSidebarQty = function (index) {
            const addBtn = document.getElementById('sidebar-add-' + index);
            const qtyWrap = document.getElementById('sidebar-qty-wrap-' + index);
            if (addBtn) addBtn.style.display = 'none';
            if (qtyWrap) qtyWrap.classList.add('show');

            // Add 1 to cart immediately
            updateSidebarQty(index, 0, true);
        };

        // Sidebar quantity helper with cart integration
        window.updateSidebarQty = function (index, delta, isInit = false) {
            const qtyEl = document.getElementById('sidebar-qty-' + index);
            const addBtn = document.getElementById('sidebar-add-' + index);
            const qtyWrap = document.getElementById('sidebar-qty-wrap-' + index);
            if (!qtyEl) return;

            let val = parseInt(qtyEl.innerText) || 0;
            val = isInit ? 1 : Math.max(0, val + delta);
            qtyEl.innerText = val;

            // Get product data and update cart
            const simItem = document.querySelector(`#sidebar-qty-${index}`).closest('.sim-item');
            if (simItem) {
                try {
                    // dataset items are already HTML-decoded by the browser
                    const product = JSON.parse(simItem.dataset.product);
                    const variant = JSON.parse(simItem.dataset.variant);

                    // Find or update cart item
                    const existingIdx = state.cart.findIndex(item =>
                        item.id === product.id &&
                        (item.variant ? item.variant.quantity === variant.quantity : true)
                    );

                    if (val === 0) {
                        if (existingIdx > -1) {
                            state.cart.splice(existingIdx, 1);
                        }
                        if (addBtn) addBtn.style.display = 'block';
                        if (qtyWrap) {
                            qtyWrap.style.display = 'none';
                            qtyWrap.classList.remove('show');
                        }
                    } else {
                        if (existingIdx > -1) {
                            state.cart[existingIdx].qty = val;
                        } else {
                            state.cart.push({
                                id: product.id,
                                name: product.product_name,
                                telugu_name: product.product_name_telugu,
                                price: variant.price || product.price || product.mrp,
                                image: product.showcase_image,
                                variant: variant,
                                qty: val
                            });
                        }
                        if (addBtn) addBtn.style.display = 'none';
                        if (qtyWrap) {
                            qtyWrap.style.display = 'flex';
                            qtyWrap.classList.add('show');
                        }
                    }
                    window.saveCart();
                } catch (e) {
                    console.error('Cart update error:', e);
                }
            }
        };

        // Reset sidebar qty for a specific product ID
        function resetSidebarForProduct(productId) {
            document.querySelectorAll('.sim-item').forEach((simItem, index) => {
                if (simItem.dataset.productId == productId) {
                    const addBtn = document.getElementById('sidebar-add-' + index);
                    const qtyWrap = document.getElementById('sidebar-qty-wrap-' + index);
                    const qtyEl = document.getElementById('sidebar-qty-' + index);
                    if (addBtn) addBtn.style.display = 'inline-block';
                    if (qtyWrap) qtyWrap.classList.remove('show');
                    if (qtyEl) qtyEl.innerText = '1';
                }
            });
        }

        // Reset ALL sidebar qty selectors (for clearCart)
        function resetAllSidebarQty() {
            document.querySelectorAll('.sidebar-add-btn').forEach(btn => btn.style.display = 'inline-block');
            document.querySelectorAll('.sidebar-qty-controls').forEach(wrap => wrap.classList.remove('show'));
            document.querySelectorAll('.sidebar-qty-controls .quantity-display').forEach(el => el.innerText = '1');
        }

        function updateHistory(p) {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            hist = hist.filter(x => x.slug !== p.slug && x.id !== p.id);
            hist.unshift({ id: p.id, slug: p.slug, name: p.product_name, img: p.showcase_image });
            localStorage.setItem('td_history', JSON.stringify(hist.slice(0, 8)));
        }

        function renderHistoryItems() {
            let hist = []; try { hist = JSON.parse(localStorage.getItem('td_history') || '[]'); } catch (e) { }
            if (!hist.length) return `<p style="grid-column:1/-1; color:var(--text-muted)">Your viewing history will appear
            here.</p>`;
            return hist.slice(0, 5).map(h => `
        <div class="sim-item" onclick="window.location.href='/sales/${h.slug || h.id}'"
            style="background:var(--bg-primary); border:1px solid var(--border-light); display:flex; align-items:center; gap:10px; padding:5px;">
            <img src="${h.img || state.placeholder}" class="sim-img" style="width:50px; height:50px; object-fit:cover; border-radius:4px; flex-shrink:0;" onerror="this.src='${state.placeholder}'">
            <div class="sim-info" style="min-width:0;">
                <h4 style="font-size:0.85rem; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${h.name}</h4>
                <span style="font-size:0.75rem; color:var(--text-secondary)">View Product</span>
            </div>
        </div>
        `).join('');
        }

        // --- Global Share Function ---
        // NOTE: This functionality is currently NOT used on the Sales Page (no button triggers it).
        // It is kept here for consistency with the Main Page. If needed, add a button calling shareCatalogue().
        window.shareCatalogue = async function () {
            const settings = state.settings || {};
            const catalogueUrl = settings.catalogue_image_url;
            const shareMessage = settings.catalogue_share_message || 'Check out our latest catalogue of delicious treats!';

            if (!catalogueUrl) {
                window.showToast('Catalogue is not available at the moment.', 'error');
                return;
            }

            try {
                // Use pre-loaded file if available
                let file = state.catalogueFile;
                if (!file) {
                    const response = await fetch(catalogueUrl);
                    const blob = await response.blob();
                    file = new File([blob], 'Telugu_Delicacies_Catalogue.jpg', { type: 'image/jpeg' });
                }

                const fileUrl = URL.createObjectURL(file);

                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile && navigator.share) {
                    try {
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'Telugu Delicacies Catalogue',
                                text: shareMessage,
                                files: [file]
                            });
                            return;
                        }
                    } catch (shareErr) {
                        console.error('Mobile file share failed:', shareErr);
                    }
                }

                // Desktop Download + Paste
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = 'Telugu_Delicacies_Catalogue.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Removed Clipboard write attempt to be consistent with script.js (simple Download + Open flow)

                window.showToast('Catalogue downloaded! You can now attach or paste it directly in WhatsApp.', 'success');
                const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(shareMessage)}`;
                window.open(whatsappUrl, '_blank');

            } catch (err) {
                console.error('Sharing failed:', err);
                window.showToast('Could not prepare the catalogue for sharing.', 'error');
            }
        };

        // --- UI Utilities ---
        // --- UI Utilities ---
        window.showToast = function (message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            // Add icon based on type? For now just text
            toast.innerHTML = type === 'success' ? '<i class="fas fa-check-circle" style="color:#4ade80"></i> ' + message : message;

            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Auto dismiss
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000); // 2 seconds
        };

        // --- Cart Functions ---
        window.initCart = function () {
            try {
                const saved = localStorage.getItem('td_cart');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state.cart = Array.isArray(parsed) ? parsed : [];
                }
            } catch (e) {
                console.error('Cart load error', e);
                state.cart = [];
            }
            updateCartUI();
        };

        window.saveCart = function () {
            localStorage.setItem('td_cart', JSON.stringify(state.cart));
            updateCartUI();
        };

        window.toggleCartDrawer = function () {
            const drawer = document.getElementById('cartDrawer');
            const overlay = document.getElementById('cartOverlay');
            if (drawer && overlay) {
                drawer.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        };

        window.updateDetailQty = function (delta) {
            if (!state.currentProduct) return;

            // Get selected variant
            const select = document.getElementById('variantSelect');
            const variants = typeof state.currentProduct.quantity_variants === 'string' ? JSON.parse(state.currentProduct.quantity_variants) : (state.currentProduct.quantity_variants || []);
            const variant = variants[select ? select.value : 0];

            // Update cart relative to delta
            window.addToCart(state.currentProduct, variant, delta);

            // Sync detail page UI (ADD button vs Qty counter)
            window.syncDetailPageCart(variant);
        };


        // Helper for cart animation
        function animateCartBtn() {
            const btn = document.getElementById('cartBtn');
            if (btn) {
                btn.classList.add('cart-pop');
                setTimeout(() => btn.classList.remove('cart-pop'), 400);
            }
        }

        window.addToCart = function (product, variant, qty) {
            // Hardened Validation: Check existing cart qty + new qty against stock
            const existingIdx = state.cart.findIndex(item =>
                item.id === product.id &&
                JSON.stringify(item.variant) === JSON.stringify(variant)
            );

            const currentCartQty = existingIdx > -1 ? state.cart[existingIdx].qty : 0;
            const maxStock = variant ? (variant.stock || 0) : (product.total_stock || 0);

            // Calculation check
            const targetQty = currentCartQty + qty;

            if (targetQty < 0) {
                // If removing more than we have, just set to 0 (which usually removes it or keeps at min)
                // But normally delta is -1, so targetQty would be at least 0.
                window.showToast('Minimum quantity reached', 'error');
                return;
            }

            if (targetQty > maxStock) {
                if (maxStock <= 0) {
                    window.showToast('Out of Stock', 'error');
                } else {
                    window.showToast(`Cannot add more. Max stock is ${maxStock}. (You have ${currentCartQty} in cart)`, 'error');
                }
                return;
            }

            if (existingIdx > -1) {
                state.cart[existingIdx].qty = targetQty;
                // If 0, handle removal
                if (state.cart[existingIdx].qty === 0) {
                    state.cart.splice(existingIdx, 1);
                    window.showToast('Item removed from cart', 'info');
                }
            } else if (qty > 0) {
                state.cart.push({
                    id: product.id,
                    name: product.product_name,
                    telugu_name: product.product_name_telugu,
                    price: variant ? variant.price : product.mrp,
                    image: product.showcase_image,
                    variant: variant,
                    qty: qty
                });
            }

            state.cart = [...state.cart];
            window.saveCart();
            animateCartBtn();
            window.showToast(`${product.product_name} added to cart!`, 'success');
        };

        window.addToCartFromDetail = function () {
            if (!state.currentProduct) return;

            let variants = [];
            try {
                variants = typeof state.currentProduct.quantity_variants === 'string' ?
                    JSON.parse(state.currentProduct.quantity_variants) :
                    (state.currentProduct.quantity_variants || []);
            } catch (e) { }

            let selectedVariant = null;
            if (variants.length > 0) {
                const select = document.getElementById('variantSelect');
                if (select) {
                    selectedVariant = variants[select.value];
                } else {
                    selectedVariant = variants[0];
                }
            }

            const qtyInput = document.getElementById('detailQty');
            const qty = parseInt(qtyInput ? qtyInput.value : 1) || 1;

            window.addToCart(state.currentProduct, selectedVariant, qty);
        };

        window.updateCartItemQty = function (index, deltaOrVal, isDirect = false) {
            const item = state.cart[index];
            if (!item) return;
            let newQty;

            if (isDirect) {
                newQty = parseInt(deltaOrVal);
                if (isNaN(newQty) || newQty < 1) newQty = 1;
            } else {
                newQty = item.qty + deltaOrVal;
            }

            // Check stock
            const maxStock = item.variant ? (item.variant.stock || 0) : 999;

            if (newQty <= 0) {
                // QUICK COMMERCE PATTERN: Immediate removal + Toast (No confirm dialog)
                const removedId = item.id; // Store ID before removal
                state.cart.splice(index, 1);
                window.saveCart();
                window.showToast('Item removed from cart', 'info');
                // Refresh grid card to show ADD button
                window.refreshGridCardUI(removedId);
            } else if (newQty > maxStock) {
                window.showToast(`Max stock reached (${maxStock})`, 'error');
                item.qty = maxStock;
                window.saveCart();
            } else {
                item.qty = newQty;
                window.saveCart();
            }
        };

        window.removeItem = function (index) {
            // Get item before removing to reset sidebar
            const item = state.cart[index];

            // Direct removal - no confirm popup
            state.cart.splice(index, 1);
            window.saveCart();
            window.showToast('Item removed from cart', 'success');

            // Reset sidebar for this product if it exists
            if (item) {
                resetSidebarForProduct(item.id);
                // Refresh grid card to show ADD button
                window.refreshGridCardUI(item.id);
                // Sync detail page if it's the same product
                if (window.syncDetailPageCart) window.syncDetailPageCart();
            }
        };

        window.clearCart = function () {
            if (state.cart.length === 0) return;

            // 1. Clear Data
            state.cart = [];
            window.saveCart();

            // 2. Reset Header Badge
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.innerText = '0';
                cartCount.style.display = 'none';
            }

            // 3. VISUAL RESET (The Fix)
            // Restore "ADD" buttons and hide Qty Counters for ALL cards
            document.querySelectorAll('.qty-counter').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.btn-add').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.qty-val').forEach(el => el.innerText = '0');

            // 4. Reset ALL sidebar quantity selectors
            resetAllSidebarQty();

            // 5. Update Cart Drawer UI
            window.updateCartUI();

            // 6. Sync current detail page
            if (window.syncDetailPageCart) window.syncDetailPageCart();

            window.showToast('Cart cleared', 'info');
        };

        window.updateCartUI = function () {
            const cartCount = document.getElementById('mainCartCount');
            const mobileCartCount = document.getElementById('mobileCartCount');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const clearBtn = document.querySelector('.clear-cart-btn');

            // Update Badge (Desktop + Mobile)
            const totalQty = state.cart.reduce((sum, item) => sum + item.qty, 0);
            [cartCount, mobileCartCount].forEach(badge => {
                if (badge) {
                    badge.innerText = totalQty;
                    badge.style.display = totalQty > 0 ? 'flex' : 'none';
                }
            });

            // Show/Hide Clear Button
            if (clearBtn) {
                // Ensure display logic is correct based on cart state
                clearBtn.style.display = state.cart.length > 0 ? 'block' : 'none';
            }

            // Update Drawer
            if (state.cart.length === 0) {
                if (cartItems) cartItems.innerHTML = '<div class="empty-cart-msg">Your cart is empty</div>';
                if (cartTotal) cartTotal.innerText = '0';
                return;
            }

            let total = 0;
            if (cartItems) {
                cartItems.innerHTML = state.cart.map((item, index) => {
                    const itemTotal = item.price * item.qty;
                    total += itemTotal;
                    const variantLabel = item.variant ? `<div class="cart-item-variant">${item.variant.quantity}</div>` : '';

                    return `
                        <div class="cart-item">
                            <img src="${item.image || state.placeholder}" alt="${item.name}" onerror="this.src='${state.placeholder}'">
                            <div class="cart-item-details">
                                <h4>${item.name}</h4>
                                ${variantLabel}
                                <div class="cart-item-price">â‚¹${item.price} x ${item.qty} = â‚¹${itemTotal}</div>
                                <div class="cart-item-controls">
                                    <button onclick="window.updateCartItemQty(${index}, -1)">âˆ’</button>
                                    <span>${item.qty}</span>
                                    <button onclick="window.updateCartItemQty(${index}, 1)">+</button>
                                </div>
                            </div>
                            <button class="remove-item-btn" onclick="window.removeItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            if (cartTotal) cartTotal.innerText = total;

            // Sync detail page quantity if on product view
            if (window.syncDetailPageCart) window.syncDetailPageCart();
        };

        window.sendToWhatsApp = async function () {
            if (state.cart.length === 0) {
                window.showToast('Your cart is empty!', 'error');
                return;
            }

            // Show loading state
            window.showToast('Validating prices...', 'info');

            // --- 1. Price Validation ---
            try {
                const itemIds = [...new Set(state.cart.map(i => i.id))];
                const { data: dbProducts, error } = await supabase
                    .from('products')
                    .select('id, price, quantity_variants')
                    .in('id', itemIds);

                if (!error && dbProducts) {
                    let pricesChanged = false;
                    state.cart.forEach(cartItem => {
                        const dbProd = dbProducts.find(p => p.id === cartItem.id);
                        if (dbProd) {
                            let currentPrice = dbProd.price; // Default base price

                            // If variant, find variant price
                            if (cartItem.variant) {
                                let vars = [];
                                try {
                                    vars = typeof dbProd.quantity_variants === 'string'
                                        ? JSON.parse(dbProd.quantity_variants)
                                        : (dbProd.quantity_variants || []);
                                } catch (e) { }

                                // Match by quantity label matches
                                const v = vars.find(x => x.quantity === cartItem.variant.quantity);
                                if (v) currentPrice = v.price;
                            }

                            // Update if different
                            if (cartItem.price !== currentPrice) {
                                console.log(`Price update for ${cartItem.name}: ${cartItem.price} -> ${currentPrice}`);
                                cartItem.price = currentPrice;
                                pricesChanged = true;
                            }
                        }
                    });

                    if (pricesChanged) {
                        window.saveCart();
                        window.showToast('Prices updated to latest values.', 'info');
                    }
                }
            } catch (err) {
                console.error('Price validation error:', err);
                // Continue with existing cart prices if check fails
            }

            // --- 2. Background Stock Update (Fire & Forget) ---
            const updateStock = async () => {
                for (const item of state.cart) {
                    try {
                        const { error } = await supabase.rpc('process_order_stock', {
                            p_product_id: item.id,
                            p_variant_label: item.variant ? item.variant.quantity : '',
                            p_qty: item.qty
                        });
                        if (error) throw error;
                    } catch (e) {
                        console.error('Stock update failed for item:', item.id, e);
                    }
                }
            };
            updateStock();

            // --- 3. Construct Message ---
            let message = `ðŸ‘‹ Hi Telugu Delicacies! I would like to place an order.\n\nðŸ›’ *ORDER SUMMARY*`;
            let total = 0;
            state.cart.forEach(item => {
                const sub = item.price * item.qty;
                total += sub;
                // bullet: â–ªï¸, format: item (variant) x qty = price
                message += `\nâ–ªï¸ ${item.name} ${item.variant ? '(' + item.variant.quantity + ')' : ''} x ${item.qty} = â‚¹${sub}`;
            });

            message += `\n\nðŸ’° *Item Total: â‚¹${total}* (Shipping calculated later)`;
            message += `\n\nPlease confirm availability and share payment details! âœ…`;

            const phone = '919618519191';
            // USE UNIVERSAL API LINK
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');

            // Immediate Actions
            window.clearCart(); // Handles reset and toast
            window.showToast('Thanks for the order! Cart cleared.', 'success'); // Override toast msg

            // Close the cart drawer
            window.toggleCartDrawer();
        };

        // Close dropdowns when clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.sb-dropdown-trigger')) {
                document.querySelectorAll('.sb-dropdown-menu').forEach(el => el.classList.remove('show'));
            }
        });

        // --- Smart Breadcrumbs Helper (Native Select) ---
        // --- Smart Breadcrumbs Helper (Custom Portal) ---
        window.renderSmartBreadcrumbs = function (activeCategorySlug, activeProductName) {
            // 1. Home Link (Desktop & Mobile)
            // Mobile: Icon only (via CSS classes)
            // Desktop: Text "Home" (via CSS classes)
            let html = `<div class="smart-breadcrumbs">
                <span class="sb-desktop-root">
                    <a href="/" class="sb-home-link">
                        <i class="fas fa-home sb-mobile-icon"></i>
                        <span class="sb-desktop-text">Home</span>
                    </a>
                    <span class="sep">/</span>
                    <a href="/sales/all-products" class="sb-all-link" onclick="event.preventDefault(); window.navigateToCategory('all-products')">
                        <span class="sb-mobile-text">All</span>
                        <span class="sb-desktop-text">All Products</span>
                    </a>
                    <span class="sep">/</span>
                </span>`;

            // 2. Category Dropdown Trigger
            const categories = state.categories;
            const activeCat = categories.find(c => c.slug === activeCategorySlug);
            const label = activeCat ? activeCat.title : (activeCategorySlug === 'all-products' ? 'Select Category' : 'Select Category');

            // Pass active slug to the opener to highlight it
            html += `
                <div class="sb-select-wrapper" onclick="event.stopPropagation(); window.openCategoryDropdown(this, '${activeCategorySlug}')">
                    <span class="sb-label">${label} <i class="fas fa-caret-down"></i></span>
                </div>
            `;

            // 3. Product Name (if present)
            if (activeProductName) {
                html += `<span class="sep">/</span> <span class="current">${activeProductName}</span>`;
            }

            html += `</div>`;
            return html;
        };

        // --- Portal Dropdown Logic ---
        window.openCategoryDropdown = function (triggerEl, activeSlug) {
            // Close existing if any
            const existing = document.getElementById('sb-portal-dropdown');
            if (existing) existing.remove();

            // Create Menu
            const menu = document.createElement('div');
            menu.id = 'sb-portal-dropdown';
            menu.className = 'sb-portal-menu';

            // Content
            let itemsHtml = `
                <div class="sb-portal-item ${activeSlug === 'all-products' ? 'active' : ''}" 
                     onclick="window.handlePortalClick('all-products')">
                     All Products
                </div>
            `;

            state.categories.forEach(c => {
                itemsHtml += `
                    <div class="sb-portal-item ${c.slug === activeSlug ? 'active' : ''}" 
                         onclick="window.handlePortalClick('${c.slug}')">
                         ${c.title}
                    </div>
                `;
            });
            menu.innerHTML = itemsHtml;

            // Append to Body (Portal)
            document.body.appendChild(menu);

            // Position
            const rect = triggerEl.getBoundingClientRect();
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            menu.style.left = (rect.left + window.scrollX) + 'px';
            menu.style.minWidth = Math.max(rect.width, 200) + 'px';

            // Animation
            requestAnimationFrame(() => menu.classList.add('open'));

            // Click Outside to Close
            const closeHandler = (e) => {
                if (!menu.contains(e.target) && !triggerEl.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => document.addEventListener('click', closeHandler), 0);
        };

        window.handlePortalClick = function (slug) {
            // Navigate
            window.navigateToCategory(slug);
            // Close menu
            const menu = document.getElementById('sb-portal-dropdown');
            if (menu) menu.remove();
        };

        // Scroll Breadcrumbs to ensure active item is visible (Mobile UX)
        window.updateBreadcrumbScroll = function () {
            setTimeout(() => {
                const container = document.querySelector('.smart-breadcrumbs');
                const trigger = document.querySelector('.sb-select-wrapper');
                const current = document.querySelector('.smart-breadcrumbs .current');

                if (container && (trigger || current)) {
                    // Scroll to show the Category Select or Product Name
                    // Prefer Product Name if exists, else Category
                    const target = current || trigger;
                    const offset = target.offsetLeft;

                    // Center it or scroll to ensure visibility? 
                    // Let's scroll so the target is slightly from the left edge (e.g. 50px context)
                    // But if it's the category dropdown, we probably want to see a bit of "Home" / "All" if possible?
                    // No, let's prioritize showing the current context.

                    container.scrollTo({
                        left: offset - 40, // Leave 40px left padding to see separator/context
                        behavior: 'smooth'
                    });
                }
            }, 50); // Small delay for rendering
        };

        window.initCart();

        init().catch(err => {
            console.error("Critical Runtime Error:", err);
            const app = document.getElementById('app');
            if (app) {
                app.innerHTML = `
                    <div class="error-state">
                        <div class="error-card">
                            <h2>Something went wrong</h2>
                            <p>We encountered a technical error while loading the page.</p>
                            <button onclick="location.reload()" class="action-btn-pill primary">Try Again</button>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>